!function(){"use strict";function e(e,t){return function(...n){let i=e.bind(this);if(1!=t(n,i,e,this))return i(...n)}}function t(e,t,n=!1){let i=0,r=Date.now(),o=null,s=()=>{i++;try{return e(i,Date.now()-r),void(null!=o&&clearInterval(o))}catch(e){}};o=setInterval(s,t),n&&s()}function n(e,t){let n=e;return t.every((e=>(e<0&&(e+=n.childNodes.length),n.childNodes[e]?(n=n.childNodes[e],!0):(n=null,!1)))),n}function i(e,t){if(!e)return!1;for(let n=0,i=e.length;n<i;n++)if(null!=e[n]&&t(e[n],n))return!0;return!1}const r=new WeakMap,o=new WeakMap,s=new FinalizationRegistry((e=>{e.destroy()}));class a{info=null;cbRef=null;callback=null;constructor(e,t){this.info=e,this.cbRef=new WeakRef(t),this.callback=t,e.addHook(this)}emit(){let e=this.cbRef.deref();if(e)try{e(this.info.getValue())}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),s.unregister(this)}bindDestroy(e){let t=o.get(e);return null==t&&(t=new Set,o.set(e,t)),t.add(this.callback),this.callback=null,s.register(e,this,this),this}}class l{info=null;targetRef=null;targetKey="";constructor(e,t,n){this.info=e,this.targetRef=new WeakRef(t),this.targetKey=n,e.addHook(this),s.register(t,this,this)}emit(){let e=this.targetRef.deref();if(null!=e)try{e[this.targetKey]=this.info.getValue()}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),s.unregister(this)}}class c{proxyObj=null;srcObj=null;keys=[];hookMap=null;ctFunc=null;constructor(e,t,n,i,r){this.proxyObj=e,this.srcObj=t,this.keys=n,this.hookMap=i,this.ctFunc=r}getValue(){return this.ctFunc?this.ctFunc(...this.keys.map((e=>this.srcObj[e]))):this.srcObj[this.keys[0]]}addHook(e){this.keys.forEach((t=>{let n=this.hookMap.get(t);null==n&&(n=new Set,this.hookMap.set(t,n)),n.add(e)}))}removeHook(e){this.keys.forEach((t=>{let n=this.hookMap.get(t);n&&(n.delete(e),0==n.size&&this.hookMap.delete(t))}))}bindToValue(e,t){return new l(this,e,t)}bindToCallback(e){return new a(this,e)}}class d{callback=null;constructor(e){this.callback=e}apply(e){this.callback(e)}}class u{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){if("function"==typeof this.value){let t=this.value(e.element[this.key]);null!=t&&(e.element[this.key]=t)}else e.element[this.key]=this.value}}class h{eventName=null;callback=null;constructor(e,t){this.eventName=e,this.callback=t}apply(e){e.addEventListener(this.eventName,(t=>{this.callback(t,e)}))}}class m{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){e.setStyle(this.key,this.value)}}function p(e,t){return new m(e,t)}function f(e){return y.flat(Object.keys(e).map((t=>new m(t,e[t]))))}class g{tagName=null;constructor(e){this.tagName=e.toLowerCase()}}class y{list=null;flatFlag=!1;constructor(e){this.list=e}apply(e){const t=e.getTagName();this.list.forEach((n=>{if(null!=n)if("string"==typeof n)e.addText(n);else if("function"==typeof n)n(e);else{if("object"!=typeof n)throw"(NList) Untractable feature types were found";switch(Object.getPrototypeOf(n)?.constructor){case c:e.addChild(n);break;case g:if(t!=n.tagName)throw"(NList) The feature tagName does not match the element";break;case m:case u:case h:case d:n.apply(e);break;case w:e.addChild(n);break;case y:{const t=n;t.flatFlag?t.apply(e):e.addChild(t.getElement());break}case Array:e.addChild(y.getElement(n));break;default:throw"(NList) Untractable feature types were found"}}}))}getTagName(){let e="";return this.list.forEach((t=>{let n="";if(t instanceof g?n=t.tagName:t instanceof y&&t.flatFlag&&(n=t.getTagName()),n)if(e){if(e!=n)throw"(NList) Multiple TagNames exist in a feature list"}else e=n})),e}getElement(){let e=this.getTagName();""==e&&(e="div");let t=x(document.createElement(e));return this.apply(t),t}static flat(e){let t=new y(e);return t.flatFlag=!0,t}static getElement(e){return new y(e).getElement()}}const b=Symbol("NElement");class w{element=null;styleHooks=new Map;constructor(e){this.element=e}addChild(e){if(e instanceof w)this.element.appendChild(e.element);else if(e instanceof Node)this.element.appendChild(e);else if("string"==typeof e)this.addText(e);else{if(!(e instanceof c))throw"(NElement) Type of child node that cannot be added";{let t=null;{let n=e.getValue();t=null==n?new Comment:"string"==typeof n?new Text(n):n instanceof w?n.element:n,this.element.appendChild(t)}e.bindToCallback((e=>{if(t instanceof Text&&"string"==typeof e)t.data=e;else{let n=null==e?new Comment:"string"==typeof e?new Text(e):e instanceof w?e.element:e;this.element.replaceChild(n,t),t=n}})).bindDestroy(this)}}}addChilds(...e){e.forEach((e=>{Array.isArray(e)?e.forEach((e=>this.addChild(e))):"object"==typeof e&&this.addChild(e)}))}insChild(e,t){let n=this.element;"number"==typeof t?t>=0||t<n.childElementCount?n.insertBefore(e.element,n.children[t]):t<0||t>=-n.childElementCount?n.insertBefore(e.element,n.children[n.childElementCount+t]):n.appendChild(e.element):n.insertBefore(e.element,t.element)}childInd(e){let t=-1;return i(this.element.children,((n,i)=>{if(n==e.element)return t=i,!0})),t}remove(){this.element.remove()}removeChilds(e=0,t=1/0){let n=this.element;t>n.childElementCount&&(t=n.childElementCount);for(let i=e;i<t;i++)n.children[e].remove()}getChilds(){return Array.from(this.element.children).map((e=>x(e)))}getChild(e){return x(this.element.children[e])}replaceWith(...e){this.element.replaceWith(...e.map((e=>e.element)))}setStyle(e,t,n){n!=this.styleHooks.get(e)&&(this.styleHooks.get(e)?.destroy(),null!=n?this.styleHooks.set(e,n):this.styleHooks.delete(e)),t instanceof c?t.bindToCallback((t=>{this.setStyle(e,t,n)})).bindDestroy(this).emit():this.element.style[e]=t}getStyle(e){if("string"==typeof e)return this.element.style[e]}setStyles(e){i(Object.keys(e),(t=>{(function(e,...t){return i(t,(t=>t==e))})(typeof e[t],"number","string")&&(this.element.style[t]=e[t])}))}setText(e){this.element.innerText=e}addText(e){return this.element.appendChild(document.createTextNode(e))}setAttrs(e){i(Object.keys(e),(t=>{this.element[t]=e[t]}))}setDisplay(e){this.setStyle("display",e)}addEventListener(e,t,n){this.element.addEventListener(e,t,n)}removeEventListener(e,t,n){this.element.removeEventListener(e,t,n)}animate(e,t){return this.element.animate(e,t)}async animateCommit(e,t){if("forwards"!=(t="number"==typeof t?{duration:t,fill:"forwards"}:Object.assign({fill:"forwards"},t)).fill&&"both"!=t.fill)throw"(NElelemt) animateCommit can only be used when fill forwards or both";let n=this.element.animate(e,t);await n.finished;let i=null;try{n.commitStyles()}catch(e){i=e}if(n.cancel(),null!=i)throw i}asse(e){return e(this),this}getTagName(){return this.element.tagName.toLowerCase()}applyNList(e){return(e instanceof y?e:y.flat(e)).apply(this),this}static byElement(e){return e[b]?e[b]:e instanceof w?e:e[b]=new w(e)}}function x(e){return w.byElement(e)}const v={diFull:e=>"calc(100% - "+e+")",rgb:(e,t,n,i=1)=>"rgba("+e+", "+t+", "+n+", "+i+")"};function k(e){let t=x(document.createElement(e.tagName?e.tagName:"div"));return["height","width","position","top","left","right","bottom","display","overflow"].forEach((n=>{e[n]&&t.setStyle(n,e[n])})),e.style&&t.setStyles(e.style),e.text&&t.setText(e.text),e.attr&&t.setAttrs(e.attr),e.classList&&t.element.classList.add(...e.classList),e.event&&Object.keys(e.event).forEach((n=>{e.event[n]&&t.addEventListener(n,e.event[n])})),e.child&&e.child.forEach((e=>{e&&(e instanceof w?t.addChild(e):t.addChild(k(e)))})),e.assembly&&e.assembly.forEach((e=>{let n=e(t);n&&(t=n)})),t}function I(e,t){let n={},i={};return Object.keys(t).forEach((e=>n[e]=t[e])),Object.keys(e).forEach((r=>{if("child"!=r)if("$"==r[0]){let o=r.slice(1);i[o]=t[o],n[o]=t[o]=e[r]}else if("$"==r.slice(-1)){let n=r.slice(0,-1);i[n]=t[n],t[n]=e[r]}else n[r]=e[r]})),n.left&&n.right&&n.width&&delete n.width,n.top&&n.bottom&&n.height&&delete n.height,e.child&&(n.child=[],e.child.forEach((e=>{e&&(e instanceof w?n.child.push(e):n.child.push(I(e,t)))}))),Object.keys(i).forEach((e=>t[e]=i[e])),n}function S(e){return k(I(e,{}))}class C{x=0;y=0;vx=0;vy=0;sx=0;sy=0;hold=!1;pressing=!1;constructor(e,t,n,i,r,o,s,a){this.x=e,this.y=t,this.vx=n,this.vy=i,this.sx=r,this.sy=o,this.hold=s,this.pressing=a}}function E(e,t,n=0,i=window){e.addEventListener("mousedown",(e=>function(e){e.cancelable&&e.preventDefault();l=s=e.clientX,c=a=e.clientY,i.addEventListener("mousemove",r,!0),i.addEventListener("mouseup",o,!0),e.button==n&&(d=!0,t(new C(s,a,0,0,s,a,!0,!0)))}(e)),!1);let r=e=>function(e){if(d){let n=e.clientX-s,i=e.clientY-a;s=e.clientX,a=e.clientY,t(new C(s,a,n,i,l,c,!0,!1))}}(e),o=e=>function(e){let u=e.clientX-s,h=e.clientY-a;s=e.clientX,a=e.clientY,i.removeEventListener("mousemove",r,!1),i.removeEventListener("mouseup",o,!1),d&&e.button==n&&(d=!1,t(new C(s,a,u,h,l,c,!1,!1)))}(e),s=0,a=0,l=0,c=0,d=!1}function M(e,t,n=!0){e.addEventListener("touchstart",(e=>function(e){e.cancelable&&n&&e.preventDefault();i(e.changedTouches,(e=>{let n={id:e.identifier,sx:e.clientX,sy:e.clientY,x:e.clientX,y:e.clientY};r.set(e.identifier,n),t(new C(n.x,n.y,0,0,n.sx,n.sy,!0,!0))}))}(e)),{capture:!1,passive:!1}),e.addEventListener("touchmove",(e=>function(e){i(e.changedTouches,(e=>{let n=r.get(e.identifier);if(n){let i=e.clientX-n.x,r=e.clientY-n.y;n.x=e.clientX,n.y=e.clientY,t(new C(n.x,n.y,i,r,n.sx,n.sy,!0,!1))}}))}(e)),{capture:!1,passive:!0}),e.addEventListener("touchend",(e=>function(e){i(e.changedTouches,(e=>{let n=r.get(e.identifier);if(n){r.delete(e.identifier);let i=e.clientX-n.x,o=e.clientY-n.y;n.x=e.clientX,n.y=e.clientY,t(new C(n.x,n.y,i,o,n.sx,n.sy,!1,!1))}}))}(e)),{capture:!1,passive:!0}),e.addEventListener("touchcancel",(e=>function(e){i(e.changedTouches,(e=>{let n=r.get(e.identifier);n&&(r.delete(e.identifier),t(new C(n.x,n.y,0,0,n.sx,n.sy,!1,!1)))}))}(e)),{capture:!1,passive:!0});let r=new Map}let P=new Map([["~","`"],["!","1"],["@","2"],["#","3"],["$","4"],["%","5"],["^","6"],["&","7"],["*","8"],["(","9"],[")","0"],["_","-"],["+","="],["{","["],["}","]"],["|","\\"],['"',"'"],[":",";"],["<",","],[">","."],["?","/"]]);const L="A".charCodeAt(0),F="a".charCodeAt(0);for(let e=0;e<26;e++)P.set(String.fromCharCode(L+e),String.fromCharCode(F+e));let B=new Map;class A{key="";hold=!1;pressing=!1;constructor(e,t,n){this.key=e,this.hold=t,this.pressing=n}}function O(e,t){e.addEventListener("keydown",(e=>{let n=P[e.key]?P[e.key]:e.key;t(new A(n,!0,function(e){return!B.get(e)&&(B.set(e,!0),!0)}(n)))})),e.addEventListener("keyup",(e=>{let n=P[e.key]?P[e.key]:e.key;!function(e){B.set(e,!1)}(n),t(new A(n,!1,!1))}))}function R(e,...t){const n=t.length>=2?t.pop():null,i=r.get(e);if(null==i)throw"bindValue: Values can only be bound from proxy objects";return new c(e,i.srcObj,t,i.hookMap,n)}function j(e){return new Promise(((t,n)=>{setTimeout((()=>{t()}),e)}))}new FinalizationRegistry((e=>{e.destroy()}));let T=class{cbList=[];onceCbList=[];#e=null;add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}oncePromise(){return this.#e||(this.#e=new Promise((e=>{this.addOnce((t=>{this.#e=null,e(t)}))}))),this.#e}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((async t=>{t(e)})),this.onceCbList.forEach((async t=>{t(e)})),this.onceCbList=[]}existListener(){return this.cbList.length>0||this.onceCbList.length>0}},N={iframeWindow:null,iframeDocument:null,socket:null,iframeBody:null,socketApi:{send:()=>{}}};const W=Symbol("serialization function"),D=Symbol("deserialization function"),$=new TextEncoder;const U=new Map,H=new Map;[{constructor:Map,typeId:1,encode:(e,t)=>{e.pushVint(t.size),t.forEach(((t,n)=>{e.traversal(n),e.traversal(t)}))},decode:e=>{let t=new Map,n=e.getVInt();e.referenceIndList.push(t);for(let i=0;i<n;i++){let n=e.traversal();t.set(n,e.traversal())}return t}},{constructor:Set,typeId:2,encode:(e,t)=>{t.forEach((t=>{e.traversal(t)})),e.push(0)},decode:e=>{let t=new Set;for(e.referenceIndList.push(t);0!=e.peekByte();)t.add(e.traversal());return e.index++,t}},{constructor:ArrayBuffer,typeId:20,encode:(e,t)=>{e.pushVint(t.byteLength),e.pushArr(new Uint8Array(t))},decode:e=>{let t=e.getVInt(),n=e.buffer.buffer.slice(e.index,e.index+t);return e.referenceIndList.push(n),e.index+=t,n}}].forEach((e=>{U.set(e.constructor,{typeId:e.typeId,encode:e.encode}),H.set(e.typeId,e.decode)})),[{constructor:Int8Array,typeId:10},{constructor:Uint8Array,typeId:11},{constructor:Int16Array,typeId:12},{constructor:Uint16Array,typeId:13},{constructor:Int32Array,typeId:14},{constructor:Uint32Array,typeId:15},{constructor:BigInt64Array,typeId:16},{constructor:BigUint64Array,typeId:17},{constructor:Float32Array,typeId:18},{constructor:Float64Array,typeId:19}].forEach((e=>{U.set(e.constructor,{typeId:e.typeId,encode:(e,t)=>{let n=t.buffer,i=t.byteOffset,r=t.length;e.pushVint(i),e.pushVint(r),e.traversal(n)}}),H.set(e.typeId,(t=>{let n=t.referenceIndList.length;t.referenceIndList.push(null);let i=t.getVInt(),r=t.getVInt(),o=t.traversal(),s=new e.constructor(o,i,r);return t.referenceIndList[n]=s,s}))}));const z=new TextDecoder("utf-8");function V(e=2){var t=Math.floor(Date.now()).toString(36);for(let n=0;n<e;n++)t+="-"+Math.floor(282e10*Math.random()).toString(36);return t}const J=new class{#t=new class{nameToClass=new Map;classToName=new Map;nameToSafetyFunction=new Map;safetyFunctionToName=new Map};addClass(e,t){this.#t.nameToClass.set(e,t),this.#t.classToName.set(t,e)}addSafetyFunction(e,t){this.#t.nameToSafetyFunction.set(e,t),this.#t.safetyFunctionToName.set(t,e)}encode(e,t){return t=Object.assign({referenceString:!1},t),new class e{#t=null;#n=new Uint8Array(128);#i=0;#r=-1;#o=new Map;#s=!1;constructor(e,t){this.#t=e,this.#s=t}push(e){if(this.#i>=this.#n.length){let e=this.#n;this.#n=new Uint8Array(2*this.#n.length),this.#n.set(e)}this.#n[this.#i++]=e}pushArr(e){if(this.#i+e.length>this.#n.length){let t=this.#n,n=2*t.length;for(;this.#i+e.length>n;)n*=2;this.#n=new Uint8Array(n),this.#n.set(t)}this.#n.set(e,this.#i),this.#i+=e.length}pushVint(e){for(;;){let t=127&e;if(!(e>>>=7))return void this.push(128|t);this.push(t)}}pushStr(e){let t=$.encode(e);this.pushVint(t.byteLength),this.pushArr(t)}traversal(t){switch(++this.#r,this.#o.has(t)||this.#o.set(t,this.#r),typeof t){case"number":Number.isInteger(t)&&t>=-2147483648&&t<=2147483647?(this.push(1),this.pushVint(t)):(this.push(2),this.pushArr(new Uint8Array(new Float64Array([t]).buffer)));break;case"string":{let e=0;this.#s&&t.length>=2&&this.#r>(e=this.#o.get(t))?(this.push(14),this.pushVint(e)):(this.push(3),this.pushStr(t));break}case"object":if(null==t)this.push(11);else if(this.#o.get(t)<this.#r)this.push(14),this.pushVint(this.#o.get(t));else if(Array.isArray(t))this.push(5),t.forEach((e=>{this.traversal(e)})),this.push(0);else if(this.#t.classToName.has(Object.getPrototypeOf(t)?.constructor)){this.push(6),this.pushStr(this.#t.classToName.get(Object.getPrototypeOf(t)?.constructor));let e=t[W]?t[W].call(t):t,n=Object.getOwnPropertyNames(e);this.pushVint(n.length),n.forEach((t=>{this.pushStr(t),this.traversal(e[t])}))}else if(U.has(Object.getPrototypeOf(t)?.constructor)){this.push(15);let e=U.get(Object.getPrototypeOf(t)?.constructor);this.pushVint(e.typeId),e.encode(this,t)}else{this.push(4);let e=Object.keys(t);this.pushVint(e.length),e.forEach((e=>{this.pushStr(e),this.traversal(t[e])}))}break;case"undefined":this.push(7);break;case"boolean":this.push(t?9:8);break;case"bigint":{let n=null;t>=0n?(this.push(12),n=0n==t?new Uint8Array(0):e.writeBigint(t)):(this.push(13),n=e.writeBigint(-t)),this.pushVint(n.byteLength),this.pushArr(n);break}case"symbol":this.#o.get(t)<this.#r?(this.push(14),this.pushVint(this.#o.get(t))):(this.push(10),this.pushStr(t.description?t.description:""));break;case"function":this.#t.safetyFunctionToName.has(t)?(this.push(17),this.pushStr(this.#t.safetyFunctionToName.get(t))):this.push(7);break;default:throw"JSObin(encode): The type of value that cannot be processed."}}getFinalBuffer(){return this.#n.slice(0,this.#i)}encode(e){return this.traversal(e),this.getFinalBuffer()}static writeBigint(e){let t=[];for(;;)if(t.push(Number(255n&e)),0n==(e>>=8n))return new Uint8Array(t)}}(this.#t,t.referenceString).encode(e)}decode(e){return new class{#t=null;buffer=null;dataView=null;index=0;referenceIndList=[];constructor(e,t){this.#t=e,this.buffer=t,this.dataView=new DataView(t.buffer)}peekByte(){return this.buffer[this.index]}popByte(){return this.buffer[this.index++]}getVInt(){let e=0,t=0;for(;!(128&this.peekByte());)if(e|=this.popByte()<<t,t+=7,t>32)throw"JSOBin Decode: Unexpected vint length";return e|=(127&this.popByte())<<t,e}getStr(){let e=this.getVInt(),t=z.decode(this.buffer.subarray(this.index,this.index+e));return this.index+=e,t}traversal(){if(this.index>=this.buffer.length)throw"JSOBin Decode: Wrong format";switch(this.popByte()){case 1:{let e=this.getVInt();return this.referenceIndList.push(e),e}case 2:{let e=this.dataView.getFloat64(this.index,!0);return this.referenceIndList.push(e),this.index+=8,e}case 3:{let e=this.getStr();return this.referenceIndList.push(e),e}case 4:{let e={},t=this.getVInt();this.referenceIndList.push(e);for(let n=0;n<t;n++)e[this.getStr()]=this.traversal();return e}case 5:{let e=[];for(this.referenceIndList.push(e);this.peekByte();)e.push(this.traversal());return this.index++,e}case 6:{let e=this.getStr(),t=this.#t.nameToClass.get(e);if(null==t)throw`JSOBin Decode: (class) "${e}" is unregistered class in the current context in the parsing jsobin`;if(t?.[D]){let e={},n=this.getVInt(),i=this.referenceIndList.length;this.referenceIndList.push(e);for(let t=0;t<n;t++)e[this.getStr()]=this.traversal();let r=t[D](e);return this.referenceIndList[i]=r,r}{let e=Object.create(t.prototype),n=this.getVInt();this.referenceIndList.push(e);for(let t=0;t<n;t++)e[this.getStr()]=this.traversal();return e}}case 7:return void this.referenceIndList.push(void 0);case 8:return this.referenceIndList.push(!1),!1;case 9:return this.referenceIndList.push(!0),!0;case 10:{let e=Symbol(this.getStr());return this.referenceIndList.push(e),e}case 11:return this.referenceIndList.push(null),null;case 12:{let e=this.getVInt(),t=this.readBigInt(e);return this.referenceIndList.push(t),t}case 13:{let e=this.getVInt(),t=this.readBigInt(e);return this.referenceIndList.push(t),-t}case 14:{let e=this.getVInt(),t=this.referenceIndList[e];return this.referenceIndList.push(t),t}case 15:{let e=this.getVInt(),t=H.get(e);if(t)return t(this);throw"JSOBin Decode: Unsupported js built-in class type."}case 16:throw"JSOBin Decode: Function is not supported in the current version";case 17:{let e=this.#t.nameToSafetyFunction.get(this.getStr());return this.referenceIndList.push(e),e}default:throw"JSOBin Decode: Wrong format"}}decode(){return this.traversal()}readBigInt(e){let t=0n;for(let n=this.index+e-1;n>=this.index;n--)t<<=8n,t+=BigInt(this.buffer[n]);return this.index+=e,t}}(this.#t,e).decode()}};let Y=new Map;const X=Symbol("unfinishedSliceSymbol");function _(e,t){if(e.startsWith("iiroseForge:")&&e.endsWith(":end")){let n=e.slice(12,-4);try{let e=n.indexOf(","),i=Number.parseInt(n.slice(0,e),36);if(Number.isNaN(i)||i<0||i>8192)return;n=n.slice(e+1);let r=n.slice(0,i);if(r.length!=i)return;let o=n.slice(i).split(",");if("single"==o[1]){if(o.length<2)return;return J.decode(q(r))}if("slice"==o[1]){if(o.length<5)return;let e=Date.now(),n=o[0],i=Number.parseInt(o[2],36),s=Number.parseInt(o[3],36),a=Number.parseInt(o[4],36);if(Number.isNaN(i)||Number.isNaN(s)||Number.isNaN(a)||s>64||i<0||i>=s||a>e+15e3||a<e-6e4||""==n)return X;let l=Y.get(n);return l||(l={slices:Array(s),createTime:e,updateTime:e,packetTime:a,creator:t,hasCount:0,totalCount:s},Y.set(n,l)),l.creator!=t||l.packetTime!=a||l.totalCount!=s||null!=l.slices[i]?X:(l.updateTime=e,l.hasCount++,l.slices[i]=r,l.hasCount<s?X:(Y.delete(n),J.decode(q(l.slices.join("")))))}}catch(e){return void console.log(e)}}}function K(e){const t=8192;try{let n=function(e){let t=Array.from(e).map((e=>String.fromCharCode(e))).join("");return window.btoa(t)}(J.encode(e,{referenceString:!0}));if(n.length<=t){let e=["","single"];return`iiroseForge:${n.length.toString(36)},${n}${e.join(",")}:end`}{let e=Date.now().toString(36),i=V(),r=Math.ceil(n.length/t),o=r.toString(36);return Array(r).fill(0).map(((r,s)=>{let a=n.slice(s*t,(s+1)*t),l=[i,"slice",s.toString(36),o,e];return`iiroseForge:${a.length.toString(36)},${a}${l.join(",")}:end`}))}}catch(e){return}}function q(e){let t=window.atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}setInterval((()=>{let e=Date.now();Y.forEach(((t,n)=>{t.updateTime<e-15e3&&Y.delete(n)}))}),5e3);let Q=x(document.body);function G(e){e.setStyle("transition","transform 50ms linear, text-shadow 150ms linear"),e.addEventListener("mousedown",(()=>{e.setStyle("transform","scale(0.95) translateY(2px)")})),e.addEventListener("mouseup",(()=>{e.setStyle("transform","")})),e.addEventListener("mouseenter",(()=>{e.setStyle("textShadow",`0 0 0.3em ${v.rgb(255,255,255,.5)}`),e.setStyle("transform","translateY(-1px)")})),e.addEventListener("mouseleave",(()=>{e.setStyle("textShadow",""),e.setStyle("transform","")}))}Q.setStyle("cursor","default");var Z=S({position:"absolute",right:"0px",style:{userSelect:"none",pointerEvents:"none",zIndex:"30000"}});function ee(e,t,n="iiroseForge",i=null){let r=S({style:{color:v.rgb(255,255,255),backgroundColor:v.rgb(255,255,255,.1),backdropFilter:"blur(2px) brightness(90%)",marginRight:"1em",marginTop:"1em",marginLeft:"1em",float:"right",clear:"both",overflow:"hidden hidden",padding:"1em",boxSizing:"border-box",minWidth:"180px",borderRadius:"0.2em",boxShadow:`${v.rgb(0,0,0,.55)} 3px 3px 9px`},position:"relative",child:[{tagName:"i",classList:["fa","fa-info-circle"]},{text:e,style:{fontSize:"1.2em",lineHeight:"1.5em",fontWeight:"bolder"}},{text:t,style:{}},{text:n,style:{fontSize:"0.9em",float:"right"}},{text:"×",position:"absolute",right:"4px",top:"1px",assembly:[G],style:{fontSize:"25px",lineHeight:"1em"},event:{click:e=>{e.stopPropagation(),s()}}}]});Z.addChild(r),r.animate([{transform:"translateX(180%) translateY(10%) scale(0.6)"},{}],{duration:180}),setTimeout((()=>{r.setStyle("pointerEvents","auto")}),180);let o=!1;function s(){o||(o=!0,r.setStyle("pointerEvents","none"),r.animate([{},{transform:"translateX(180%)"}],{duration:270,fill:"forwards"}),setTimeout((()=>{r.setStyle("visibility","hidden"),r.animate([{height:r.element.clientHeight+"px"},{marginTop:0,height:0,padding:0}],{duration:150,fill:"forwards"}),setTimeout((()=>{r.remove()}),150)}),270))}setTimeout((()=>{s()}),2500+Math.min(15e3,255*t.length)),i&&(r.asse(G),r.addEventListener("click",(()=>{o||(i(),s())})))}Q.addChild(Z);let te=class{cbList=[];onceCbList=[];add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((async t=>{t(e)})),this.onceCbList.forEach((async t=>{t(e)})),this.onceCbList=[]}};function ne(e){return e=(e=(e=(e=(e=(e=e.replaceAll("&lt;","<")).replaceAll("&gt;",">")).replaceAll("&quot;",'"')).replaceAll("&#039;","'")).replaceAll("&#092;","\\")).replaceAll("&amp;","&")}const ie=new Set(["forge","iiroseForge","forgeFrame","iiroseForgeFrame"]),re={state:{plug:null},operation:{showForgeNotice:(e,t)=>{ee("插件提示",e=String(e),`插件 ${re.state.plug?.name}`,t)},getUserName:()=>N.iframeWindow?.myself2?N.iframeWindow.myself2:null,getUserUid:()=>N.iframeWindow?.uid?N.iframeWindow.uid:null,getUserRoomId:()=>N.iframeWindow?.roomn?N.iframeWindow.roomn:null,getRoomInfoById:e=>{e=String(e);let t=N.iframeWindow?.Objs?.mapHolder?.Assets?.roomJson?.[e];if(t){let e=t[5].split("&&").map((e=>e.split(" & "))),n=ne(e[0][0]),i=n.indexOf(" ");return{name:t[1],color:t[2],roomPath:t[0].split("_"),description:n.slice(i+1),roomImage:n.slice(0,i),currentUserNum:"number"==typeof t[7]?t[7]:"hidden",ownerName:e[1][0],member:e[4].map((e=>({name:ne(e.slice(1)),auth:"0"==e[0]?"member":"1"==e[0]?"admin":"unknow"})))}}return null},getOnlineUserInfoById:e=>{e=String(e);let t=N.iframeWindow?.Objs?.mapHolder?.function?.findUserByUid?.(e);if(t){return ne(t[5].split("&&")[0].split("&")[0]).indexOf(" "),{name:t[2],color:t[3],avatar:t[0],roomId:t[4],personalizedSignature:t[6]}}return null},changeRoom:e=>{(e=String(e))&&N.iframeWindow?.Objs?.mapHolder?.function?.roomchanger(e)},getUserProfilePictureUrl:()=>N.iframeWindow?.avatar2&&N.iframeWindow?.avatarconv?N.iframeWindow.avatarconv(N.iframeWindow.avatar2):null,getUserInputColor:()=>N.iframeWindow?.inputcolorhex?N.iframeWindow.inputcolorhex:null,sendRoomMessage:e=>{(e=String(e))&&N.socketApi.send(JSON.stringify({m:e,mc:re.operation.getUserInputColor(),i:String(Date.now()).slice(-5)+String(Math.random()).slice(-7)}))},sendRoomForgePacket:e=>{if("object"!=typeof e||re.state.plug&&ie.has(e.plug))return;let t=K(e);"string"==typeof t?re.operation.sendRoomMessage(t):(async()=>{for(let e=0;e<t.length;e++)re.operation.sendRoomMessage(t[e]),await j(60)})()},sendPrivateForgePacket:(e,t)=>{if("object"!=typeof t||re.state.plug&&ie.has(t.plug))return;let n=K(t);"string"==typeof n?re.operation.sendPrivateMessageSilence(e,n):(async()=>{for(let t=0;t<n.length;t++)re.operation.sendPrivateMessageSilence(e,n[t]),await j(60)})()},sendSelfPrivateForgePacket:e=>{re.operation.sendPrivateForgePacket(re.operation.getUserUid(),e)},sendPrivateMessageSilence:(e,t)=>{e=String(e),(t=String(t))&&e&&N.socketApi.send(JSON.stringify({g:e,m:t,mc:re.operation.getUserInputColor(),i:String(Date.now()).slice(-5)+String(Math.random()).slice(-7)}))},sendPrivateMessage:(e,t)=>{if(e=String(e),!((t=String(t))&&e&&N.iframeWindow?.msgfetch&&N.iframeWindow?.Variable?.pmObjJson&&N.iframeWindow?.Utils?.service?.buildPmHelper))return;let n=N.iframeDocument.getElementById("moveinput"),i=n.value,r=N.iframeWindow.pmFull;n.value=t,N.iframeWindow.pmFull=!0,N.iframeWindow.Variable.pmObjJson?.[e]||N.iframeWindow.Utils.service.buildPmHelper(1,e,e),N.iframeWindow.msgfetch(0,N.iframeWindow.Variable.pmObjJson?.[e],e,""),N.iframeWindow.pmFull=r,n.value=i},sendSelfPrivateMessageSilence:e=>{re.operation.sendPrivateMessageSilence(re.operation.getUserUid(),e)},giveALike:(e,t="")=>{e=String(e),t=String(t),e&&N.socketApi.send(`+*${e}${t?" "+t:""}`)},switchRoom:e=>{e=String(e),N.iframeWindow?.Objs?.mapHolder?.function?.roomchanger&&N.iframeWindow.Objs.mapHolder.function.roomchanger(e)},runTerminalCommand:e=>{!function(e){N.iframeWindow?.Probe?.init?.shellHolder&&N.iframeWindow?.Init?.movePanel(6);let t=n(N.iframeDocument.getElementById("shellHolder"),[2,0,-1,0]),i=t.value;t.value=e,t.oninput(null),t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13})),t.value=i}(e=String(e))},sendCurrentPageMessage:e=>{!function(e){var t=document.getElementById("moveinput"),n=t.value;t.value=e,t.oninput(null),document.getElementsByClassName("moveinputSendBtn")[0]?.onclick(null),t.value=n}(e=String(e))}},event:{roomMessage:new te,privateMessage:new te,selfPrivateMessage:new te,roomForgePacket:new te,privateForgePacket:new te,selfPrivateForgePacket:new te}};window.iiroseForgeApi=re;let oe={debugMode:!1},se={send:e=>{N.socketApi.send(e)},clientSend:e=>{N.socket.send(e)},receive:e=>{N.socket._onmessage(e)}};function ae(e){e=Boolean(e),oe.debugMode=e,e?(window.fdb=se,N.iframeWindow&&(N.iframeWindow.fdb=se),sessionStorage.setItem("iiroseForgeDebugMode","true")):(window.fdb&&delete window.fdb,N.iframeWindow?.fdb&&delete N.iframeWindow.fdb,sessionStorage.removeItem("iiroseForgeDebugMode"))}let le='!function(){"use strict";!function(){if("iirose.com"!=location.host)return;let e=null;if("/"==location.pathname)e=window;else{if("/messages.html"!=location.pathname)return;e=parent.window}if(e.iiroseForgeInjected)return;let t=!1,o=!1,i=["https://qwq0.github.io/iiroseForge/iiroseForge.js","https://cdn.jsdelivr.net/gh/qwq0/iiroseForge@page/iiroseForge.js"];!function n(a){!async function(n){let a=await fetch(n,{cache:"no-cache"});if(a.ok){let c=await a.text();if(c&&(t||(t=!0,console.log(`[iiroseForgeInjector] load from ${n}`),new e.Function(c)()),!o)){o=!0;let e=await(window?.caches?.open?.("v"));if(e){let t=new Response(new Blob([c],{type:"text/javascript"}),{status:200,statusText:"OK"});e.put(i[0],t),console.log("[iiroseForgeInjector] cache updated")}}}}(i[a]),a<i.length-1&&setTimeout((()=>{t||n(a+1)}),2e3)}(0),(async()=>{if(t)return;let o=await((await(window?.caches?.open?.("v")))?.match(i[0]));if(o&&o.ok){let i=await o.text();i&&!t&&(t=!0,console.log("[iiroseForgeInjector] load from cache"),new e.Function(i)())}})()}()}();';const ce="\x3c!-- iiroseForge Installed Start --\x3e",de="\x3c!-- iiroseForge Installed End --\x3e";function ue(e){const t='<script type="text/javascript" src="https://qwq0.github.io/iiroseForge/l.js"><\/script>';let n=e,i=n.indexOf(t);-1!=i&&(n=n.slice(0,i)+n.slice(i+t.length));let r=n.indexOf(ce),o=n.lastIndexOf(de);return-1!=r&&-1!=o&&(n=n.slice(0,r)+n.slice(o+de.length)),n}async function he(e){let t=await caches.open("v"),n=await caches.match("/");if(n){let i=function(e,t){let n=e;if(-1!=n.indexOf(ce)&&!t)return e;n=ue(n);let i=n.lastIndexOf("</body></html>");return-1==i?(ee("安装forge","无法安装forge (缓存错误)"),e):[n.slice(0,i),ce,"<script>",le,"<\/script>",de,n.slice(i)].join("")}(await n.text(),e);await t.put("/",new Response(new Blob([i],{type:"text/html"}),{status:200,statusText:"OK"}))}else{let e=["<!DOCTYPE html>","<html>","<head>","</head>","<body>","<script>","(async () => {",'let cache = await caches.open("v");','await cache.delete("/");','let mainPageCacheStr = await (await fetch("/", { cache: "no-cache" })).text();','let insertIndex = mainPageCacheStr.lastIndexOf("</body></html>");',"if(insertIndex != -1)","mainPageCacheStr = mainPageCacheStr.slice(0, insertIndex) + ",` "${ce}" + "<scr" + "ipt>" + ${JSON.stringify(le)} + "<\\/sc" + "ript>" + "${de}" `," + mainPageCacheStr.slice(insertIndex);",'await cache.put("/", new Response(new Blob([mainPageCacheStr], { type: "text/html" }), { status: 200, statusText: "OK" }));',"location.reload();","})();","<\/script>","</body>","</html>"].join("");await t.put("/",new Response(new Blob([e],{type:"text/html"}),{status:200,statusText:"OK"}))}}"true"==localStorage.getItem("installForge")&&he(!1);const me={processed:{uidBlacklistSet:new Set,myAccountSet:new Set},roaming:{plugInfo:[],sideLoadedScript:[],userRemark:{},myAccountList:[],beautify:{},customInfoPage:{},uidBlacklist:[],blacklistAutoReply:"根据对方的隐私设置 您暂时无法向对方发送私信"},local:{enableSyncChatRecord:!1,enableUserRemark:!0,enableSuperMenu:!1,enableRoomAdminOperation:!0,lastCloseTime:0,syncChatRecordTo:0,enableExperimental:!1,experimentalOption:{},patch:{}}};function pe(e){try{Object.keys(e).forEach((t=>{me.roaming[t]=e[t]})),Object.keys(me.roaming).forEach((e=>{"object"!=typeof me.roaming[e]||Array.isArray(me.roaming[e])||(me.roaming[e]=function(e){if(r.has(e))throw"Unable to create a proxy for a proxy object";const t=new Map,n=new Proxy(e,{get:(e,t)=>Reflect.get(e,t),set:(e,n,i)=>{let r=Reflect.set(e,n,i);if(r){let e=t.get(n);e&&e.forEach((e=>{e.emit()}))}return r},deleteProperty:(e,n)=>{let i=Reflect.deleteProperty(e,n);if(i){let e=t.get(n);e&&(e.forEach((e=>{e.destroy()})),t.delete(n))}return i}});return r.set(n,{hookMap:t,srcObj:e}),n}(me.roaming[e]))})),me.processed.myAccountSet=new Set(me.roaming.myAccountList),me.processed.uidBlacklistSet=new Set(me.roaming.uidBlacklist)}catch(e){ee("错误","无法设置储存 这可能导致iiroseForge配置丢失")}}function fe(){try{let e=JSON.stringify(function(){try{me.roaming.myAccountList=Array.from(me.processed.myAccountSet),me.roaming.uidBlacklist=Array.from(me.processed.uidBlacklistSet)}catch(e){ee("错误","无法处理储存 这可能导致iiroseForge配置丢失")}return me.roaming}());localStorage.setItem("iiroseForge",e)}catch(e){ee("错误","无法写入储存 这可能导致iiroseForge配置丢失")}}function ge(){try{let e=JSON.stringify(me.local);localStorage.setItem("iiroseForgeLocal",e)}catch(e){ee("错误","无法写入本地储存 这可能导致iiroseForge配置丢失")}}function ye(e,t,n=!1,...i){return new Promise((r=>{var o=void 0,s=S({width:"100%",height:"100%",$position:"absolute",style:{userSelect:"none",backgroundColor:v.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:v.rgb(255,255,255,.95),color:v.rgb(0,0,0),alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"35px",minHeight:"190px",minWidth:"280px",maxWidth:"95%",boxSizing:"border-box",padding:"20px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120)},e=>{o=e}],position$:"static",display:"flex",child:[{text:e},{text:t},...i,{text:"确定",assembly:[G],event:{click:()=>{a(),r(!0)}}},n?{text:"取消",assembly:[G],event:{click:()=>{a(),r(!1)}}}:null]}]});function a(){o.setStyle("pointerEvents","none"),o.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),s.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{s.remove()}),120)}Q.addChild(s)}))}async function be(e,t,n=!1,i=""){var r=S({tagName:"input",assembly:[G],style:{textAlign:"center",margin:"15px"},attr:{value:i}});return r.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),await ye(e,t,n,r)?r.element.value:void 0}function we(e){let t=e.split(" ");return new d((e=>{t.forEach((t=>{e.element.classList.add(t)}))}))}let xe={userMenu:[],roomMenu:[],roomMessageMenu:[]},ve=new Set;function ke(t,n,i,r){!function(){if(!N.iframeWindow||1==N.iframeWindow[Ie])return;N.iframeWindow[Ie]=!0;let t=N.iframeWindow.Objs?.mapHolder?.function?.event;t&&(N.iframeWindow.Objs.mapHolder.function.event=e(t,((e,t,n,i)=>{if(1==e.length&&7==e[0]){let n=i?.dataset?.uid;if(!n)return!1;t(...e);let r=N.iframeDocument.getElementById("selectHolderBox");return xe.userMenu.forEach((e=>{let t=e.creater({uid:n});t&&r.appendChild(Se(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({uid:n})})).element)})),!0}if(2==e.length&&7==e[0]&&Array.isArray(e[1])&&i?.classList?.contains("msgavatar")){let n=i?.dataset?.uid,r=e[1]?.[0],o=i?.parentNode?.parentNode?.dataset?.id?.split("_")?.[1];if(!n)return!1;"string"!=typeof r&&(r=void 0),t(...e);let s=N.iframeDocument.getElementById("selectHolderBox");return xe.roomMessageMenu.forEach((e=>{let t=e.creater({uid:n,messageId:o,userName:r});t&&s.appendChild(Se(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({uid:n,messageId:o,userName:r})})).element)})),!0}if(1==e.length&&8==e[0]){let n=i?.getAttribute?.("rid");if(!n)return!1;t(...e);let r=N.iframeDocument.getElementById("selectHolderBox");return xe.roomMenu.forEach((e=>{let t=e.creater({roomId:n});t&&r.appendChild(Se(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({roomId:n})})).element)})),!0}return!1})));let n=N.iframeWindow.Utils?.service?.pm?.menu;n&&(N.iframeWindow.Utils.service.pm.menu=e(n,((e,t)=>{if(1==e.length){let n=e[0]?.parentNode?.getAttribute?.("ip");if(!n)return!1;t(...e);let i=N.iframeDocument.getElementById("selectHolderBox");return xe.userMenu.forEach((e=>{let t=e.creater({uid:n});t&&i.appendChild(Se(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({uid:n})})).element)})),!0}return!1})))}(),ve.has(t)||(ve.add(t),xe[n].push({creater:i,callback:r}))}let Ie=Symbol();function Se(e,t,n){return y.getElement([we("selectHolderBoxItem selectHolderBoxItemIcon"),[we(e),f({fontFamily:"md",fontSize:"28px",textAlign:"center",lineHeight:"100px",height:"100px",width:"100px",position:"absolute",top:"0",opacity:".7",left:"0"})],t,[we("fullBox whoisTouch3")],new h("click",n)])}function Ce(){let e=N.iframeDocument.getElementsByClassName("msgholderBox")[0];Array.from(e.children).forEach((e=>{Me(e)})),new MutationObserver((e=>{for(let t of e)"childList"==t.type&&Array.from(t.addedNodes).forEach((e=>{null!=e.classList&&e.classList.contains("msg")&&Me(e)}))})).observe(e,{attributes:!1,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0});let t=N.iframeDocument.getElementsByClassName("sessionHolderPmTaskBox")[0];Array.from(t.children).forEach((e=>{Pe(e)})),new MutationObserver((e=>{for(let t of e)"childList"==t.type&&Array.from(t.addedNodes).forEach((e=>{null!=e.classList&&e.classList.contains("sessionHolderPmTaskBoxItem")&&Pe(e)}))})).observe(t,{attributes:!1,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0}),ke("userMark","userMenu",(e=>{let t=me.roaming.userRemark[e.uid];return{icon:"account-cog",text:"设置备注"+(t?`(${t})`:"")}}),(async e=>{let t=me.roaming.userRemark[e.uid],n=await be("设置备注",`给 ${e.uid} 设置备注`,!0,t||"");null!=n&&(me.roaming.userRemark[e.uid]=n,fe())}))}let Ee=new WeakSet;function Me(e){if(1==e.classList.length&&"msg"==e.classList.item(0)){if(Ee.has(e))return;Ee.add(e);let t=e.dataset.id?e.dataset.id.split("_")[0]:n(e,[0,-1,0])?.dataset?.uid,i=n(e,[0,0,-1,-1]);i&&i.appendChild(y.getElement([f({color:"white",position:"absolute",whiteSpace:"pre",["right"!=i.style.float?"left":"right"]:"0px",width:"max-content",bottom:"42px"}),R(me.roaming.userRemark,t,(e=>e||""))]).element)}}function Pe(e){if(2==e.classList.length&&e.classList.contains("sessionHolderPmTaskBoxItem")&&e.classList.contains("whoisTouch2")){if(Ee.has(e))return;Ee.add(e);let t=e.getAttribute("ip"),i=n(e,[1,0,-1]);i&&i.appendChild(y.getElement([f({display:"inline",marginLeft:"3px"}),R(me.roaming.userRemark,t,(e=>e?`(${e})`:""))]).element)}}function Le(e){return new Promise((t=>{var n=null,i=S({width:"100%",height:"100%",$position:"absolute",style:{userSelect:"none",backgroundColor:v.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:v.rgb(255,255,255,.95),color:v.rgb(0,0,0),alignItems:"stretch",justifyContent:"center",flexFlow:"column",lineHeight:"45px",minHeight:"10px",minWidth:"280px",maxHeight:"100%",maxWidth:"95%",overflowY:"auto",scrollbarWidth:"none",boxSizing:"border-box",padding:"10px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120),e.getChilds().forEach((e=>{e.addEventListener("click",r),G(e)}))},e=>{n=e}],position$:"static",overflow:"auto",child:e,event:{click:e=>{e.stopPropagation()}}}],event:{click:r}});function r(){n.setStyle("pointerEvents","none"),n.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),i.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{i.remove()}),120)}Q.addChild(i)}))}async function Fe(){Le([y.getElement(["设置自动回复内容",new h("click",(async()=>{let e=me.roaming.blacklistAutoReply,t=await be("自定义自动回复","输入黑名单用户私聊的自动回复内容\n留空关闭自动回复",!0,e);null!=t&&e!=t&&(me.roaming.blacklistAutoReply=t,fe(),ee("黑名单",""==t?"已关闭黑名单自动回复":"已更新黑名单自动回复内容"))}))]),y.getElement(["[ 添加黑名单 ]",new h("click",(async()=>{let e=await be("添加黑名单","输入目标的唯一标识",!0);if(null!=e){e!=re.operation.getUserUid()?Be(e,!1):ee("黑名单","不能添加此账号本身")}}))]),...Array.from(me.processed.uidBlacklistSet).map((e=>{let t=re.operation.getOnlineUserInfoById(e);return y.getElement([`${e}${t?` (${t.name})`:""}`,new h("click",(async()=>{var n;n=e,t?.name,Le([y.getElement(["移出黑名单",new h("click",(()=>{Be(n,!0)}))])])}))])}))])}async function Be(e,t){let n=t?"移出黑名单":"加入黑名单",i=re.operation.getOnlineUserInfoById(e);await ye(n,`确定将用户 ${e}${i?`(${i.name})`:""}\n${n}吗?`,!0)&&(t?me.processed.uidBlacklistSet.delete(e):me.processed.uidBlacklistSet.add(e),fe(),ee("黑名单",`已将用户 ${e}${i?`(${i.name})`:""} ${n}`))}function Ae(){ke("blacklist","userMenu",(e=>{let t=me.processed.uidBlacklistSet.has(e.uid);return e.uid!=re.operation.getUserUid()||t?{icon:t?"account-lock-open-outline":"account-cancel-outline",text:t?"此人已在黑名单中":"添加到黑名单"}:null}),(async e=>{let t=me.processed.uidBlacklistSet.has(e.uid);Be(e.uid,t)}));let e=N.iframeDocument.getElementsByClassName("msgholderBox")[0];Array.from(e.children).forEach((e=>{try{let t=e;if(1==t.classList.length&&"msg"==t.classList.item(0)){let i=t.dataset.id?t.dataset.id.split("_")[0]:n(t,[0,-1,0])?.dataset?.uid;i&&Oe(i)&&e.remove()}if(2==t.classList.length&&t.classList.contains("pubMsgSystem")){let i=n(t,[0,0])?.dataset?.uid;i||(i=n(t,[0,0,0])?.dataset?.uid),i&&Oe(i)&&e.remove()}}catch(e){console.error(e)}})),Array.from(e.children).forEach(((e,t,n)=>{try{let i=e;1==i.classList.length&&"pubMsgTime"==i.classList.item(0)&&(t==n.length-1||n[t+1]?.classList?.contains("pubMsgTime"))&&e.remove()}catch(e){console.error(e)}}))}function Oe(e,t="",n=""){return re.operation.getUserUid()!=e&&me.processed.uidBlacklistSet.has(e)}class Re{#a=new je;addPath(e,t){this.#a.addPath(e,0,t)}matchPrefix(e){return this.#a.matchPrefix(e,0)}}class je{#l=new Map;#c=null;addPath(e,t,n){if(t>=e.length)this.#c=n;else{let i=this.#l.get(e[t]);null==i&&(i=new je,this.#l.set(e[t],i)),i.addPath(e,t+1,n)}}matchPrefix(e,t){if(t>=e.length)return this.#c?.("",e);{let n=this.#l.get(e[t]);return null!=n?n.matchPrefix(e,t+1):this.#c?.(e.slice(t),e)}}}let Te={forge:{roomForgePacket:new T,privateForgePacket:new T,selfPrivateForgePacket:new T}},Ne=new Re,We=new Re,De=[""];We.addPath('"',(e=>{De[0]='"'+e.split("<").reverse().map((e=>{let t=e.split(">"),n=t[8],i=t[2],r=t[3];if("s"!=t[4]&&"'"!=r[0]){let e=_(r,n);if(null!=e){if(e!=X){if("object"!=typeof e)return;ie.has(e.plug)?Te.forge.roomForgePacket.trigger({senderId:n,senderName:i,content:e}):re.event.roomForgePacket.trigger({senderId:n,senderName:i,content:e})}return}re.event.roomMessage.trigger({senderId:n,senderName:i,content:ne(r)})}if(!Oe(n,r,i))return e})).filter((e=>null!=e)).reverse().join("<")})),We.addPath('""',(e=>{let t=re.operation.getUserUid();De[0]='""'+e.split("<").map((e=>{let n=e.split(">"),i=n[1],r=n[2],o=n[4],s=n[11];if(""==n[6]){if(i!=t){let e=_(o,i);if(null!=e){if(e!=X){if("object"!=typeof e)return;ie.has(e.plug)?Te.forge.privateForgePacket.trigger({senderId:i,senderName:r,content:e}):re.event.privateForgePacket.trigger({senderId:i,senderName:r,content:e})}return}re.event.privateMessage.trigger({senderId:i,senderName:r,content:ne(o)})}else if(i==t&&s==t){let e=_(o,i);if(null!=e){if(e!=X){if("object"!=typeof e)return;ie.has(e.plug)?Te.forge.selfPrivateForgePacket.trigger({content:e}):re.event.selfPrivateForgePacket.trigger({content:e})}return}re.event.selfPrivateMessage.trigger({content:ne(o)})}else if(i==t&&s!=t){if(null!=_(o,i))return}if(Oe(i,o,r))return void(me.roaming.blacklistAutoReply&&re.operation.sendPrivateMessageSilence(i,`[自动回复] ${me.roaming.blacklistAutoReply}`))}if(!Oe(i,o,r))return e})).filter((e=>null!=e)).join("<")})),Ne.addPath("{",((e,t)=>{try{let e=JSON.parse(t),n=JSON.stringify(e);"{"==n[0]&&(De[0]=n)}catch(e){}}));class $e{nameToClass=new Map;classToName=new Map;nameToSafetyFunction=new Map;safetyFunctionToName=new Map}const Ue=Symbol("serialization function"),He=Symbol("deserialization function"),ze=new TextEncoder;class Ve{#t=null;buffer=new Uint8Array(128);endInd=0;referenceIndCount=-1;referenceIndMap=new Map;constructor(e){this.#t=e}push(e){if(this.endInd>=this.buffer.length){let e=this.buffer;this.buffer=new Uint8Array(2*this.buffer.length),this.buffer.set(e)}this.buffer[this.endInd++]=e}pushArr(e){if(this.endInd+e.length>this.buffer.length){let t=this.buffer,n=2*t.length;for(;this.endInd+e.length>n;)n*=2;this.buffer=new Uint8Array(n),this.buffer.set(t)}this.buffer.set(e,this.endInd),this.endInd+=e.length}pushVint(e){for(;;){let t=127&e;if(!(e>>>=7))return void this.push(128|t);this.push(t)}}pushStr(e){let t=ze.encode(e);this.pushVint(t.byteLength),this.pushArr(t)}traversal(e){switch(++this.referenceIndCount,this.referenceIndMap.has(e)||this.referenceIndMap.set(e,this.referenceIndCount),typeof e){case"number":Number.isInteger(e)&&e>=-2147483648&&e<=2147483647?(this.push(1),this.pushVint(e)):(this.push(2),this.pushArr(new Uint8Array(new Float64Array([e]).buffer)));break;case"string":this.push(3),this.pushStr(e);break;case"object":if(null==e)this.push(11);else if(this.referenceIndMap.get(e)<this.referenceIndCount)this.push(14),this.pushVint(this.referenceIndMap.get(e));else if(Array.isArray(e))this.push(5),e.forEach((e=>{this.traversal(e)})),this.push(0);else if(this.#t.classToName.has(Object.getPrototypeOf(e)?.constructor)){this.push(6),this.pushStr(this.#t.classToName.get(Object.getPrototypeOf(e)?.constructor));let t=e[Ue]?e[Ue].call(e):e,n=Object.getOwnPropertyNames(t);this.pushVint(n.length),n.forEach((e=>{this.pushStr(e),this.traversal(t[e])}))}else if(Je.has(Object.getPrototypeOf(e)?.constructor)){this.push(15);let t=Je.get(Object.getPrototypeOf(e)?.constructor);this.pushVint(t.typeId),t.encode(this,e)}else{this.push(4);let t=Object.keys(e);this.pushVint(t.length),t.forEach((t=>{this.pushStr(t),this.traversal(e[t])}))}break;case"undefined":this.push(7);break;case"boolean":this.push(e?9:8);break;case"bigint":{let t=null;e>=0n?(this.push(12),t=0n==e?new Uint8Array(0):Ve.writeBigint(e)):(this.push(13),t=Ve.writeBigint(-e)),this.pushVint(t.byteLength),this.pushArr(t);break}case"symbol":this.referenceIndMap.get(e)<this.referenceIndCount?(this.push(14),this.pushVint(this.referenceIndMap.get(e))):(this.push(10),this.pushStr(e.description?e.description:""));break;case"function":this.#t.safetyFunctionToName.has(e)?(this.push(17),this.pushStr(this.#t.safetyFunctionToName.get(e))):this.push(7);break;default:throw"JSObin(encode): The type of value that cannot be processed."}}getFinalBuffer(){return this.buffer.slice(0,this.endInd)}encode(e){return this.traversal(e),this.getFinalBuffer()}static writeBigint(e){let t=[];for(;;)if(t.push(Number(255n&e)),0n==(e>>=8n))return new Uint8Array(t)}}const Je=new Map,Ye=new Map;[{constructor:Map,typeId:1,encode:(e,t)=>{e.pushVint(t.size),t.forEach(((t,n)=>{e.traversal(n),e.traversal(t)}))},decode:e=>{let t=new Map,n=e.getVInt();e.referenceIndList.push(t);for(let i=0;i<n;i++){let n=e.traversal();t.set(n,e.traversal())}return t}},{constructor:Set,typeId:2,encode:(e,t)=>{t.forEach((t=>{e.traversal(t)})),e.push(0)},decode:e=>{let t=new Set;for(e.referenceIndList.push(t);0!=e.peekByte();)t.add(e.traversal());return e.index++,t}},{constructor:ArrayBuffer,typeId:20,encode:(e,t)=>{e.pushVint(t.byteLength),e.pushArr(new Uint8Array(t))},decode:e=>{let t=e.getVInt(),n=e.buffer.buffer.slice(e.index,e.index+t);return e.referenceIndList.push(n),e.index+=t,n}}].forEach((e=>{Je.set(e.constructor,{typeId:e.typeId,encode:e.encode}),Ye.set(e.typeId,e.decode)})),[{constructor:Int8Array,typeId:10},{constructor:Uint8Array,typeId:11},{constructor:Int16Array,typeId:12},{constructor:Uint16Array,typeId:13},{constructor:Int32Array,typeId:14},{constructor:Uint32Array,typeId:15},{constructor:BigInt64Array,typeId:16},{constructor:BigUint64Array,typeId:17},{constructor:Float32Array,typeId:18},{constructor:Float64Array,typeId:19}].forEach((e=>{Je.set(e.constructor,{typeId:e.typeId,encode:(e,t)=>{let n=t.buffer,i=t.byteOffset,r=t.length;e.pushVint(i),e.pushVint(r),e.traversal(n)}}),Ye.set(e.typeId,(t=>{let n=t.referenceIndList.length;t.referenceIndList.push(null);let i=t.getVInt(),r=t.getVInt(),o=t.traversal(),s=new e.constructor(o,i,r);return t.referenceIndList[n]=s,s}))}));const Xe=new TextDecoder("utf-8");class _e{#t=null;buffer=null;dataView=null;index=0;referenceIndList=[];constructor(e,t){this.#t=e,this.buffer=t,this.dataView=new DataView(t.buffer)}peekByte(){return this.buffer[this.index]}popByte(){return this.buffer[this.index++]}getVInt(){let e=0,t=0;for(;!(128&this.peekByte());)if(e|=this.popByte()<<t,t+=7,t>32)throw"JSOBin Decode: Unexpected vint length";return e|=(127&this.popByte())<<t,e}getStr(){let e=this.getVInt(),t=Xe.decode(this.buffer.subarray(this.index,this.index+e));return this.index+=e,t}traversal(){if(this.index>=this.buffer.length)throw"JSOBin Decode: Wrong format";switch(this.popByte()){case 1:{let e=this.getVInt();return this.referenceIndList.push(e),e}case 2:{let e=this.dataView.getFloat64(this.index,!0);return this.referenceIndList.push(e),this.index+=8,e}case 3:{let e=this.getStr();return this.referenceIndList.push(e),e}case 4:{let e={},t=this.getVInt();this.referenceIndList.push(e);for(let n=0;n<t;n++){e[this.getStr()]=this.traversal()}return e}case 5:{let e=[];for(this.referenceIndList.push(e);this.peekByte();)e.push(this.traversal());return this.index++,e}case 6:{let e=this.getStr(),t=this.#t.nameToClass.get(e);if(null==t)throw`JSOBin Decode: (class) "${e}" is unregistered class in the current context in the parsing jsobin`;if(t?.[He]){let e={},n=this.getVInt(),i=this.referenceIndList.length;this.referenceIndList.push(e);for(let t=0;t<n;t++){e[this.getStr()]=this.traversal()}let r=t[He](e);return this.referenceIndList[i]=r,r}{let e=Object.create(t.prototype),n=this.getVInt();this.referenceIndList.push(e);for(let t=0;t<n;t++){e[this.getStr()]=this.traversal()}return e}}case 7:return void this.referenceIndList.push(void 0);case 8:return this.referenceIndList.push(!1),!1;case 9:return this.referenceIndList.push(!0),!0;case 10:{let e=Symbol(this.getStr());return this.referenceIndList.push(e),e}case 11:return this.referenceIndList.push(null),null;case 12:{let e=this.getVInt(),t=this.readBigInt(e);return this.referenceIndList.push(t),t}case 13:{let e=this.getVInt(),t=this.readBigInt(e);return this.referenceIndList.push(t),-t}case 14:{let e=this.getVInt(),t=this.referenceIndList[e];return this.referenceIndList.push(t),t}case 15:{let e=this.getVInt(),t=Ye.get(e);if(t)return t(this);throw"JSOBin Decode: Unsupported js built-in class type."}case 16:throw"JSOBin Decode: Function is not supported in the current version";case 17:{let e=this.#t.nameToSafetyFunction.get(this.getStr());return this.referenceIndList.push(e),e}default:throw"JSOBin Decode: Wrong format"}}decode(){return this.traversal()}readBigInt(e){let t=0n;for(let n=this.index+e-1;n>=this.index;n--)t<<=8n,t+=BigInt(this.buffer[n]);return this.index+=e,t}}class Ke{once=!1;releaseTarget="";func=null;constructor(e,t,n){this.func=e,this.once=t,this.releaseTarget=n}}function qe(e=2){var t=Math.floor(Date.now()).toString(36);for(let n=0;n<e;n++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}let Qe=new class{#t=new $e;addClass(e,t){this.#t.nameToClass.set(e,t),this.#t.classToName.set(t,e)}addSafetyFunction(e,t){this.#t.nameToSafetyFunction.set(e,t),this.#t.safetyFunctionToName.set(t,e)}encode(e){return new Ve(this.#t).encode(e)}decode(e){return new _e(this.#t,e).decode()}};class Ge{#d=new Map;#u=new Map;#h=new Map;#m=e=>{throw"RcoCcontext: not bound to an output stream"};#p=1;#f=null;constructor(){this.#f=new FinalizationRegistry((e=>{this.#h.delete(e),this.#g([2,e])}))}#g(e){switch(this.#p){case 0:this.#m(e);break;case 1:this.#m(Qe.encode(e));break;case 2:this.#m(function(e){let t=e.length,n="";for(let i=0;i<t;i++)n+=String.fromCharCode(e[i]);return btoa(n)}(Qe.encode(e)))}}bindOutStream(e,t="jsob"){if(this.#m=e,"raw"==t)this.#p=0;else if("jsob"==t||"jsobin"==t)this.#p=1;else{if("base64"!=t)throw"RcoCcontext(bindOutStream): Unsupported output stream types";this.#p=2}}addGlobalNamedFunctions(e){Object.keys(e).forEach((t=>{this.#d.set(t,e[t])}))}async#y(e){if(Array.isArray(e)){switch(e[0]){case 0:{let t=this.#d.get(e[1]);if(t){let n=e[3]?this.#b(e[2],e[3]).result:e[2];try{let i=await t(...n);if(e[4]){let t=this.#w(i);this.#g([1,e[4],[t.result],t.fnMap.size>0?t.fnMap:void 0])}}catch(t){e[5]&&this.#g([1,e[5],[t]])}}else e[5]&&this.#g([1,e[5],["function does not exist"]]);break}case 1:{let t=e[1],n=this.#u.get(t);if(n){let i=e[3]?this.#b(e[2],e[3]).result:e[2],r=n.func;n.once&&this.#u.delete(t),n.releaseTarget&&this.#u.delete(n.releaseTarget);try{let t=await r(...i);if(e[4]){let n=this.#w(t);this.#g([1,e[4],[n.result],n.fnMap.size>0?n.fnMap:void 0])}}catch(t){e[5]&&this.#g([1,e[5],[t]])}}else e[5]&&this.#g([1,e[5],["function does not exist"]]);break}case 2:e.slice(1).forEach((e=>{this.#u.delete(e)}))}}}onData(e){if("string"==typeof e)this.#y(Qe.decode(function(e){let t=atob(e),n=t.length,i=new Uint8Array(n);for(let e=0;e<n;e++)i[e]=t.charCodeAt(e);return i}(e)));else if(e instanceof Uint8Array)this.#y(Qe.decode(e));else{if("object"!=typeof e)throw"RcoCcontext(onData): Unable to process this data type";this.#y(e)}}callNamedFunction(e,...t){return new Promise(((n,i)=>{let r=this.#w(t),o=qe(),s=qe();this.#u.set(o,new Ke(n,!0,s)),this.#u.set(s,new Ke(i,!0,o)),this.#g([0,e,r.result,r.fnMap.size>0?r.fnMap:void 0,o,s])}))}getGlobalNamedFunctionProxy(){return new Proxy({},{set:()=>!1,get:(e,t)=>(...e)=>this.callNamedFunction(t,...e)})}#b(e,t){let n=new Map;t.forEach(((e,t)=>{if(!n.has(e)){let t=(...t)=>new Promise(((n,i)=>{let r=this.#w(t),o=qe(),s=qe();this.#u.set(o,new Ke(n,!0,s)),this.#u.set(s,new Ke(i,!0,o)),this.#g([1,e,r.result,r.fnMap.size>0?r.fnMap:void 0,o,s])}));n.set(e,t),this.#h.set(e,new WeakRef(t)),this.#f.register(t,e)}}));const i=e=>{if("object"==typeof e){if(t.has(e))return n.get(t.get(e));if(Array.isArray(e))return e.map(i);{let t={};return Object.keys(e).forEach((n=>{t[n]=i(e[n])})),t}}return e};return{result:i(e)}}#w(e){let t=new Map;const n=e=>{if("function"==typeof e){let n={},i=qe();return this.#u.set(i,new Ke(e,!1,"")),t.set(n,i),n}if("object"==typeof e){if(Array.isArray(e))return e.map(n);{let t={};return Object.keys(e).forEach((i=>{t[i]=n(e[i])})),t}}return e};return{result:n(e),fnMap:t}}}async function Ze(){let e="";if(await j(1100),[{key:"sidebarTopPicture",cb:e=>{let t=n(N.iframeDocument?.getElementById("functionHolderImg"),[0,0]);t&&(t.src=e)}},{key:"sidebarListPicture",cb:t=>{let n=N.iframeDocument?.getElementById("functionHolder");n&&(n.style.backgroundImage=`url("${t}")`,n.style.backgroundSize="cover",n.style.backgroundPosition=`top ${n.children[0].children[0].style.height} left 0px`,Array.from(n.children[0].children).forEach((e=>{e.classList.contains("functionItemBox")?e.style.backgroundColor="rgba(127, 127, 127, 0.1)":e.style.backgroundColor="transparent"})),e+=[".functionButtonGroup:hover, .functionButton:hover","{","background: rgba(127, 127, 127, 0.3) !important;","}"].join("\n"))}},{key:"selectMenuBackground",cb:e=>{let t=N.iframeDocument?.getElementById("selectHolderBox");t&&(t.style.backgroundImage=`url("${e}")`,t.style.backgroundSize="cover")}},{key:"selectMenuBorderRadius",cb:e=>{let t=N.iframeDocument?.getElementById("selectHolderBox");t&&(t.style.borderRadius=e+"px")}},{key:"messageImgBorderRadius",cb:t=>{e+=[".roomChatContentBox img, .privatemsgMessagesBodyItemBodyBox img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"messageAvatarBorderRadius",cb:t=>{e+=[".msgavatar, .msgavatar img, .privatemsgMessagesBodyItem .privatemsgMessagesBodyItemIcon, .privatemsgMessagesBodyItem .privatemsgMessagesBodyItemIcon img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"systemMessageBorderRadius",cb:t=>{e+=[".pubMsgSystem span","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"systemMessageImgBorderRadius",cb:t=>{e+=[".pubMsgSystem .pubMsgSystemIcon, .pubMsgSystem img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"sessionListItemBorderRadius",cb:t=>{e+=[".sessionHolderPmTaskBoxItem, .sessionHolderPmTaskBoxItem img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"panelItemBorderRadius",cb:t=>{e+=["#panelHolder .shopItem, #panelHolder img, .contentItemContent :is(.commonBox, .commonBox .commonBoxHead, .commonBox .shopItemColor, .cardTag)","{",`border-radius: ${t}px !important;`,"}"].join("\n")}}].forEach((e=>{let t=me.roaming.beautify[e.key];if(t)try{e.cb(t)}catch(e){console.error(e)}})),e){let t=document.createElement("style");t.textContent=e,N.iframeDocument.body.appendChild(t)}}let et='!function(){"use strict";function e(e=2){var t=Math.floor(Date.now()).toString(36);for(let a=0;a<e;a++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}function t(t,a){let r=new Map;let n=function t(n){if("function"==typeof n){let t={},s=e();return a.set(s,n),r.set(t,s),t}if("object"==typeof n){if(Array.isArray(n))return n.map(t);{let e={};return Object.keys(n).forEach((a=>{e[a]=t(n[a])})),e}}return n}(t);return{result:n,fnMap:r}}const a=new FinalizationRegistry((({id:e,port:t})=>{t.postMessage({type:"rF",id:e})}));function r(r,n,s,i,o){let p=new Map;n.forEach(((r,n)=>{if(!p.has(r)){let n=(...a)=>new Promise(((n,p)=>{let l=t(a,i),d=e();i.set(d,n),o.set(d,p),s.postMessage({type:"fn",id:r,param:l.result,fnMap:l.fnMap.size>0?l.fnMap:void 0,cb:d})}));p.set(r,n),a.register(n,{id:r,port:s})}}));const l=e=>{if("object"==typeof e){if(n.has(e))return p.get(n.get(e));if(Array.isArray(e))return e.map(l);{let t={};return Object.keys(e).forEach((a=>{t[a]=l(e[a])})),t}}return e};return{result:l(r)}}(()=>{let e=null,a=new Map,n=new Map;window.addEventListener("message",(s=>{"setMessagePort"==s.data&&null==e&&(e=s.ports[0],Object.defineProperty(window,"iframeSandbox",{configurable:!1,writable:!1,value:{}}),e.addEventListener("message",(async s=>{let i=s.data;switch(i.type){case"execJs":new Function(...i.paramList,i.js)(i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param);break;case"fn":if(a.has(i.id)){let s=i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param;try{let r=await a.get(i.id)(...s);if(i.cb){let n=t(r,a);e.postMessage({type:"sol",id:i.cb,param:[n.result],fnMap:n.fnMap.size>0?n.fnMap:void 0})}}catch(t){i.cb&&e.postMessage({type:"rej",id:i.cb,param:[t]})}}break;case"rF":a.delete(i.id);break;case"sol":{let t=i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param;a.has(i.id)&&a.get(i.id)(...t),a.delete(i.id),n.delete(i.id);break}case"rej":n.has(i.id)&&n.get(i.id)(...i.param),a.delete(i.id),n.delete(i.id)}})),e.start(),e.postMessage({type:"ready"}))})),window.addEventListener("load",(e=>{console.log("sandbox onload")}))})()}();';function tt(e=2){var t=Math.floor(Date.now()).toString(36);for(let n=0;n<e;n++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}function nt(e,t){let n=new Map;let i=function e(i){if("function"==typeof i){let e={},r=tt();return t.set(r,i),n.set(e,r),e}if("object"==typeof i){if(Array.isArray(i))return i.map(e);{let t={};return Object.keys(i).forEach((n=>{t[n]=e(i[n])})),t}}return i}(e);return{result:i,fnMap:n}}const it=new FinalizationRegistry((({id:e,port:t})=>{t.postMessage({type:"rF",id:e})}));function rt(e,t,n,i,r){let o=new Map;t.forEach(((e,t)=>{if(!o.has(e)){let t=(...t)=>new Promise(((o,s)=>{let a=nt(t,i),l=tt();i.set(l,o),r.set(l,s),n.postMessage({type:"fn",id:e,param:a.result,fnMap:a.fnMap.size>0?a.fnMap:void 0,cb:l})}));o.set(e,t),it.register(t,{id:e,port:n})}}));const s=e=>{if("object"==typeof e){if(t.has(e))return o.get(t.get(e));if(Array.isArray(e))return e.map(s);{let t={};return Object.keys(e).forEach((n=>{t[n]=s(e[n])})),t}}return e};return{result:s(e)}}class ot{cbList=[];onceCbList=[];add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((t=>{t(e)})),this.onceCbList.forEach((t=>{t(e)})),this.onceCbList=[]}}class st{#x=null;#v=null;#k=!1;#I=!1;#S=new AbortController;#C=new ot;apiObj={};#E=new Map;#M=new Map;constructor(e=document.body){if(!("sandbox"in HTMLIFrameElement.prototype)||!Object.hasOwn(HTMLIFrameElement.prototype,"contentDocument"))throw"sandbox property are not supported";let t=document.createElement("iframe");t.sandbox.add("allow-scripts"),t.style.display="none",t.srcdoc=["<!DOCTYPE html>","<html>","<head>",'<meta charset="utf-8" />',"<title>iframe sandbox</title>",'<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />',"</head>","<body>","<script>",et,"<\/script>","</body>","</html>"].join("");let n=new MessageChannel,i=n.port1;i.addEventListener("message",(async e=>{let t=e.data;switch(t.type){case"ready":this.#k=!0,this.#C.trigger();break;case"fn":if(this.#E.has(t.id)){let e=t.fnMap?rt(t.param,t.fnMap,i,this.#E,this.#M).result:t.param;try{let n=await this.#E.get(t.id)(...e);if(t.cb){let e=nt(n,this.#E);i.postMessage({type:"sol",id:t.cb,param:[e.result],fnMap:e.fnMap.size>0?e.fnMap:void 0})}}catch(e){t.cb&&i.postMessage({type:"rej",id:t.cb,param:[e]})}}break;case"rF":this.#E.delete(t.id);break;case"sol":{let e=t.fnMap?rt(t.param,t.fnMap,i,this.#E,this.#M).result:t.param;this.#E.has(t.id)&&this.#E.get(t.id)(...e),this.#E.delete(t.id),this.#M.delete(t.id);break}case"rej":this.#M.has(t.id)&&this.#M.get(t.id)(...t.param),this.#E.delete(t.id),this.#M.delete(t.id)}}),{signal:this.#S.signal}),t.addEventListener("load",(()=>{if(!this.#k&&!this.#I){if(t.contentDocument)throw"sandbox isolation failed";i.start(),t.contentWindow.postMessage("setMessagePort","*",[n.port2])}}),{signal:this.#S.signal}),e.appendChild(t),this.#x=t,this.#v=i}async waitAvailable(){return new Promise(((e,t)=>{this.#k?e():this.#C.addOnce(e)}))}async execJs(e){this.#k||await this.waitAvailable();let t=nt(this.apiObj,this.#E);this.#v.postMessage({type:"execJs",js:e,param:t.result,fnMap:t.fnMap.size>0?t.fnMap:void 0,paramList:["api"]})}get iframe(){return this.#x}destroy(){this.#I||(this.#I=!0,this.#x.remove(),this.#x=null,this.#S.abort(),this.#S=null,this.#v.close(),this.#v=null,this.#E=null,this.#M=null,this.#C.removeAll(),this.#C=null,this.#k=!1)}}function at(e=!1){let t=0,n=0,i=280,r=190,o=null,s=null,a=null,l=null,c=y.getElement([f({display:"none",position:"fixed",overflow:"hidden",border:"1px white solid",backgroundColor:"rgba(30, 30, 30, 0.85)",backdropFilter:"blur(2px)",color:"rgba(255, 255, 255)",alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"1.1em",boxSizing:"border-box",padding:"10px",borderRadius:"3px",pointerEvents:"none",resize:"both",boxShadow:"rgba(0, 0, 0, 0.5) 5px 5px 10px",zIndex:"20001",height:"190px",width:"280px"}),["plug-in",f({position:"absolute",left:"0",top:"0",right:"0",cursor:"move",lineHeight:"1.5em",backgroundColor:"rgba(100, 100, 100, 0.2)"}),new d((e=>{var i=0,r=0,o=e=>{e.hold?(e.pressing&&(i=t,r=n),t=i+e.x-e.sx,n=r+e.y-e.sy,t<0?t=0:t>=Q.element.clientWidth-c.element.offsetWidth&&(t=Q.element.clientWidth-c.element.offsetWidth),n<0?n=0:n>=Q.element.clientHeight-c.element.offsetHeight&&(n=Q.element.clientHeight-c.element.offsetHeight),c.setStyle("left",`${t}px`),c.setStyle("top",`${n}px`),l.setStyle("pointerEvents","none")):l.setStyle("pointerEvents","auto")};E(e,o),M(e,o)})),new h("touchend",(()=>{null!=o?(clearTimeout(o),o=null):s.setDisplay("block"),o=setTimeout((()=>{o=null,s.setDisplay("none")}),2500)}))],["-",f({position:"absolute",right:"4px",top:"1px",cursor:"default",fontSize:"1.5em",lineHeight:"1em"}),new h("click",(()=>{c.setDisplay("none")}))],[f({position:"absolute",top:"1.5em",bottom:"0",left:"0",right:"0",overflow:"auto"}),new d((e=>{a=e}))],[f({position:"absolute",right:"0.5px",bottom:"0.5px",height:"1.5em",aspectRatio:"1",cursor:"nwse-resize",display:"none",boxSizing:"border-box",borderRight:"0.75em blue solid",borderBottom:"0.75em blue solid",borderTop:"0.75em transparent solid",borderLeft:"0.75em transparent solid"}),new h("click",(()=>{c.setDisplay("none")})),new d((e=>{s=e})),new d((e=>{var t=0,n=0,o=e=>{e.hold?(e.pressing&&(t=i,n=r),i=t+e.x-e.sx,r=n+e.y-e.sy,c.setStyle("width",`${i}px`),c.setStyle("height",`${r}px`),l.setStyle("pointerEvents","none")):l.setStyle("pointerEvents","auto")};E(e,o),M(e,o)}))]]);Q.addChild(c),new ResizeObserver((()=>{i=c.element.offsetWidth,r=c.element.offsetHeight,t>Q.element.clientWidth-i&&c.setStyle("width",(i=Q.element.clientWidth-t)+"px"),n>Q.element.clientHeight-r&&c.setStyle("height",(r=Q.element.clientHeight-n)+"px"),t<0&&(t=0,c.setStyle("left",`${t}px`)),n<0&&(n=0,c.setStyle("top",`${n}px`))})).observe(c.element);let u=null;return e?(l=x(document.createElement("iframe")),a.addChild(l)):(u=new st(a.element),l=x(u.iframe)),l.setStyles({display:"block",border:"none",height:"100%",width:"100%"}),{windowElement:c,sandbox:u,iframe:l}}let lt=[{sender:"系统",content:`forge已加载 ${(new Date).toLocaleString()}`}],ct=null;function dt(e){e?(e(lt.slice(-100)),ct=e):ct=null}let ut=!1;function ht(){if(ut)return;ut=!0;let e="",t="";re.event.roomMessage.add((n=>{!function(n){let i=[],r=re.operation.getUserRoomId();if(r!=e){let n=re.operation.getRoomInfoById(r)?.name;i.push({sender:"系统",content:`房间切换 ${t}->${n||r}`}),e=r,t=n}if(i.push({sender:n.senderName,content:n.content}),i.length>0){for(lt.push(...i);lt.length>=500;)lt.shift();ct&&ct(i)}}(n)}))}let mt=null,pt=null,ft=null,gt=null,yt=null;async function bt(){if(!mt){mt=at(!0),mt.iframe.element.src="about:blank",await new Promise((e=>{mt.iframe.addEventListener("load",(()=>{e()}))})),pt=mt.iframe.element.contentWindow;let e=x(pt.document.body);e.setStyles({margin:"0",position:"absolute",left:"0",top:"0",width:"100%",height:"100%"}),e.addChild(y.getElement([f({position:"absolute",left:"0",top:"0",width:"100%",height:"100%"}),ft=y.getElement([f({position:"absolute",left:"0",top:"0",width:"100%",bottom:"27px",whiteSpace:"pre-wrap",wordBreak:"break-all",color:"white",overflow:"auto",scrollbarWidth:"thin",scrollbarColor:"rgb(120, 120, 120) rgb(160, 160, 160)"})]),gt=y.getElement([new g("input"),new u("type","text"),new u("placeholder","远程发送"),new u("size","1000"),f({position:"absolute",left:"0",bottom:"0",width:"100%",height:"27px",lineHeight:"27px",backgroundColor:v.rgb(150,150,150,.3),color:v.rgb(255,255,255)}),new h("keydown",((e,t)=>{if("Enter"==e.key&&(e.stopPropagation(),e.preventDefault(),yt)){let e=t.element.value;t.element.value="",yt(e)}}))])]))}mt.windowElement.setDisplay("block"),mt.windowElement.setStyle("pointerEvents","auto")}function wt(e){ft&&ft.addChilds(e.map((e=>y.getElement([f({margin:"2px",border:"1.5px rgba(255, 255, 255, 0.5) solid",padding:"3px"}),`${e.sender}: ${e.content}`]))))}function xt(e){gt&&(gt.element.placeholder=e)}function vt(e){yt=e}let kt="",It="",St="";async function Ct(){function e(e,t){Le([y.getElement(["拉取此账号的配置",new h("click",(()=>{ee("多账户","正在尝试获取配置");let t=V();re.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"syncConfigRQ",id:t}),kt=t}))]),y.getElement(["戴上他的眼睛",new h("click",(()=>{It&&(re.operation.sendPrivateForgePacket(St,{plug:"forge",type:"multiAccount",option:"monitorQuit",id:It}),It="",St=""),ee("多账户",`正在连接 ${e}`),It=V(),St=e,re.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"monitorRQ",id:It}),bt(),ft&&ft.removeChilds(),vt((e=>{e&&re.operation.sendPrivateForgePacket(St,{plug:"forge",type:"multiAccount",option:"monitorSend",id:It,content:e})})),xt("正在连接中")}))]),y.getElement(["前往我所在的房间",new h("click",(()=>{ee("多账户","正在发送命令"),re.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"switchRoom",roomId:re.operation.getUserRoomId()})}))]),y.getElement(["下线",new h("click",(async()=>{await ye("远程下线","确认发送下线指令吗?\n您必须手动重新上线此账号",!0)&&(ee("多账户","正在发送命令"),re.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"quit"}))}))]),y.getElement(["移除账号",new h("click",(()=>{me.processed.myAccountSet.delete(e),me.roaming.myAccountList=me.roaming.myAccountList.filter((t=>t!=e)),fe(),ee("绑定账号",`目标账号(${e})与当前账号(${re.operation.getUserUid()})的单向绑定已解除`)}))])])}Le([y.getElement(["[ 添加账号 ]",new h("click",(async()=>{let e=await be("添加账号","请输入您其他账号的唯一标识\n必须双向绑定才能进行管理",!0);if(null!=e){let t=re.operation.getUserUid();e!=t?(me.processed.myAccountSet.add(e),me.roaming.myAccountList.push(e),fe(),ee("绑定账号",`你需要同时在目标账号(${e})上绑定当前账号(${t})来完成反向绑定`)):ee("无法绑定","不能绑定此账号本身")}}))]),...It?[y.getElement(["正在戴着的眼睛",new h("click",(()=>{bt()}))]),y.getElement(["停止戴着眼睛",new h("click",(()=>{vt(null),wt([{sender:"系统",content:"您已断开远程连接"}]),re.operation.sendPrivateForgePacket(St,{plug:"forge",type:"multiAccount",option:"monitorQuit",id:It}),It="",St="",xt("已断开")}))])]:[],...me.roaming.myAccountList.map((t=>{let n=re.operation.getOnlineUserInfoById(t);return y.getElement([`${t}${n?` (${n.name})`:""}`,new h("click",(async()=>{e(t,n?.name)}))])}))])}let Et=0,Mt="",Pt="",Lt=!1;function Ft(){Lt||(Lt=!0,Te.forge.privateForgePacket.add((e=>{if("multiAccount"==e.content.type){if(!me.processed.myAccountSet.has(e.senderId))return;let t=re.operation.getOnlineUserInfoById(e.senderId),n=!1;try{switch(e.content.option){case"switchRoom":re.operation.changeRoom(e.content.roomId);break;case"quit":setTimeout((()=>{let e=N.iframeWindow?.location?.reload?.bind(N.iframeWindow.location);if(N.iframeBody?.addChild(y.getElement([f({position:"absolute",left:"0",top:"0",width:"100%",height:"100%",zIndex:"9999999",backgroundColor:"rgb(28, 28, 28)",cursor:"default",whiteSpace:"pre-wrap",textAlign:"center",color:"rgb(255, 255, 255)"}),[f({position:"absolute",inset:"0 0 0 0",height:"fit-content",width:"fit-content",margin:"auto",backgroundColor:"rgb(21, 21, 21)",padding:"10px",borderRadius:"3px"}),`已通过远程指令下线\n下线时间: ${(new Date).toLocaleString()}\n点击恢复`,new h("click",(()=>{e()}))]])),N.iframeWindow.Utils?.service?.saveStatus?.(0),N.socket)try{N.socket.onclose=null,N.socket.onerror=null,N.socket.send=()=>{},N.socket.onmessage=()=>{},N.socket?.close()}catch(e){console.error(e)}N.iframeWindow.addEventListener("keydown",(e=>e.stopImmediatePropagation()),!0),N.iframeWindow.addEventListener("keyup",(e=>e.stopImmediatePropagation()),!0),N.iframeWindow.addEventListener("keypress",(e=>e.stopImmediatePropagation()),!0),N.iframeWindow.addEventListener("mousemove",(e=>e.stopImmediatePropagation()),!0),N.iframeWindow.addEventListener("mousedown",(e=>e.stopImmediatePropagation()),!0),N.iframeWindow.addEventListener("mouseup",(e=>e.stopImmediatePropagation()),!0),N.iframeWindow.location&&(N.iframeWindow.location._reload=()=>{})}),1e3);break;case"syncConfigRQ":{let t=e.content.id;re.operation.sendPrivateForgePacket(e.senderId,{plug:"forge",type:"multiAccount",option:"syncConfigCB",id:t,storageObject:me.roaming});break}case"syncConfigCB":if(kt&&e.content.id==kt){kt="";let t=e.content.storageObject;t&&(t?.userRemark&&Object.keys(me.roaming.userRemark).forEach((e=>{t.userRemark[e]||(t.userRemark[e]=me.roaming.userRemark[e])})),delete t.myAccountList,pe(t),fe(),ee("多账号","拉取其他账号的配置成功"))}n=!0;break;case"monitorRQ":{let t=e.content.id;Mt&&re.operation.sendPrivateForgePacket(St,{plug:"forge",type:"multiAccount",option:"monitorQuit",id:Mt}),Mt=t,Pt=e.senderId,Et=Date.now(),dt((n=>{if(Date.now()>Et+432e5)return dt(null),Mt="",void(Pt="");re.operation.sendPrivateForgePacket(e.senderId,{plug:"forge",type:"multiAccount",option:"monitorCB",id:t,messages:n})}));break}case"monitorSend":e.content.id==Mt&&re.operation.sendRoomMessage(e.content.content);break;case"monitorQuit":{let t=e.content.id;t==Mt?(dt(null),Mt="",Pt="",ee("多账号","多账号监视已断开")):t==It&&(vt(null),wt([{sender:"系统",content:"连接被远端断开"}]),It="",St="",xt("已断开")),n=!0;break}case"monitorCB":e.content.id==It&&(wt(e.content.messages),xt(`使用 ${e.senderName} 发送消息`)),n=!0;break}}catch(e){console.error(e)}n||ee("多账号",`您的账号(${e.senderId}${t?` - ${t.name}`:""})\n正在操作`)}})))}async function Bt(){await j(1100),[{key:"disableDoubleClickFullScreen",cb:()=>{N.iframeBody.addEventListener("dblclick",(e=>e.stopPropagation()))}},{key:"disableRightEdgeTrigger",cb:()=>{Array.from(N.iframeDocument.getElementById("msgholderDisplay").children).some((e=>{let t=e.getAttribute("onmouseenter");return"string"==typeof t&&-1!=t.indexOf("buttonProcesser(12)")&&(e.remove(),!0)}))}}].forEach((e=>{if(me.local.patch[e.key])try{e.cb()}catch(e){console.error(e)}}))}let At="";let Ot=!1;function Rt(){Ot||(Ot=!0,Te.forge.selfPrivateForgePacket.add((e=>{if(At&&"syncConfigCB"==e.content.type&&e.content.id==At){At="";let t=e.content.storageObject;t&&(t?.userRemark&&Object.keys(me.roaming.userRemark).forEach((e=>{t.userRemark[e]||(t.userRemark[e]=me.roaming.userRemark[e])})),pe(t),fe(),ee("配置同步","拉取配置成功"))}if("syncConfigRQ"==e.content.type){let t=e.content.id;re.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncConfigCB",id:t,storageObject:me.roaming}),ee("配置同步","其他设备正在拉取本机配置")}})))}const jt={version:"alpha v1.14.0"},Tt={operation:{showForgeNotice:"显示forge通知",getUserName:"获取你的昵称",getUserUid:"获取你的uid",getUserRoomId:"获取所在房间id",getUserProfilePictureUrl:"获取你的头像",getUserInputColor:"获取你的主题色",sendRoomMessage:"在房间中发送信息",sendRoomForgePacket:"在房间中发送forge数据包",sendPrivateMessageSilence:"[危险]静默发送私聊消息",sendPrivateMessage:"[危险]发送私聊消息",sendSelfPrivateMessageSilence:"向自己静默发送私聊消息(同账号多设备间通信)",giveALike:"进行点赞",switchRoom:"切换所在房间"},event:{roomMessage:"接收房间消息",roomForgePacket:"接收房间forge数据包",privateMessage:"[危险]接收私聊消息",selfPrivateMessage:"接收自己(其他设备)发送给自己的私聊消息"}};async function Nt(e,t,n){let{sandbox:i,windowElement:r}=function(){let e=at(!1);return{windowElement:e.windowElement,sandbox:e.sandbox}}();await i.waitAvailable();let o=n?.operationPermissionSet?n?.operationPermissionSet:new Set,s=n?.eventPermissionSet?n?.eventPermissionSet:new Set,a={applyPermission:async(t,n)=>{if(t=t.filter((e=>Boolean(Tt.operation[e]))),n=n.filter((e=>Boolean(Tt.event[e]))),t.every((e=>o.has(e)))&&n.every((e=>s.has(e))))return!0;let i=await ye("权限申请",[`是否允许 ${e} 获取以下权限?`,...t.map((e=>"+ "+Tt.operation[e])),...n.map((e=>"+ "+Tt.event[e]))].join("\n"),!0);return i&&(t.forEach((e=>{Tt.operation[e]&&o.add(e)})),n.forEach((e=>{Tt.event[e]&&s.add(e)})),Wt.savePlugList()),!!i}};Object.keys(re.operation).forEach((t=>{Tt.operation[t]&&(a[t]=(...n)=>{if(o.has(t))try{re.state.plug={name:e};let i=re.operation[t](...n);return re.state.plug=null,i}catch(e){return void(re.state.plug=null)}})})),a.addEventListener=(e,t)=>{Tt.event[e]&&re.event[e]&&s.has(e)&&re.event[e].add(t)},i.apiObj={iiroseForge:a};let l="document.body.innerHTML='<div style=\"color:white\">network_error</div>';";try{l=await(await fetch(t)).text()}catch(e){}return i.execJs(l),{sandbox:i,windowElement:r,operationPermissionSet:o,eventPermissionSet:s}}const Wt=new class{map=new Map;async addPlug(e,t,n){this.map.has(e)||this.map.set(e,{url:t,...await Nt(e,t,n)})}showPlugWindow(e){if(this.map.has(e)){let t=this.map.get(e).windowElement;t.setDisplay("block"),t.setStyle("pointerEvents","auto")}}removePlug(e){this.map.has(e)&&(this.map.get(e).sandbox.destroy(),this.map.delete(e))}savePlugList(){let e=[];this.map.forEach(((t,n)=>{e.push([n,t.url,Array.from(t.operationPermissionSet.values()),Array.from(t.eventPermissionSet.values())])})),me.roaming.plugInfo=e,fe()}readPlugList(){try{let e=me.roaming.plugInfo;e.length>0&&(e.forEach((([e,t,n,i])=>{this.addPlug(e,t,{operationPermissionSet:new Set(n),eventPermissionSet:new Set(i)})})),ee("iiroseForge plug-in",`已加载 ${e.length} 个插件`))}catch(e){}}};let Dt=null;function $t(){let e=y.getElement([p("position","fixed"),p("top","0"),p("left","0"),p("zIndex","91000"),p("height","100%"),p("width","100%"),p("backgroundColor","rgba(255, 255, 255, 0.75)"),p("backdropFilter","blur(3px)"),[p("opacity","0.8"),p("backgroundColor","#303030"),p("width","100%"),p("boxShadow","0 0 1px rgb(0, 0, 0, 0.12), 0 1px 1px rgb(0, 0, 0, 0.24)"),p("zIndex","2"),p("fontFamily","md"),p("height","40px"),p("lineHeight","40px"),p("fontSize","26px"),p("padding","0 16px 0 16px"),p("whiteSpace","nowrap"),p("boxSizing","border-box"),p("position","relative"),p("color","#fff"),[we("mdi-anvil"),f({display:"inline",opacity:"0.8",backgroundColor:"#303030",boxShadow:"0 0 1px rgb(0,0,0,0.12), 0 1px 1px rgb(0,0,0,0.24)",zIndex:"2",fontFamily:"md",height:"40px",lineHeight:"40px",fontSize:"26px",padding:"0 0 0 0",whiteSpace:"nowrap",boxSizing:"border-box",position:"relative",color:"#fff"})],[p("display","inline"),p("fontSize","16px"),p("opacity","0.7"),p("fontWeight","bold"),p("marginLeft","16px"),p("height","100%"),p("lineHeight","40px"),p("display","inline"),p("verticalAlign","top"),`欢迎使用 iirose-Forge   version ${jt.version}`]],[p("position","absolute"),p("width","100%"),p("top","40px"),p("bottom","40px"),p("overflow","auto"),[f({display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(360px, 1fr))"}),...[{title:"管理插件",text:"管理插件",icon:"puzzle",onClick:async()=>{Le([y.getElement(["[ 添加插件 ]",new h("click",(async()=>{let e=await be("添加插件","请输入插件地址\n插件会自动进行更新",!0);null!=e&&(await Wt.addPlug(e,e),Wt.savePlugList())}))]),...Array.from(Wt.map.keys()).map((e=>y.getElement([`${e}`,new h("click",(async()=>{Le([y.getElement(["显示插件窗口",new h("click",(()=>{Wt.showPlugWindow(e)}))]),y.getElement(["移除插件",new h("click",(()=>{Wt.removePlug(e),Wt.savePlugList()}))])])}))])))])}},{title:"侧载脚本",text:"管理侧载js",icon:"script",onClick:async()=>{await ye("警告",["! 侧载外部脚本是高危操作 !","侧载的脚本不接受forge权限管理","外部脚本能获取您在此网站的所有信息","恶意外部脚本可能盗取您的账号","请勿加载他人提供的闭源脚本","继续操作前 您应该了解自己正在做什么"].join("\n")),Le([y.getElement(["[ 添加iframe外侧侧载脚本 ]",new h("click",(async()=>{let e=await be("添加侧载脚本","请输入脚本地址\n每次载入会重新获取脚本\n脚本将随forge启动运行",!0);null!=e&&(me.roaming.sideLoadedScript.push([e,e,!1]),fe(),ee("添加侧载脚本","已将脚本添加到侧载列表\n将在下次重启时生效"))}))]),y.getElement(["[ 添加iframe内侧侧载脚本 ]",new h("click",(async()=>{let e=await be("添加侧载脚本","请输入脚本地址\n每次载入会重新获取脚本\n脚本将随iframe重载运行",!0);null!=e&&(me.roaming.sideLoadedScript.push([e,e,!0]),fe(),ee("添加侧载脚本","已将脚本添加到侧载列表\n将在下次重启或iframe重载时生效"))}))]),...me.roaming.sideLoadedScript.map((([e,t,n],i)=>y.getElement([`${n?"内":"外"} | ${e}`,new h("click",(async()=>{Le([y.getElement(["移除插件",new h("click",(()=>{me.roaming.sideLoadedScript.splice(i,1),fe(),ee("删除侧载脚本","已将脚本从侧载列表移除\n将在下次重启时生效")}))])])}))])))])}},{title:"插件商店",text:"打开插件商店",icon:"shopping",onClick:async()=>{if(Dt)return Dt.windowElement.setDisplay("block"),void Dt.windowElement.setStyle("pointerEvents","auto");Dt=at(!0),Dt.iframe.element.src="https://iplugin.reifuu.icu";let e=new MessageChannel,t=e.port1,n=new Ge;n.addGlobalNamedFunctions({getForgeVersion:async()=>jt.version,getPlugList:async()=>Array.from(Wt.map.entries()).map((e=>({name:e[0],url:e[1].url}))),installPlug:async(e,t)=>3,uninstallPlug:async e=>3}),t.addEventListener("message",(e=>{n.onData(e)})),n.bindOutStream((e=>{t.postMessage(e)}),"raw"),Dt.iframe.addEventListener("load",(()=>{t.start(),Dt.iframe.element.contentWindow.postMessage({type:"setMessagePort",port:e.port2},"*",[e.port2])})),Dt.windowElement.setDisplay("block"),Dt.windowElement.setStyle("pointerEvents","auto")}},{title:"拉取配置",text:"获取您其他在线设备的配置",icon:"sync",onClick:async()=>{!function(){ee("配置同步","正在尝试获取配置");let e=V();re.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncConfigRQ",id:e}),At=e}()}},{title:"美化设置",text:"定制你的界面",icon:"brush-outline",onClick:async()=>{Le([...[{name:"侧边栏顶部图片",key:"sidebarTopPicture",type:"text"},{name:"侧边栏列表背景图片",key:"sidebarListPicture",type:"text"},{name:"选择菜单背景图片",key:"selectMenuBackground",type:"text"},{name:"选择菜单圆角半径",key:"selectMenuBorderRadius",type:"number"},{name:"消息图片圆角半径",key:"messageImgBorderRadius",type:"number"},{name:"消息头像圆角半径",key:"messageAvatarBorderRadius",type:"number"},{name:"系统消息圆角半径",key:"systemMessageBorderRadius",type:"number"},{name:"系统消息图片圆角半径",key:"systemMessageImgBorderRadius",type:"number"},{name:"会话选择项圆角半径",key:"sessionListItemBorderRadius",type:"number"},{name:"面板项圆角半径",key:"panelItemBorderRadius",type:"number"}].map((e=>y.getElement([e.name+(me.roaming.beautify[e.key]?" (已设置)":""),new h("click",(async()=>{let t="number"==e.type?"填写一个数字":"",n=me.roaming.beautify[e.key],i=await be("美化设置",`设置 ${e.name}${t?"\n"+t:""}`,!0,n||"");if(null!=i)if(""!=i){if("number"==e.type&&!Number.isFinite(Number(i)))return void ee("美化设置","设置的值不是一个数字");me.roaming.beautify[e.key]=i,fe()}else delete me.roaming.beautify[e.key],fe()}))])))])}},{title:"附加功能",text:"设置本机的附加功能",icon:"cog",onClick:async()=>{Le([...[{name:"用户备注",storageKey:"enableUserRemark"},{name:"聊天记录同步(测试)",storageKey:"enableSyncChatRecord"},{name:"超级菜单",storageKey:"enableSuperMenu"},{name:"快捷房管操作",storageKey:"enableRoomAdminOperation"},...me.local.enableExperimental?[{name:"实验性功能",storageKey:"enableExperimental"},{name:"实验性功能设置",func:async()=>{let e=JSON.stringify(me.local.experimentalOption,void 0,4),t=await async function(e,t,n=!1,i=""){var r=S({tagName:"textarea",style:{resize:"none",height:"5em",weight:"20em"},attr:{value:i}});return r.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),await ye(e,t,n,r)?r.element.value:void 0}("实验性功能设置","设置实验性功能的json",!0,e);if(null!=t&&t!=e)try{me.local.experimentalOption=JSON.parse(t),ge(),ee("实验性功能","已更新实验性功能设置")}catch(e){ee("实验性功能",`实验性功能设置更新失败\n${e instanceof Error?e.message:""}`)}}}]:[]].map((e=>y.getElement([`${e.storageKey?me.local[e.storageKey]?"(已启用)":"(已禁用)":""}${e.name}`,new h("click",(async()=>{if(e.storageKey){let t=!me.local[e.storageKey];await ye("设置功能",`切换 ${e.name} 功能到 ${t?"启用":"禁用"} 状态\n可能需要重载以生效`,!0)&&(me.local[e.storageKey]=t,ge())}else e.func&&e.func()}))])))])}},{title:"补丁设置",text:"启用或禁用补丁",icon:"bandage",onClick:async()=>{Le([...[{name:"禁用双击全屏",key:"disableDoubleClickFullScreen"},{name:"禁用右侧边缘显示聊天列表",key:"disableRightEdgeTrigger"}].map((e=>y.getElement([(me.local.patch[e.key]?" (已启用)":"(已禁用)")+e.name,new h("click",(async()=>{let t=!me.local.patch[e.key];await ye("设置补丁",`切换 ${e.name} 补丁到 ${t?"启用":"禁用"} 状态\n可能需要重载以生效`,!0)&&(t?me.local.patch[e.key]=t:delete me.local.patch[e.key],ge())}))])))])}},{title:"账号管理",text:"管理你的其他账号",icon:"account-cog",onClick:async()=>{await Ct()}},{title:"黑名单",text:"管理黑名单",icon:"account-cancel-outline",onClick:async()=>{await Fe()}},{title:"安装iiroseForge",text:"下次使用无需注入",icon:"puzzle",onClick:async()=>{localStorage.setItem("installForge","true"),he(!0),ye("安装iiroseForge","已完成")}},{title:"卸载iiroseForge",text:"下次启动清除iiroseForge",icon:"puzzle",onClick:async()=>{localStorage.removeItem("installForge"),async function(){let e=await caches.open("v"),t=await caches.match("/");if(t){let n=ue(await t.text());await e.put("/",new Response(new Blob([n],{type:"text/html"}),{status:200,statusText:"OK"}))}}(),ye("卸载iiroseForge","已完成")}}].map((e=>[we("commonBox"),p("maxWidth","calc(100% - 24px)"),p("minWidth","355.2px"),p("minHeight","200px"),p("float","none"),p("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),p("margin","24px 12px 0px 12px"),p("position","relative"),[we("commonBoxHead"),p("backgroundColor","rgba(255,255,255,0.2)"),p("color","rgba(0,0,0,0.4)"),p("height","100px"),p("width","100%"),p("display","flex"),p("justifyContent","center"),p("padding","0 24px"),p("boxSizing","border-box"),[we("mdi-"+e.icon),p("lineHeight","100px"),p("fontSize","30px"),p("fontFamily","md"),p("display","inline-block"),p("verticalAlign","top"),p("height","100%"),p("opacity","0.7")],[p("lineHeight","100px"),p("fontSize","20px"),p("display","inline-block"),p("verticalAlign","top"),p("height","100%"),p("fontWeight","bold"),p("marginLeft","22px"),p("overflow","hidden"),p("whiteSpace","pre"),p("textOverflow","ellipsis"),e.title]],[we("textColor"),p("width","100%"),p("minHeight","100px"),p("backgroundColor","rgba(255,255,255,0.5)"),p("color","rgba(0,0,0,0.75)"),[p("fontWeight","bold"),p("width","100%"),p("height","100%"),p("lineHeight","1.8em"),p("textAlign","center"),p("padding","2.2em"),p("boxSizing","border-box"),p("whiteSpace","pre-wrap"),p("fontSize","16px"),p("color","rgba(0,0,0,0.7)"),e.text]],new h("click",e.onClick)]))],[f({height:"25px"})]],[p("color","#303030"),p("background","#fff"),p("opacity","0.8"),p("display","flex"),p("height","40px"),p("position","absolute"),p("bottom","0"),p("width","100%"),p("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),p("zIndex","2"),...[{text:"< 返回",onClick:()=>{e.remove()}}].map((e=>[p("width","0"),p("flexGrow","1"),p("justifyContent","center"),p("padding","0 24px"),p("boxSizing","border-box"),new h("click",e.onClick),[],[p("display","inline-block"),p("verticalAlign","top"),p("height","100%"),p("fontWeight","bold"),p("marginLeft","22px"),p("fontSize","14px"),p("lineHeight","40px"),p("overflow","hidden"),p("whiteSpace","pre"),p("textOverflow","ellipsis"),e.text]]))],e=>{const t=["left","leftDown","down","rightUp","right","rightDown","up","leftUp","none"];let n=[],i=0,r=0,o=null,s="none";function a(e){e.pressing?(i=0,r=0,s="none",null==o&&(o=setInterval(l,85))):(i+=e.vx,r+=e.vy),e.hold||null!=o&&(clearInterval(o),o=null)}function l(){let e="none";for((Math.abs(i)>=10||Math.abs(r)>=10)&&(e=t[Math.floor((Math.floor(16*(Math.atan2(-r,i)/(2*Math.PI)+.5))+1)%16/2)]),i=0,r=0,e!=s&&(s=e,"none"!=s&&n.push(s));n.length>200;)n.shift();const o=["down","down","leftDown","right","down"];o.every(((e,t)=>e==n.at(t-o.length)))&&(n=[],me.local.enableExperimental=!0,ge(),ee("实验性功能","已激活实验性功能\n部分功能需要重载以启用"))}E(e,a,0,N.iframeWindow),M(e,a,!1),e.addEventListener("mousedown",(e=>{e.stopPropagation()})),e.addEventListener("mouseup",(e=>{e.stopPropagation()})),e.addEventListener("touchstart",(e=>{e.stopPropagation()})),e.addEventListener("touchend",(e=>{e.stopPropagation()})),e.addEventListener("touchmove",(e=>{e.stopPropagation()})),e.addEventListener("touchcancel",(e=>{e.stopPropagation()}))}]);return e.element.id="iiroseForgeMenu",e}let Ut="",Ht=0;function zt(){ee("聊天记录同步","正在尝试获取聊天记录");let e=V();re.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncPrivateChatRecordRQ",id:e,startTime:Math.max(Date.now()-2592e5,me.local.lastCloseTime-108e6,me.local.syncChatRecordTo-9e5),endTime:Date.now()+3e4}),Ut=e,Ht=Date.now()}let Vt=!1;function Jt(){Vt||(Vt=!0,Te.forge.selfPrivateForgePacket.add((e=>{if(Ut&&"syncPrivateChatRecordCB"==e.content.type&&e.content.id==Ut&&Ht+35e3>=Date.now()&&e.content.content){let t=function(e,t){let n=0,i=Yt(),r=new Map(i.map((e=>[e.uid,e])));return e.forEach((e=>{let i=r.get(e.uid);if(i){let r=new Map;for(let e=i.records.length-1;e>=0;e--){let n=Xt(i.records[e]),o=n[1],s=n[3];if(o<t-6e4)break;r.set(s,n)}e.records.forEach((e=>{let t=Xt(e)[3];r.has(t)||n++}))}else n+=e.records.length})),n}(e.content.content,e.content.startTime);0==t?ee("聊天记录同步","本地聊天记录已为最新"):ee("聊天记录同步",`从其他设备获取到 ${t} 条记录\n点击合并记录到当前设备`,void 0,(()=>{me.local.syncChatRecordTo=Math.min(Date.now(),e.content.endTime),Number.isNaN(me.local.syncChatRecordTo)&&(me.local.syncChatRecordTo=Date.now()),ge(),function(e,t){let n=Yt(),i=new Map(n.map((e=>[e.uid,e])));e.forEach((e=>{let r=i.get(e.uid);if(r){let n=new Map;for(let e=r.records.length-1;e>=0;e--){let i=Xt(r.records[e]),o=i[1],s=i[3];if(o<t-3e5)break;n.set(s,i)}let i=r.records.length;for(let t=e.records.length-1;t>=0;t--){let o=Xt(e.records[t]),s=o[1],a=o[3];if(!n.has(a)){for(;i>0&&Xt(r.records[i-1])[1]>s;)i--;r.records.splice(i,0,o)}}}else n.push(e)})),function(e){let t=e.map((e=>[e.uid,e.info.map(((t,n)=>(7==n||8==n)&&e.records.length>0?Xt(e.records.at(-1))[3]:t)).join(">"),e.records.map((e=>"string"==typeof e?e:[e[0]?"1":"",Math.floor(e[1]/1e3).toString(10),...e.slice(2)].join("'"))).join(">"),e.records.length.toString(10)].join('"'))).join("<");localStorage.setItem(`pmLog_${re.operation.getUserUid()}`,t)}(n);let r=N.iframeWindow.Utils.service.saveStatus.bind(N.iframeWindow.Utils.service);N.iframeWindow.Utils.service.saveStatus=()=>{for(let e=0;e<=11;e++)7!=e&&r(e,1)},N.iframeWindow.location.reload()}(e.content.content,e.content.startTime)}))}if("syncPrivateChatRecordRQ"==e.content.type){let t=Number(e.content.startTime),n=Number(e.content.endTime);if(Number.isNaN(t)||Number.isNaN(n)||!(t<n))return;let i=Yt(),r=[];i.forEach((e=>{if(0==e.records.length||!(Xt(e.records.at(-1))[1]>=t))return;let i=[];for(let r=e.records.length-1;r>=0;r--){let o=Xt(e.records[r]),s=o[1];if(s<t)break;if(t<=s&&s<n){let e=o[2];e.startsWith("iiroseForge:")&&e.endsWith(":end")||i.push(o)}}i.length>0&&(i.sort(((e,t)=>e[1]-t[1])),r.push({name:e.name,info:e.info,uid:e.uid,otherInfo:e.otherInfo,records:i}))}));let o=e.content.id;re.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncPrivateChatRecordCB",id:o,content:r,startTime:t,endTime:n}),ee("聊天记录同步","其他设备正在拉取本机聊天记录")}})))}function Yt(){N.iframeWindow.Utils?.service?.saveStatus?.(7,1);let e=localStorage.getItem(`pmLog_${re.operation.getUserUid()}`);return e?e.split("<").map((e=>{let t=e.split('"').map((e=>e.split(">")));return{uid:t[0]?.[0],name:t[1]?.[2],info:t[1],records:t[2],otherInfo:t[3]}})):[]}function Xt(e){if("string"==typeof e){let t=e.split("'"),n=1e3*Number(t[1]);return["1"==t[0],n,...t.slice(2)]}return e}class _t{element=null;list=[];relativePosition=0;currentRowIndex=0;startRowIndex=0;menu=null;constructor(){this.element=y.getElement([f({position:"absolute",width:"700px",maxWidth:v.diFull("50px"),maxHeight:v.diFull("50px"),minHeight:"700px",inset:"0 0 0 0",margin:"auto",transform:"none",display:"none",backgroundColor:"rgba(0, 0, 0, 0.1)",overflow:"hidden"})])}setRelativePosition(e){(-1<=e&&e<=1||-1<=this.relativePosition&&this.relativePosition<=1)&&(this.element.setDisplay("block"),this.element.animate([{transform:_t.#P(this.relativePosition)},{transform:_t.#P(e)}],{duration:140,easing:"cubic-bezier(0.33, 1, 0.68, 1)",fill:"forwards"})),this.relativePosition=e}static#P(e){return 0==e?"none":`scale(0.8) translateX(${(e>0?15:-15)+105*e}%)`}addChild(e,t){this.list.push({element:e,execute:t}),this.element.addChild(e)}clearChild(){this.list.forEach((e=>e.element.remove())),this.list=[]}setCurrentRow(e){if(0==this.list.length)return void this.menu.setCursorIndicator(null);e<0?e=0:e>=this.list.length&&(e=this.list.length-1);let t=this.list[e].element;this.currentRowIndex=e,t.element.offsetTop<this.element.element.scrollTop?this.element.element.scrollTop=this.list[e].element.element.offsetTop:t.element.offsetTop+t.element.clientHeight>this.element.element.scrollTop+this.element.element.clientHeight&&(this.element.element.scrollTop=t.element.offsetTop+t.element.clientHeight-this.element.element.clientHeight),this.menu.setCursorIndicator(t.element.getBoundingClientRect())}triggerCurrent(){this.currentRowIndex!=this.startRowIndex&&this.list[this.currentRowIndex]?.execute()}}class Kt{visible=!1;menuList=[];menuElement=null;menuPointerX=0;menuPointerY=0;currentColumnIndex=0;startColumnIndex=0;cursorIndicator={element:null,visible:!1,x:0,y:0,width:0,height:0};constructor(){this.menuElement=y.getElement([f({height:"100%",width:"100%",top:"0",left:"0",position:"fixed",backgroundColor:"rgba(230, 230, 230, 0.5)",zIndex:"10000000"}),this.cursorIndicator.element=y.getElement([f({display:"none",position:"absolute",top:"50%",left:"50%",width:"0px",height:"0px",border:"5px rgba(255, 255, 255, 0.7) solid",boxShadow:"0px 0px 5px 1px rgba(13, 14, 17, 0.7)",boxSizing:"border-box",zIndex:"100"})])])}addColumn(e){this.menuList.push(e),e.menu=this,this.menuElement.addChild(e.element),e.setRelativePosition(this.menuList.length-1-this.currentColumnIndex)}setCurrentColumn(e){e<0?e=0:e>=this.menuList.length&&(e=this.menuList.length-1),this.currentColumnIndex!=e&&(this.currentColumnIndex=e,this.menuList.forEach(((e,t)=>e.setRelativePosition(t-this.currentColumnIndex))))}draw(){const e=375;let t=-(this.startColumnIndex+.5)*e,n=(this.menuList.length-this.startColumnIndex-.5)*e;this.menuPointerX>=n?this.menuPointerX=n-1:this.menuPointerX<t&&(this.menuPointerX=t);let i=this.startColumnIndex+Math.round(this.menuPointerX/e);this.setCurrentColumn(i);let r=this.menuList[this.currentColumnIndex],o=75*-(r.startRowIndex+.5),s=75*(r.list.length-r.startRowIndex-.5);this.menuPointerY>=s?this.menuPointerY=s-1:this.menuPointerY<o&&(this.menuPointerY=o);let a=r.startRowIndex+Math.round(this.menuPointerY/75);r.setCurrentRow(a);let l=this.menuPointerY/75-Math.round(this.menuPointerY/75)+.5,c=this.menuPointerX/e-Math.round(this.menuPointerX/e)+.5;this.cursorIndicator.visible&&this.cursorIndicator.element.setStyle("borderImage",`linear-gradient(0deg, rgb(170, 170, 170), rgb(255, 255, 255) ${(100*(1-l)).toFixed(1)}%, rgb(170, 170, 170)) 30`),this.menuElement.setStyle("backgroundImage",`linear-gradient(90deg, rgba(170, 170, 170, 0.5), rgba(235, 235, 235, 0.6) ${(100*c).toFixed(1)}%, rgba(170, 170, 170, 0.5))`)}show(){this.visible||(this.menuElement.animate([{opacity:"0.5"},{transform:"",opacity:"1"}],83),this.menuElement.setDisplay("block"),N.iframeDocument.body.contains(this.menuElement.element)||N.iframeDocument.body.appendChild(this.menuElement.element),this.visible=!0,this.draw(),function(e){let t=!1,n=0,i=performance.now(),r=i,o=()=>{n=0;let s=performance.now();t||1==e(s-i,s-r)||(r=s,n=requestAnimationFrame(o))};n=requestAnimationFrame(o)}((()=>(this.draw(),!this.visible))))}hide(){this.visible&&(this.visible=!1,this.menuElement.setDisplay("none"))}menuPointerMove(e,t){this.menuPointerX+=1*e,this.menuPointerY+=1*t}menuPointerReset(){this.startColumnIndex=this.currentColumnIndex,this.menuList.forEach((e=>e.startRowIndex=e.currentRowIndex)),this.menuPointerX=0,this.menuPointerY=0}triggerCurrent(){this.menuList[this.currentColumnIndex]?.triggerCurrent()}setCursorIndicator(e){if(e){const t=.001;(Math.abs(e.x-this.cursorIndicator.x)>=t||Math.abs(e.y-this.cursorIndicator.y)>=t||Math.abs(e.width-this.cursorIndicator.width)>=t||Math.abs(e.height-this.cursorIndicator.height)>=t||!this.cursorIndicator.visible)&&(this.cursorIndicator.x=e.x,this.cursorIndicator.y=e.y,this.cursorIndicator.width=e.width,this.cursorIndicator.height=e.height,this.cursorIndicator.visible=!0,this.cursorIndicator.element.setDisplay("block"),this.cursorIndicator.element.animate([{},{left:this.cursorIndicator.x.toFixed(3)+"px",top:this.cursorIndicator.y.toFixed(3)+"px",width:this.cursorIndicator.width.toFixed(3)+"px",height:this.cursorIndicator.height.toFixed(3)+"px"}],{duration:120,easing:"cubic-bezier(0.33, 1, 0.68, 1)",fill:"forwards"}))}else this.cursorIndicator.visible&&(this.cursorIndicator.visible=!1,this.cursorIndicator.element.setDisplay("none"))}}function qt(){let e=!1,t=null,i=new Kt,r=new _t,o=new _t,s=new _t;function a(){{o.clearChild();let e=0,t=0;Array.from(N.iframeDocument.querySelector("div#sessionHolder > div.sessionHolderPmTaskBox")?.children).forEach((i=>{if(i.classList.contains("sessionHolderPmTaskBoxItem")){let r=i.cloneNode(!0);r.classList.remove("whoisTouch2");let s=r.onclick;r.removeAttribute("onclick"),r.removeAttribute("oncontextmenu"),o.addChild(x(r),(()=>{s.call(i,new MouseEvent(""))}));let a=n(i,[-1]);"none"!=a.style.display&&"@"==a.innerText&&(e=t),t++}})),o.currentRowIndex=e}{s.clearChild();let e=re.operation.getUserRoomId();s.addChild(Qt(e),(()=>{}));try{let t=JSON.parse(localStorage.getItem("database"))?.roomHistory?.split?.(",");t&&t.forEach((t=>{t!=e&&s.addChild(Qt(t,"历史"),(()=>{re.operation.switchRoom(t)}))}))}catch(e){console.error("forge supper menu:",e)}s.currentRowIndex=0}r.clearChild(),r.addChild(Gt("","无动作",""),(()=>{})),r.addChild(Gt("mdi-mailbox","打开信箱",""),(()=>{N.iframeWindow?.functionBtnDo?.(2)})),r.addChild(Gt("mdi-music","切换媒体开关",""),(()=>{N.iframeWindow?.functionBtnDo?.(90)})),r.addChild(Gt("mdi-music-box-multiple","打开播放列表",""),(()=>{N.iframeWindow?.functionBtnDo?.(1,N.iframeDocument?.createElement("div"))})),r.addChild(Gt("mdi-store","打开商店",""),(()=>{N.iframeWindow?.functionBtnDo?.(10,N.iframeDocument?.createElement("div"))})),r.addChild(Gt("mdi-camera-iris","打开朋友圈",""),(()=>{N.iframeWindow?.functionBtnDo?.(5)})),r.addChild(Gt("mdi-forum","打开论坛",""),(()=>{N.iframeWindow?.functionBtnDo?.(3)})),r.addChild(Gt("mdi-clipboard-check-multiple","打开任务版",""),(()=>{N.iframeWindow?.functionBtnDo?.(4)})),r.currentRowIndex=0,i.setCurrentColumn(1)}i.addColumn(r),i.addColumn(o),i.addColumn(s),i.setCurrentColumn(1);let l=t=>{e&&i.menuPointerMove(t.movementX,t.movementY)};if(N.iframeWindow.addEventListener("mousedown",(n=>{2==n.button&&(e||(t=setTimeout((()=>{e=!0,t=null,a(),i.menuPointerReset(),i.show(),N.iframeWindow.addEventListener("mousemove",l,!0),i.menuElement.element.requestPointerLock({unadjustedMovement:!0})}),125)))}),!0),N.iframeWindow.addEventListener("mouseup",(n=>{2==n.button&&(null!=t&&(clearTimeout(t),t=null),e&&(i.triggerCurrent(),N.iframeWindow.removeEventListener("mousemove",l,!0),document.exitPointerLock(),N.iframeDocument.exitPointerLock(),setTimeout((()=>{e=!1,i.hide()}),10)))}),!0),N.iframeWindow?.isMobile){M(x(N.iframeDocument.body),(t=>{e&&(l({movementX:1.8*t.vx,movementY:1.8*t.vy}),t.hold||setTimeout((()=>{i.triggerCurrent(),e=!1,i.hide()}),10))}),!1);let t=N.iframeDocument.getElementById("msgholder");t?.addEventListener("contextmenu",(n=>{let r=n.target;!r.classList.contains("fullBox")&&!r.classList.contains("pubMsgTime")||r!=t&&r.parentElement!=t&&r.parentElement?.parentElement!=t&&r.parentElement?.parentElement?.parentElement!=t||(n.stopImmediatePropagation(),e=!0,a(),i.menuPointerReset(),i.show())}),!0)}}function Qt(e,t=""){let n=re.operation.getRoomInfoById(e);return n?Gt("http"+n.roomImage,n.name,n.description,"hidden"!=n.currentUserNum?`${n.currentUserNum}人`:"隐藏人数",t,`rgba(${n.color}, 0.8)`):Gt("","不存在的房间","","","","rgba(0, 0, 0, 0.8)")}function Gt(e,t,n,i="",r="",o="rgba(240, 240, 240, 0.8)"){let s=function(e){let t=o.indexOf("(");-1!=t&&(e=e.slice(t+1,e.lastIndexOf(")")));let n=e.split(",").map((e=>Number.parseInt(e)));return.299*n[0]+.587*n[1]+.114*n[2]>186}(o)?"rgba(0, 0, 0, 0.75)":"rgba(255, 255, 255, 0.75)";return y.getElement([we("sessionHolderPmTaskBoxItem"),f({backgroundColor:o,color:s}),[f({height:"100px",width:"100px",position:"relative",WebkitMaskImage:"linear-gradient(to right,#000 50%,transparent)",display:e?"block":"none"}),[we("bgImgBox"),e.startsWith("mdi-")?[f({width:"100%",height:"100%",textAlign:"center"}),[f({lineHeight:"100px",fontSize:"50px",fontFamily:"md",height:"100%"}),we(e),new g("span")]]:[we("bgImg"),new g("img"),new u("loading","lazy"),new u("decoding","async"),new u("src",e)],[we("fullBox")]]],[f({height:"100%",position:"absolute",top:"0",left:"100px",right:"0"}),[we("sessionHolderPmTaskBoxItemName textOverflowEllipsis"),[f({fontSize:"inherit",fontWeight:"inherit"}),t]],[we("sessionHolderPmTaskBoxItemTime textOverflowEllipsis"),i],[we("sessionHolderPmTaskBoxItemMsg textOverflowEllipsis"),n]],[f({position:"absolute",top:"1px",right:"1px",backgroundColor:s,color:o,fontSize:"16px",fontWeight:"bold",padding:"0px 8px",height:"26.5px",lineHeight:"26.5px",transition:"transform 0.25s ease 0s",borderRadius:"0px 0px 0px 2px",display:r?"block":"none"}),r]])}let Zt=new TextEncoder;function en(){let t=!1;O(N.iframeBody.element,(e=>{"Shift"==e.key&&(t=e.hold)})),N.iframeWindow.Objs.mapHolder.function.roomchanger=e(N.iframeWindow.Objs.mapHolder.function.roomchanger,(e=>{if(1==e.length&&"string"==typeof e[0]&&(me.local.experimentalOption.ejection||me.local.experimentalOption.ejectionButton&&t)){return tn(e[0]),!0}return!1})),me.local.experimentalOption.ejectionButton&&ke("ejectionButton","roomMenu",(()=>({text:"弹射起步",icon:"ghost-outline"})),(async e=>{tn(e.roomId)})),me.local.experimentalOption.withdraw&&function(){if(nn)return;nn=!0,We.addPath("v0#",(e=>{let t=e.split('"');try{let e=N.iframeDocument.querySelector(`div#msgholder div.fullBox[index="0"] div[data-id="${t[0]}"]`);n(e,[0,0,0])?.appendChild(y.getElement([f({backgroundColor:v.rgb(100,100,100,.6),color:v.rgb(255,255,255,.9),borderRadius:"3px",position:"absolute",padding:"0.2em",bottom:"-0.7em",["right"!=e.style.float?"right":"left"]:"-1.7em"}),"已撤回"]).element)}catch(e){console.error(e)}return!0})),We.addPath("v0*",(e=>{let t=e.split('"');try{let e=N.iframeDocument.querySelector(`div#msgholder div.fullBox[ip="${t[0]}"] div[data-id="${t[1]}"]`);n(e,[1,0])?.appendChild(y.getElement([f({backgroundColor:v.rgb(100,100,100,.6),color:v.rgb(255,255,255,.9),borderRadius:"3px",position:"absolute",padding:"0.2em",bottom:"-0.7em",["right"!=e.style.float?"right":"left"]:"-1.7em"}),"已撤回"]).element)}catch(e){console.error(e)}return!0}))}(),me.local.experimentalOption.interceptState&&function(){if(rn)return;rn=!0,Ne.addPath("s",((e,t)=>{var n;"s"==t&&(n="",De[0]=n)}))}()}function tn(e){N.socket?._send(Zt.encode("m"+e)),N.socket.onclose=()=>{},N.socket?.close(),setTimeout((()=>{N.iframeWindow?.sessionStorage?.setItem?.("lastroom",""),N.iframeWindow?.sessionStorage?.setItem?.("autologin","1"),N.iframeWindow?.Cookie?.("roomsave",e),N.iframeWindow?.location?.reload?.()}),7e3),ee("实验性功能","少女祈祷中..."),setTimeout((()=>{ee("实验性功能","马上就好了~")}),3500)}let nn=!1;let rn=!1;let on=!1,sn=!1;function an(){on=!1,sn=!1;let e=re.operation.getUserName(),t=re.operation.getRoomInfoById(re.operation.getUserRoomId());t&&(e==t.ownerName?(on=!0,sn=!0):t.member.some((t=>{t.name!=e||"admin"!=t.auth&&"member"!=t.auth||(on=!0,"admin"==t.auth&&(sn=!0))}))),ke("roomAdminOperation","roomMessageMenu",(()=>on?{icon:"wrench",text:"房管操作"}:null),(e=>{Le([...sn?[y.getElement(["白名单",new h("click",(async()=>{let t=await be("房管操作",`设置用户(${e.userName})\n的白名单时间\nd天 h时 m分 s秒 &永久`,!0,"&");if(null==t)return;let n=await be("房管操作",`设置用户(${e.userName})\n的白名单备注`,!0,"");null!=n&&N.socketApi.send(`!hw${JSON.stringify(["4",e.userName.toLowerCase(),t,n])}`)}))]),y.getElement(["黑名单",new h("click",(async()=>{let t=await be("房管操作",`设置用户(${e.userName})\n的黑名单时间\nd天 h时 m分 s秒 &永久`,!0,"30d");if(null==t)return;let n=await be("房管操作",`设置用户(${e.userName})\n的黑名单备注`,!0,"");null!=n&&N.socketApi.send(`!h4${JSON.stringify(["4",e.userName.toLowerCase(),t,n])}`)}))]),y.getElement(["永久黑名单",new h("click",(async()=>{let t=await be("房管操作",`设置用户(${e.userName})\n的永久黑名单备注`,!0,"");null!=t&&N.socketApi.send(`!h4${JSON.stringify(["4",e.userName.toLowerCase(),"&",t])}`)}))])]:[],y.getElement(["移出房间",new h("click",(async()=>{await ye("房管操作",`是否将用户(${e.userName})\n移出房间`)&&N.socketApi.send(`!#${JSON.stringify([e.userName.toLowerCase()])}`)}))])])}))}function ln(){t((()=>{let t=document.getElementById("mainFrame"),n=t.contentWindow,i=t.contentDocument;if(N.iframeDocument=i,N.iframeWindow=n,N.iframeBody=x(i.body),!n.iiroseForgeInjected){if(null!=n.socket.__onmessage||null==n.socket._onmessage||null==n.socket._send)throw"main iframe is not ready";(()=>{let e=x(i.getElementById("functionHolder").childNodes[0]),t=function(){let e=N.iframeDocument?.querySelector("div#functionHolder div.functionButton.functionButtonGroup"),t=e?getComputedStyle(e).backgroundColor:"rgb(255, 255, 255)",n=e?getComputedStyle(e).color:"rgb(33, 33, 33)",i=y.getElement([p("backgroundColor",t),p("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),p("position","relative"),p("zIndex","1"),p("color",n),p("paddingLeft","16px"),p("paddingRight","56px"),p("transition","background-color 0.1s ease 0s, color 0.1s ease 0s"),p("cursor","url(images/cursor/2.cur), pointer"),p("width","100%"),p("height","56px"),p("boxSizing","border-box"),p("lineHeight","56px"),p("whiteSpace","nowrap"),new h("click",(()=>{N.iframeWindow?.functionHolderDarker?.click(),N.iframeBody.addChild($t())})),new h("mouseenter",((e,n)=>{"transparent"==n.getStyle("backgroundColor")?(t="transparent",n.setStyle("backgroundColor","rgba(127, 127, 127, 0.3)")):n.setStyle("backgroundColor","#202020"==t||"rgb(32, 32, 32)"==t?"rgb(42, 42, 42)":"rgb(245, 245, 245)"),N.iframeWindow?.Utils?.Sound?.play?.(0)})),new h("mouseleave",((e,n)=>{n.setStyle("backgroundColor",t)})),[new g("span"),new d((e=>e.element.classList.add("functionBtnIcon","mdi-anvil")))],[new g("span"),"Forge菜单",new d((e=>e.element.classList.add("functionBtnFont")))],[new g("span"),p("transform","rotate(-90deg)"),new d((e=>e.element.classList.add("functionBtnGroupIcon")))]]);return i.element.id="iiroseForgeMenuButton",i}();e.insChild(t,1)})(),N.socket=n.socket,N.socket._onmessage=e(N.socket._onmessage.bind(N.socket),(e=>{oe.debugMode&&console.log("receive packet",e);try{if(De=t=e,We.matchPrefix(t[0]))return!0}catch(e){return console.error("[iiroseForge]",e),!1}var t;return!1})),N.socketApi.send=N.socket.send.bind(N.socket),N.socket.send=e(N.socketApi.send,(e=>{oe.debugMode&&console.log("send packet",e);try{if(De=t=e,Ne.matchPrefix(t[0]))return!0}catch(e){return console.error("[iiroseForge]",e),!1}var t;return!1})),n.iiroseForgeInjected=!0,console.log("[iiroseForge] 成功将iiroseForge注入iframe"),n.iiroseForgeApi=re,oe.debugMode&&ae(oe.debugMode),(async()=>{let e=0;me.roaming.sideLoadedScript.forEach((([t,n,r])=>{if(r){let t=document.createElement("script");t.src=n,i.body.appendChild(t),e++}})),e>0&&ee("iiroseForge plug-in",`已在iframe内侧侧载 ${e} 个js脚本`)})(),[{func:Rt},{func:Jt},{func:Ft},{func:ht},{func:Ze},{func:Bt},{func:Ce,condition:"enableUserRemark"},{func:an,condition:"enableRoomAdminOperation"},{func:zt,condition:"enableSyncChatRecord"},{func:qt,condition:"enableSuperMenu"},{func:en,condition:"enableExperimental"},{func:Ae}].forEach((e=>{try{e.condition&&!me.local[e.condition]||e.func()}catch(e){console.error("patch error:",e)}}))}}),1e3),"true"==localStorage.getItem("installForge")&&t((()=>{let e=document.getElementById("mainFrame").contentWindow;if(e.iiroseForgeClearCacheInjected)return;if(!e.Utils?.service?.clearCache)throw"Incomplete load";let t=e.Utils.service.clearCache.bind(e.Utils.service);e.Utils.service.clearCache=(...n)=>{let i=e.parent.location._reload.bind(e.parent.location);e.location._reload=e.parent.location._reload=(...e)=>{setTimeout((async()=>{await he(!1),setTimeout((()=>{i(...e)}),5)}),100)},t(...n)},e.iiroseForgeClearCacheInjected=!0}),5)}if("iirose.com"==location.host)if("/"==location.pathname)if(window.iiroseForgeInjected)console.log("[iiroseForge] 已阻止重复注入");else{window.iiroseForgeInjected=!0,console.log("[iiroseForge] iiroseForge已启用"),window.enableForgeDebugMode=ae,"true"==sessionStorage.getItem("iiroseForgeDebugMode")&&ae(!0),function(){try{let e=localStorage.getItem("iiroseForge");pe(e?JSON.parse(e):{})}catch(e){ee("错误","无法读入储存 这可能导致iiroseForge配置丢失")}}(),function(){try{let e=localStorage.getItem("iiroseForgeLocal"),t=e?JSON.parse(e):{};Object.keys(t).forEach((e=>{me.local[e]=t[e]}))}catch(e){ee("错误","无法读入本地储存 这可能导致iiroseForge配置丢失")}}(),Wt.readPlugList();let e=document.getElementById("mainFrame");e.addEventListener("load",(()=>{console.log("[iiroseForge] 已重载 正在将iiroseForge注入iframe"),ln()})),console.log("[iiroseForge] 正在将iiroseForge注入iframe"),ln(),window.addEventListener("beforeunload",(()=>{me.local.lastCloseTime=Date.now(),ge()}));let t=0,n=!1;setInterval((()=>{0==e.contentWindow?.socket?.readyState?t>=2?n||(n=!0,ee("无法连接",["检测到连接到iirose服务器的速度过慢",`正在连接: ${e.contentWindow?.socket?.url}`,"可能是当前尝试连接的服务器出现了问题","点击以尝试连接其他候选服务器"].join("\n"),void 0,(()=>{if(t=0,n=!1,0==e.contentWindow?.socket?.readyState){try{e.contentWindow?.socket?.close()}catch(e){}try{e.contentWindow?.socket?.onerror()}catch(e){}}}))):t++:(t=0,n=!1)}),3e3),(async()=>{let e=0;me.roaming.sideLoadedScript.forEach((([t,n,i])=>{if(!i){let t=document.createElement("script");t.src=n,window.document.body.appendChild(t),e++}})),e>0&&ee("iiroseForge plug-in",`已在iframe外部侧载 ${e} 个js脚本`)})()}else if("/messages.html"==location.pathname){if(console.log("[iiroseForge] iiroseForge需要注入至主上下文中"),"iirose.com"==parent?.location?.host&&"/"==parent?.location?.pathname){let e=parent.document,t=e.createElement("script");t.text=le,e.body.appendChild(t),console.log("[iiroseForge] 修正注入")}}else console.log("[iiroseForge] 已阻止注入 iiroseForge需要注入至根页面的主上下文中");else console.log("[iiroseForge] 已阻止注入 iiroseForge仅支持蔷薇花园(iirose.com)")}();
