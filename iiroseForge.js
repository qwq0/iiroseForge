!function(){"use strict";function e(e,t){return(...i)=>{if(1!=t(i,e))return e(...i)}}function t(e,t,i=!1){let n=0,a=Date.now(),s=null,r=()=>{n++;try{return e(n,Date.now()-a),void(null!=s&&clearInterval(s))}catch(e){}};s=setInterval(r,t),i&&r()}let i={iframeWindow:null,iframeDocument:null,socket:null,iframeBody:null,socketApi:{send:()=>{}}};const n=Symbol("serialization function"),a=Symbol("deserialization function"),s=new Set;[Set,Map].forEach((e=>{s.add(e)}));const r=new TextEncoder,o=new TextDecoder("utf-8");class l{arr=new Uint8Array(128);endInd=0;push(e){if(this.endInd>=this.arr.length){let e=this.arr;this.arr=new Uint8Array(2*this.arr.length),this.arr.set(e)}this.arr[this.endInd++]=e}pushArr(e){if(this.endInd+e.length>this.arr.length){let t=this.arr,i=2*t.length;for(;this.endInd+e.length>i;)i*=2;this.arr=new Uint8Array(i),this.arr.set(t)}this.arr.set(e,this.endInd),this.endInd+=e.length}}class c{nameToClass=new Map;classToName=new Map;nameToSFunction=new Map;sFunctionToName=new Map;addClass(e,t){this.nameToClass.set(e,t),this.classToName.set(t,e)}addSafetyFunction(e,t){this.nameToSFunction.set(e,t),this.sFunctionToName.set(t,e)}encode(e){let t=new l;const i=e=>{for(;;){let i=127&e;if(!(e>>>=7))return void t.push(128|i);t.push(i)}},a=e=>{let n=r.encode(e);i(n.byteLength),t.pushArr(n)};let o=-1,d=new Map;const h=e=>{switch(++o,d.has(e)||d.set(e,o),typeof e){case"number":Number.isInteger(e)?(t.push(1),i(e)):(t.push(2),t.pushArr(new Uint8Array(new Float64Array([e]).buffer)));break;case"string":t.push(3),a(e);break;case"object":if(null==e)t.push(11);else if(d.get(e)<o)t.push(14),i(d.get(e));else if(Array.isArray(e))t.push(5),e.forEach(h),t.push(0);else if(this.classToName.has(Object.getPrototypeOf(e)?.constructor)){t.push(6),a(this.classToName.get(Object.getPrototypeOf(e)?.constructor));let s=e[n]?e[n].call(e):e,r=Object.getOwnPropertyNames(s);i(r.length),r.forEach((e=>{a(e),h(s[e])}))}else if(s.has(Object.getPrototypeOf(e)?.constructor))switch(t.push(15),Object.getPrototypeOf(e)?.constructor){case Map:i(1),i(e.size),e.forEach(((e,t)=>{h(t),h(e)}));break;case Set:i(2),e.forEach(h),t.push(0);break;default:t.push(7)}else{t.push(4);let n=Object.keys(e);i(n.length),n.forEach((t=>{a(t),h(e[t])}))}break;case"undefined":t.push(7);break;case"boolean":t.push(e?9:8);break;case"bigint":{let n=null;e>=0n?(t.push(12),n=e>0n?c.writeBigint(e):new Uint8Array(0)):(t.push(13),n=c.writeBigint(-e)),i(n.byteLength),t.pushArr(n);break}case"symbol":d.get(e)<o?(t.push(14),i(d.get(e))):(t.push(10),a(e.description?e.description:""));break;case"function":this.sFunctionToName.has(e)?(t.push(17),a(this.sFunctionToName.get(e))):t.push(7);break;default:throw"JSObin(encode): The type of value that cannot be processed."}};return h(e),t.arr.slice(0,t.endInd)}decode(e){let t=new DataView(e.buffer),i=0;const n=()=>{let t=0,n=0;for(;!(128&e[i]);)if(t|=e[i++]<<n,n+=7,n>32)throw"JSOBin Decode: Unexpected vint length";return t|=(127&e[i++])<<n,t},s=()=>{let t=n(),a=o.decode(e.subarray(i,i+t));return i+=t,a};let r=[];const l=o=>{if(i>=e.length)throw"JSOBin Decode: Wrong format";switch(void 0===o?e[i++]:o){case 1:{let e=n();return r.push(e),e}case 2:{let e=t.getFloat64(i,!0);return r.push(e),i+=8,e}case 3:{let e=s();return r.push(e),e}case 4:{let e={},t=n();r.push(e);for(let i=0;i<t;i++){e[s()]=l()}return e}case 5:{let t=[];for(r.push(t);e[i];)t.push(l());return i++,t}case 6:{let e=s(),t=this.nameToClass.get(e);if(null==t)throw`JSOBin Decode: (class) "${e}" is unregistered class in the current context in the parsing jsobin`;if(t?.[a]){let e=Object.create(t.prototype),i=n();r.push(e);for(let t=0;t<i;t++){e[s()]=l()}return t[a](e)}{let e=Object.create(t.prototype),i=n();r.push(e);for(let t=0;t<i;t++){e[s()]=l()}return e}}case 7:return void r.push(void 0);case 8:return r.push(!1),!1;case 9:return r.push(!0),!0;case 10:{let e=Symbol(s());return r.push(e),e}case 11:return r.push(null),null;case 12:{let t=n(),a=c.readBigInt(e,i,t);return r.push(a),i+=t,a}case 13:{let t=n(),a=c.readBigInt(e,i,t);return r.push(a),i+=t,-a}case 14:{let e=n(),t=r[e];return r.push(t),t}case 15:switch(n()){case 1:{let e=new Map,t=n();r.push(e);for(let i=0;i<t;i++){let t=l();e.set(t,l())}return e}case 2:{let t=new Set;for(r.push(t);e[i];)t.add(l());return i++,t}default:throw"JSOBin Decode: Unsupported js built-in class type."}case 16:throw"JSOBin Decode: Function is not supported in the current version";case 17:{let e=this.nameToSFunction.get(s());return r.push(e),e}default:throw"JSOBin Decode: Wrong format"}};return l()}static writeBigint(e){let t=[];for(;;)if(t.push(Number(e&BigInt(255))),0n==(e>>=8n))return new Uint8Array(t)}static readBigInt(e,t,i){let n=0n;for(let a=t+i-1;a>=t;a--)n<<=8n,n+=BigInt(e[a]);return n}}const d=new c;function h(e){if(e.startsWith("iiroseForge:")&&e.endsWith(":end")){let t=e.slice(12,-4);try{let e=t.indexOf(","),i=Number.parseInt(t.slice(0,e),36);if(Number.isNaN(i)||i<0||i>8192)return;t=t.slice(e+1);let n=t.slice(0,i);if(n.length!=i)return;let a=t.slice(i).split(",");if(!a[1]||"single"==a[1])return d.decode(function(e){let t=window.atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i}(n))}catch(e){return void console.log(e)}}}function p(e){try{let t=function(e){let t=Array.from(e).map((e=>String.fromCharCode(e))).join("");return window.btoa(t)}(d.encode(e)),i=["","single"];return`iiroseForge:${t.length.toString(36)},${t}${i.join(",")}:end`}catch(e){return}}const u={diFull:e=>"calc(100% - "+e+")",rgb:(e,t,i,n=1)=>"rgba("+e+", "+t+", "+i+", "+n+")"};function m(e,t){if(!e)return!1;for(let i=0,n=e.length;i<n;i++)if(null!=e[i]&&t(e[i],i))return!0;return!1}const g=new WeakMap,f=new FinalizationRegistry((e=>{e.destroy()}));class b{proxyObj=null;srcObj=null;keys=[];hookMap=null;ctFunc=null;constructor(e,t,i,n,a){this.proxyObj=e,this.srcObj=t,this.keys=i,this.hookMap=n,this.ctFunc=a}getValue(){return this.ctFunc?this.ctFunc(...this.keys.map((e=>this.srcObj[e]))):this.srcObj[this.keys[0]]}addHook(e){this.keys.forEach((t=>{let i=this.hookMap.get(t);null==i&&(i=new Set,this.hookMap.set(t,i)),i.add(e)}))}removeHook(e){this.keys.forEach((t=>{let i=this.hookMap.get(t);i&&(i.delete(e),0==i.size&&this.hookMap.delete(t))}))}bindToValue(e,t){return new w(this,e,t)}bindToCallback(e){return new y(this,e)}}class y{info=null;cbRef=null;callback=null;constructor(e,t){this.info=e,this.cbRef=new WeakRef(t),this.callback=t,e.addHook(this)}emit(){let e=this.cbRef.deref();if(e)try{e(this.info.getValue())}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),f.unregister(this)}bindDestroy(e){let t=g.get(e);return null==t&&(t=new Set,g.set(e,t)),t.add(this.callback),this.callback=null,f.register(e,this,this),this}}class w{info=null;targetRef=null;targetKey="";constructor(e,t,i){this.info=e,this.targetRef=new WeakRef(t),this.targetKey=i,e.addHook(this),f.register(t,this,this)}emit(){let e=this.targetRef.deref();if(null!=e)try{e[this.targetKey]=this.info.getValue()}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),f.unregister(this)}}const x=Symbol("NElement");class v{element=null;styleHooks=new Map;constructor(e){this.element=e}addChild(e){e instanceof v?this.element.appendChild(e.element):this.element.appendChild(e)}addChilds(...e){e.forEach((e=>{Array.isArray(e)?e.forEach((e=>this.addChild(e))):"object"==typeof e&&this.addChild(e)}))}insChild(e,t){let i=this.element;"number"==typeof t?t>=0||t<i.childElementCount?i.insertBefore(e.element,i.children[t]):t<0||t>=-i.childElementCount?i.insertBefore(e.element,i.children[i.childElementCount+t]):i.appendChild(e.element):i.insertBefore(e.element,t.element)}childInd(e){let t=-1;return m(this.element.children,((i,n)=>{if(i==e.element)return t=n,!0})),t}remove(){this.element.remove()}removeChilds(e=0,t=1/0){let i=this.element;t>i.childElementCount&&(t=i.childElementCount);for(let n=e;n<t;n++)i.children[e].remove()}getChilds(){return Array.from(this.element.children).map((e=>k(e)))}getChild(e){return k(this.element.children[e])}setStyle(e,t,i){i!=this.styleHooks.get(e)&&(this.styleHooks.get(e)?.destroy(),null!=i?this.styleHooks.set(e,i):this.styleHooks.delete(e)),t instanceof b?t.bindToCallback((t=>{this.setStyle(e,t,i)})).bindDestroy(this).emit():this.element.style[e]=t}getStyle(e){if("string"==typeof e)return this.element.style[e]}setStyles(e){m(Object.keys(e),(t=>{(function(e,...t){return m(t,(t=>t==e))})(typeof e[t],"number","string")&&(this.element.style[t]=e[t])}))}setText(e){this.element.innerText=e}addText(e){return this.element.appendChild(document.createTextNode(e))}setAttrs(e){m(Object.keys(e),(t=>{this.element[t]=e[t]}))}setDisplay(e){this.setStyle("display",e)}addEventListener(e,t,i){this.element.addEventListener(e,t,i)}removeEventListener(e,t,i){this.element.removeEventListener(e,t,i)}animate(e,t){this.element.animate(e,t)}asse(e){return e(this),this}getTagName(){return this.element.tagName.toLowerCase()}static byElement(e){return e[x]?e[x]:e[x]=new v(e)}}function k(e){return v.byElement(e)}function S(e){let t=k(document.createElement(e.tagName?e.tagName:"div"));return["height","width","position","top","left","right","bottom","display","overflow"].forEach((i=>{e[i]&&t.setStyle(i,e[i])})),e.style&&t.setStyles(e.style),e.text&&t.setText(e.text),e.attr&&t.setAttrs(e.attr),e.classList&&t.element.classList.add(...e.classList),e.event&&Object.keys(e.event).forEach((i=>{e.event[i]&&t.addEventListener(i,e.event[i])})),e.child&&e.child.forEach((e=>{e&&(e instanceof v?t.addChild(e):t.addChild(S(e)))})),e.assembly&&e.assembly.forEach((e=>{let i=e(t);i&&(t=i)})),t}function E(e,t){let i={},n={};return Object.keys(t).forEach((e=>i[e]=t[e])),Object.keys(e).forEach((a=>{if("child"!=a)if("$"==a[0]){let s=a.slice(1);n[s]=t[s],i[s]=t[s]=e[a]}else if("$"==a.slice(-1)){let i=a.slice(0,-1);n[i]=t[i],t[i]=e[a]}else i[a]=e[a]})),i.left&&i.right&&i.width&&delete i.width,i.top&&i.bottom&&i.height&&delete i.height,e.child&&(i.child=[],e.child.forEach((e=>{e&&(e instanceof v?i.child.push(e):i.child.push(E(e,t)))}))),Object.keys(n).forEach((e=>t[e]=n[e])),i}function M(e){return S(E(e,{}))}class F{eventName=null;callback=null;constructor(e,t){this.eventName=e,this.callback=t}apply(e){e.addEventListener(this.eventName,this.callback)}}class C{callback=null;constructor(e){this.callback=e}apply(e){this.callback(e)}}class L{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){if("function"==typeof this.value){let t=this.value(e.element[this.key]);null!=t&&(e.element[this.key]=t)}else e.element[this.key]=this.value}}class P{tagName=null;constructor(e){this.tagName=e.toLowerCase()}}class j{list=null;flatFlag=!1;constructor(e){this.list=e}apply(e){const t=e.getTagName();this.list.forEach((i=>{if("string"==typeof i)e.addText(i);else switch(Object.getPrototypeOf(i)?.constructor){case b:{const t=i,n=e.addText(t.getValue());t.bindToValue(n,"data");break}case P:if(t!=i.tagName)throw"(NList) The feature tagName does not match the element";break;case O:case L:case F:case C:i.apply(e);break;case v:e.addChild(i);break;case j:{const t=i;t.flatFlag?t.apply(e):e.addChild(t.getElement());break}case Array:e.addChild(j.getElement(i));break;default:throw"(NList) Untractable feature types were found"}}))}getTagName(){let e="";return this.list.forEach((t=>{let i="";if(t instanceof P?i=t.tagName:t instanceof j&&t.flatFlag&&(i=t.getTagName()),i)if(e){if(e!=i)throw"(NList) Multiple TagNames exist in a feature list"}else e=i})),e}getElement(){let e=this.getTagName();""==e&&(e="div");let t=k(document.createElement(e));return this.apply(t),t}static flat(e){let t=new j(e);return t.flatFlag=!0,t}static getElement(e){return new j(e).getElement()}}class O{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){e.setStyle(this.key,this.value)}}function I(e,t){return new O(e,t)}function T(e){return j.flat(Object.keys(e).map((t=>new O(t,e[t]))))}class W{x=0;y=0;vx=0;vy=0;sx=0;sy=0;hold=!1;pressing=!1;constructor(e,t,i,n,a,s,r,o){this.x=e,this.y=t,this.vx=i,this.vy=n,this.sx=a,this.sy=s,this.hold=r,this.pressing=o}}function N(e,t,i=0){e.addEventListener("mousedown",(e=>function(e){e.cancelable&&e.preventDefault();o=s=e.clientX,l=r=e.clientY,window.addEventListener("mousemove",n,!0),window.addEventListener("mouseup",a,!0),e.button==i&&(c=!0,t(new W(s,r,0,0,s,r,!0,!0)))}(e)),!1);let n=e=>function(e){if(c){let i=e.clientX-s,n=e.clientY-r;s=e.clientX,r=e.clientY,t(new W(s,r,i,n,o,l,!0,!1))}}(e),a=e=>function(e){let d=e.clientX-s,h=e.clientY-r;s=e.clientX,r=e.clientY,window.removeEventListener("mousemove",n,!1),window.removeEventListener("mouseup",a,!1),c&&e.button==i&&(c=!1,t(new W(s,r,d,h,o,l,!1,!1)))}(e),s=0,r=0,o=0,l=0,c=!1}function A(e,t){e.addEventListener("touchstart",(e=>function(e){e.cancelable&&e.preventDefault();m(e.changedTouches,(e=>{let n={id:e.identifier,sx:e.clientX,sy:e.clientY,x:e.clientX,y:e.clientY};i.push(n),t(new W(n.x,n.y,0,0,n.sx,n.sy,!0,!0))}))}(e)),{capture:!1,passive:!1}),e.addEventListener("touchmove",(e=>function(e){m(e.changedTouches,(e=>{let a=n(e.identifier);if(a>-1){let n=i[a],s=e.clientX-n.x,r=e.clientY-n.y;n.x=e.clientX,n.y=e.clientY,t(new W(n.x,n.y,s,r,n.sx,n.sy,!0,!1))}}))}(e)),{capture:!1,passive:!0}),e.addEventListener("touchend",(e=>function(e){e.changedTouches,m(e.changedTouches,(e=>{let a=n(e.identifier);if(a>-1){let n=i[a];i.splice(a,1);let s=e.clientX-n.x,r=e.clientY-n.y;n.x=e.clientX,n.y=e.clientY,t(new W(n.x,n.y,s,r,n.sx,n.sy,!1,!1))}}))}(e)),{capture:!1,passive:!0});let i=[];function n(e){let t=-1;return i.forEach(((i,n)=>{e==i.id&&(t=n)})),t}}let z=k(document.body);function H(e){e.setStyle("transition","transform 50ms linear, text-shadow 150ms linear"),e.addEventListener("mousedown",(()=>{e.setStyle("transform","scale(0.95) translateY(2px)")})),e.addEventListener("mouseup",(()=>{e.setStyle("transform","")})),e.addEventListener("mouseenter",(()=>{e.setStyle("textShadow",`0 0 0.3em ${u.rgb(255,255,255,.5)}`),e.setStyle("transform","translateY(-1px)")})),e.addEventListener("mouseleave",(()=>{e.setStyle("textShadow",""),e.setStyle("transform","")}))}z.setStyle("cursor","default");var B=M({position:"absolute",right:"0px",style:{userSelect:"none",pointerEvents:"none",zIndex:"30000"}});function R(e,t,i="iiroseForge",n=null){let a=M({style:{backgroundColor:u.rgb(255,255,255,.95),marginRight:"1em",marginTop:"1em",marginLeft:"1em",float:"right",clear:"both",overflow:"hidden hidden",padding:"1em",boxSizing:"border-box",minWidth:"180px",borderRadius:"0.2em",boxShadow:`${u.rgb(0,0,0,.5)} 5px 5px 10px`},position:"relative",child:[{tagName:"i",classList:["fa","fa-info-circle"]},{text:e,style:{fontSize:"1.2em",lineHeight:"1.5em",fontWeight:"bolder"}},{text:t},{text:i,style:{fontSize:"0.9em",float:"right"}},{text:"×",position:"absolute",right:"4px",top:"1px",assembly:[H],style:{fontSize:"25px",lineHeight:"1em"},event:{click:e=>{e.stopPropagation(),r()}}}]});B.addChild(a),a.animate([{transform:"translateX(180%) translateY(10%) scale(0.6)"},{}],{duration:180}),setTimeout((()=>{a.setStyle("pointerEvents","auto")}),180);let s=!1;function r(){s||(s=!0,a.setStyle("pointerEvents","none"),a.animate([{},{transform:"translateX(180%)"}],{duration:270,fill:"forwards"}),setTimeout((()=>{a.setStyle("visibility","hidden"),a.animate([{height:a.element.clientHeight+"px"},{marginTop:0,height:0,padding:0}],{duration:150,fill:"forwards"}),setTimeout((()=>{a.remove()}),150)}),270))}setTimeout((()=>{r()}),3900+Math.min(1e4,115*t.length)),n&&(a.asse(H),a.addEventListener("click",(()=>{s||(n(),r())})))}z.addChild(B);let U=class{cbList=[];onceCbList=[];add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((async t=>{t(e)})),this.onceCbList.forEach((async t=>{t(e)})),this.onceCbList=[]}};const D={state:{plug:null},operation:{showForgeNotice:(e,t)=>{R("插件提示",e=String(e),`插件 ${D.state.plug?.name}`,t)},getUserName:()=>i.iframeWindow?.myself2?i.iframeWindow.myself2:null,getUserUid:()=>i.iframeWindow?.uid?i.iframeWindow.uid:null,getUserRoomId:()=>i.iframeWindow?.roomn?i.iframeWindow.roomn:null,getUserProfilePictureUrl:()=>i.iframeWindow?.avatar2&&i.iframeWindow?.avatarconv?i.iframeWindow.avatarconv(i.iframeWindow.avatar2):null,getUserInputColor:()=>i.iframeWindow?.inputcolorhex?i.iframeWindow.inputcolorhex:null,sendRoomMessage:e=>{(e=String(e))&&i.socketApi.send(JSON.stringify({m:e,mc:D.operation.getUserInputColor(),i:String(Date.now()).slice(-5)+String(Math.random()).slice(-7)}))},sendRoomForgePacket:e=>{D.operation.sendRoomMessage(p(e))},sendPrivateMessageSilence:(e,t)=>{e=String(e),(t=String(t))&&e&&i.socketApi.send(JSON.stringify({g:e,m:t,mc:D.operation.getUserInputColor(),i:String(Date.now()).slice(-5)+String(Math.random()).slice(-7)}))},sendPrivateMessage:(e,t)=>{if(e=String(e),!((t=String(t))&&e&&i.iframeWindow?.msgfetch&&i.iframeWindow?.Variable?.pmObjJson&&i.iframeWindow?.Utils?.service?.buildPmHelper))return;let n=i.iframeDocument.getElementById("moveinput"),a=n.value,s=i.iframeWindow.pmFull;n.value=t,i.iframeWindow.pmFull=!0,i.iframeWindow.Variable.pmObjJson?.[e]||i.iframeWindow.Utils.service.buildPmHelper(1,e,e),i.iframeWindow.msgfetch(0,i.iframeWindow.Variable.pmObjJson?.[e],e,""),i.iframeWindow.pmFull=s,n.value=a},sendSelfPrivateMessageSilence:e=>{D.operation.sendPrivateMessageSilence(D.operation.getUserUid(),e)},giveALike:(e,t="")=>{e=String(e),t=String(t),e&&i.socketApi.send(`+*${e}${t?" "+t:""}`)},switchRoom:e=>{e=String(e),i.iframeWindow?.Objs?.mapHolder?.function?.roomchanger&&i.iframeWindow.Objs.mapHolder.function.roomchanger(e)},runTerminalCommand:e=>{!function(e){i.iframeWindow?.Probe?.init?.shellHolder&&i.iframeWindow?.Init?.movePanel(6);let t=function(e,t){let i=e;return[2,0,-1,0].every((e=>(e<0&&(e+=i.childNodes.length),!!i.childNodes[e]&&(i=i.childNodes[e],!0)))),i}(i.iframeDocument.getElementById("shellHolder")),n=t.value;t.value=e,t.oninput(null),t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13})),t.value=n}(e=String(e))},sendCurrentPageMessage:e=>{!function(e){var t=document.getElementById("moveinput"),i=t.value;t.value=e,t.oninput(null),document.getElementsByClassName("moveinputSendBtn")[0]?.onclick(null),t.value=i}(e=String(e))}},event:{roomMessage:new U,privateMessage:new U,selfPrivateMessage:new U,roomForgePacket:new U}};window.iiroseForgeApi=D;let $="https://qwq0.github.io/iiroseForge/l.js",J=`<script type="text/javascript" src="${$}"><\/script>`;async function Y(){let e=await caches.open("v"),t=await caches.match("/");if(t){let i=await t.text();if(i.indexOf(J)>-1)return;let n=i.lastIndexOf("</body></html>");if(-1==n)return;let a=i.slice(0,n)+J+i.slice(n);await e.put("/",new Response(new Blob([a],{type:"text/html"}),{status:200,statusText:"OK"}))}else{let t=["<!DOCTYPE html>","<html>","<head>","</head>","<body>","<script>","(async() => {",'let cache = await caches.open("v");','await cache.delete("/");','let cacheMainPage = await (await fetch("/",{cache:"no-cache"})).text();','let insertIndex = cacheMainPage.lastIndexOf("</body></html>");',"let newCacheMainPage = (insertIndex == -1 ? cacheMainPage : (cacheMainPage.slice(0, insertIndex) + `<script` + ",`\` type="text/javascript" src="${$}"><\` + \`/script>\` + cacheMainPage.slice(insertIndex)));`,'await cache.put("/", new Response(new Blob([newCacheMainPage], { type: "text/html" }), { status: 200, statusText: "OK" }));',"location.reload();","})();","<\/script>","</body>","</html>"].join("");await e.put("/",new Response(new Blob([t],{type:"text/html"}),{status:200,statusText:"OK"}))}}"true"==localStorage.getItem("installForge")&&Y();class X{#e=new _;addPath(e,t){this.#e.addPath(e,0,t)}matchPrefix(e){return this.#e.matchPrefix(e,0)}}class _{#t=new Map;#i=null;addPath(e,t,i){if(t>=e.length)this.#i=i;else{let n=this.#t.get(e[t]);null==n&&(n=new _,this.#t.set(e[t],n)),n.addPath(e,t+1,i)}}matchPrefix(e,t){if(t>=e.length)return this.#i?.("",e);{let i=this.#t.get(e[t]);return null!=i?i.matchPrefix(e,t+1):this.#i?.(e.slice(t),e)}}}let V=new X,K=new X,q=[""];K.addPath('"',(e=>{q[0]='"'+e.split("<").reverse().map((e=>{let t=e.split(">");if("s"!=t[4]&&"'"!=t[3][0]){let e=t[8],i=t[2],n=t[3],a=h(n);if(null!=a)return void D.event.roomForgePacket.trigger({senderId:e,senderName:i,content:a});D.event.roomMessage.trigger({senderId:e,senderName:i,content:n})}return e})).filter((e=>null!=e)).reverse().join("<")})),K.addPath('""',(e=>{let t=D.operation.getUserUid();q[0]='""'+e.split("<").map((e=>{let i=e.split(">");if(""==i[6]){let e=i[1],n=i[2],a=i[4];i[1]!=t?D.event.privateMessage.trigger({senderId:e,senderName:n,content:a}):i[1]==t&&i[11]==t&&D.event.selfPrivateMessage.trigger({content:i[4]})}return e})).filter((e=>null!=e)).join("<")})),V.addPath("{",((e,t)=>{try{let e=JSON.parse(t),i=JSON.stringify(e);"{"==i[0]&&(q[0]=i)}catch(e){}}));const G={iiroseForge:{plugInfo:[],sideLoadedScript:[]}};function Q(){try{let e=JSON.stringify(G.iiroseForge);localStorage.setItem("iiroseForge",e)}catch(e){R("错误","无法写入储存 这可能导致iiroseForge配置丢失")}}const Z={version:"alpha v1.1.6"};let ee='!function(){"use strict";function e(e=2){var t=Math.floor(Date.now()).toString(36);for(let a=0;a<e;a++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}function t(t,a){let r=new Map;let n=function t(n){if("function"==typeof n){let t={},s=e();return a.set(s,n),r.set(t,s),t}if("object"==typeof n){if(Array.isArray(n))return n.map(t);{let e={};return Object.keys(n).forEach((a=>{e[a]=t(n[a])})),e}}return n}(t);return{result:n,fnMap:r}}const a=new FinalizationRegistry((({id:e,port:t})=>{t.postMessage({type:"rF",id:e})}));function r(r,n,s,i,o){let p=new Map;n.forEach(((r,n)=>{if(!p.has(r)){let n=(...a)=>new Promise(((n,p)=>{let l=t(a,i),d=e();i.set(d,n),o.set(d,p),s.postMessage({type:"fn",id:r,param:l.result,fnMap:l.fnMap.size>0?l.fnMap:void 0,cb:d})}));p.set(r,n),a.register(n,{id:r,port:s})}}));const l=e=>{if("object"==typeof e){if(n.has(e))return p.get(n.get(e));if(Array.isArray(e))return e.map(l);{let t={};return Object.keys(e).forEach((a=>{t[a]=l(e[a])})),t}}return e};return{result:l(r)}}(()=>{let e=null,a=new Map,n=new Map;window.addEventListener("message",(s=>{"setMessagePort"==s.data&&null==e&&(e=s.ports[0],Object.defineProperty(window,"iframeSandbox",{configurable:!1,writable:!1,value:{}}),e.addEventListener("message",(async s=>{let i=s.data;switch(i.type){case"execJs":new Function(...i.paramList,i.js)(i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param);break;case"fn":if(a.has(i.id)){let s=i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param;try{let r=await a.get(i.id)(...s);if(i.cb){let n=t(r,a);e.postMessage({type:"sol",id:i.cb,param:[n.result],fnMap:n.fnMap.size>0?n.fnMap:void 0})}}catch(t){i.cb&&e.postMessage({type:"rej",id:i.cb,param:[t]})}}break;case"rF":a.delete(i.id);break;case"sol":{let t=i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param;a.has(i.id)&&a.get(i.id)(...t),a.delete(i.id),n.delete(i.id);break}case"rej":n.has(i.id)&&n.get(i.id)(...i.param),a.delete(i.id),n.delete(i.id)}})),e.start(),e.postMessage({type:"ready"}))})),window.addEventListener("load",(e=>{console.log("sandbox onload")}))})()}();';function te(e=2){var t=Math.floor(Date.now()).toString(36);for(let i=0;i<e;i++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}function ie(e,t){let i=new Map;let n=function e(n){if("function"==typeof n){let e={},a=te();return t.set(a,n),i.set(e,a),e}if("object"==typeof n){if(Array.isArray(n))return n.map(e);{let t={};return Object.keys(n).forEach((i=>{t[i]=e(n[i])})),t}}return n}(e);return{result:n,fnMap:i}}const ne=new FinalizationRegistry((({id:e,port:t})=>{t.postMessage({type:"rF",id:e})}));function ae(e,t,i,n,a){let s=new Map;t.forEach(((e,t)=>{if(!s.has(e)){let t=(...t)=>new Promise(((s,r)=>{let o=ie(t,n),l=te();n.set(l,s),a.set(l,r),i.postMessage({type:"fn",id:e,param:o.result,fnMap:o.fnMap.size>0?o.fnMap:void 0,cb:l})}));s.set(e,t),ne.register(t,{id:e,port:i})}}));const r=e=>{if("object"==typeof e){if(t.has(e))return s.get(t.get(e));if(Array.isArray(e))return e.map(r);{let t={};return Object.keys(e).forEach((i=>{t[i]=r(e[i])})),t}}return e};return{result:r(e)}}class se{cbList=[];onceCbList=[];add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((t=>{t(e)})),this.onceCbList.forEach((t=>{t(e)})),this.onceCbList=[]}}class re{#n=null;#a=null;#s=!1;#r=!1;#o=new AbortController;#l=new se;apiObj={};#c=new Map;#d=new Map;constructor(e=document.body){if(!("sandbox"in HTMLIFrameElement.prototype)||!Object.hasOwn(HTMLIFrameElement.prototype,"contentDocument"))throw"sandbox property are not supported";let t=document.createElement("iframe");t.sandbox.add("allow-scripts"),t.style.display="none",t.srcdoc=["<!DOCTYPE html>","<html>","<head>",'<meta charset="utf-8" />',"<title>iframe sandbox</title>",'<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />',"</head>","<body>","<script>",ee,"<\/script>","</body>","</html>"].join("");let i=new MessageChannel,n=i.port1;n.addEventListener("message",(async e=>{let t=e.data;switch(t.type){case"ready":this.#s=!0,this.#l.trigger();break;case"fn":if(this.#c.has(t.id)){let e=t.fnMap?ae(t.param,t.fnMap,n,this.#c,this.#d).result:t.param;try{let i=await this.#c.get(t.id)(...e);if(t.cb){let e=ie(i,this.#c);n.postMessage({type:"sol",id:t.cb,param:[e.result],fnMap:e.fnMap.size>0?e.fnMap:void 0})}}catch(e){t.cb&&n.postMessage({type:"rej",id:t.cb,param:[e]})}}break;case"rF":this.#c.delete(t.id);break;case"sol":{let e=t.fnMap?ae(t.param,t.fnMap,n,this.#c,this.#d).result:t.param;this.#c.has(t.id)&&this.#c.get(t.id)(...e),this.#c.delete(t.id),this.#d.delete(t.id);break}case"rej":this.#d.has(t.id)&&this.#d.get(t.id)(...t.param),this.#c.delete(t.id),this.#d.delete(t.id)}}),{signal:this.#o.signal}),t.addEventListener("load",(()=>{if(!this.#s&&!this.#r){if(t.contentDocument)throw"sandbox isolation failed";n.start(),t.contentWindow.postMessage("setMessagePort","*",[i.port2])}}),{signal:this.#o.signal}),e.appendChild(t),this.#n=t,this.#a=n}async waitAvailable(){return new Promise(((e,t)=>{this.#s?e():this.#l.addOnce(e)}))}async execJs(e){this.#s||await this.waitAvailable();let t=ie(this.apiObj,this.#c);this.#a.postMessage({type:"execJs",js:e,param:t.result,fnMap:t.fnMap.size>0?t.fnMap:void 0,paramList:["api"]})}get iframe(){return this.#n}destroy(){this.#r||(this.#r=!0,this.#n.remove(),this.#n=null,this.#o.abort(),this.#o=null,this.#a.close(),this.#a=null,this.#c=null,this.#d=null,this.#l.removeAll(),this.#l=null,this.#s=!1)}}const oe={operation:{showForgeNotice:"显示forge通知",getUserName:"获取你的昵称",getUserUid:"获取你的uid",getUserRoomId:"获取所在房间id",getUserProfilePictureUrl:"获取你的头像",getUserInputColor:"获取你的主题色",sendRoomMessage:"在房间中发送信息",sendRoomForgePacket:"在房间中发送forge数据包",sendPrivateMessageSilence:"[危险]静默发送私聊消息",sendPrivateMessage:"[危险]发送私聊消息",sendSelfPrivateMessageSilence:"向自己静默发送私聊消息(同账号多设备间通信)",giveALike:"进行点赞",switchRoom:"切换所在房间"},event:{roomMessage:"接收房间消息",roomForgePacket:"接收房间forge数据包",privateMessage:"[危险]接收私聊消息",selfPrivateMessage:"接收自己(其他设备)发送给自己的私聊消息"}};function le(e,t,i=!1,...n){return new Promise((a=>{var s=void 0,r=M({width:"100%",height:"100%",$position:"absolute",style:{userSelect:"none",backgroundColor:u.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:u.rgb(255,255,255,.95),color:u.rgb(0,0,0),alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"35px",minHeight:"190px",minWidth:"280px",maxWidth:"95%",boxSizing:"border-box",padding:"20px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120)},e=>{s=e}],position$:"static",display:"flex",child:[{text:e},{text:t},...n,{text:"确定",assembly:[H],event:{click:()=>{o(),a(!0)}}},i?{text:"取消",assembly:[H],event:{click:()=>{o(),a(!1)}}}:null]}]});function o(){s.setStyle("pointerEvents","none"),s.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),r.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{r.remove()}),120)}z.addChild(r)}))}async function ce(e,t,i=!1,n=""){var a=M({tagName:"input",assembly:[H],style:{textAlign:"center",margin:"15px"},attr:{value:n}});return a.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),await le(e,t,i,a)?a.element.value:void 0}async function de(e,t,i){let{sandbox:n,windowElement:a}=function(){let e=0,t=0,i=280,n=190,a=null,s=null,r=null,o=null,l=j.getElement([T({display:"none",position:"fixed",overflow:"hidden",border:"1px white solid",backgroundColor:"rgba(30, 30, 30, 0.85)",backdropFilter:"blur(2px)",color:"rgba(255, 255, 255)",alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"1.1em",boxSizing:"border-box",padding:"10px",borderRadius:"3px",pointerEvents:"none",resize:"both",boxShadow:"rgba(0, 0, 0, 0.5) 5px 5px 10px",zIndex:"20001",height:"190px",width:"280px"}),["plug-in",T({position:"absolute",left:"0",top:"0",right:"0",cursor:"move",lineHeight:"1.5em",backgroundColor:"rgba(100, 100, 100, 0.2)"}),new C((i=>{var n=0,a=0,s=i=>{i.hold?(i.pressing&&(n=e,a=t),e=n+i.x-i.sx,t=a+i.y-i.sy,e<0?e=0:e>=z.element.clientWidth-l.element.offsetWidth&&(e=z.element.clientWidth-l.element.offsetWidth),t<0?t=0:t>=z.element.clientHeight-l.element.offsetHeight&&(t=z.element.clientHeight-l.element.offsetHeight),l.setStyle("left",`${e}px`),l.setStyle("top",`${t}px`),o.setStyle("pointerEvents","none")):o.setStyle("pointerEvents","auto")};N(i,s),A(i,s)})),new F("touchend",(()=>{null!=a?(clearTimeout(a),a=null):s.setDisplay("block"),a=setTimeout((()=>{a=null,s.setDisplay("none")}),2500)}))],["-",T({position:"absolute",right:"4px",top:"1px",cursor:"default",fontSize:"1.5em",lineHeight:"1em"}),new F("click",(()=>{l.setDisplay("none")}))],[T({position:"absolute",top:"1.5em",bottom:"0",left:"0",right:"0",overflow:"auto"}),new C((e=>{r=e}))],[T({position:"absolute",right:"0.5px",bottom:"0.5px",height:"1.5em",aspectRatio:"1",cursor:"nwse-resize",display:"none",boxSizing:"border-box",borderRight:"0.75em blue solid",borderBottom:"0.75em blue solid",borderTop:"0.75em transparent solid",borderLeft:"0.75em transparent solid"}),new F("click",(()=>{l.setDisplay("none")})),new C((e=>{s=e})),new C((e=>{var t=0,a=0,s=e=>{e.hold?(e.pressing&&(t=i,a=n),i=t+e.x-e.sx,n=a+e.y-e.sy,l.setStyle("width",`${i}px`),l.setStyle("height",`${n}px`),o.setStyle("pointerEvents","none")):o.setStyle("pointerEvents","auto")};N(e,s),A(e,s)}))]]);z.addChild(l),new ResizeObserver((()=>{i=l.element.offsetWidth,n=l.element.offsetHeight,e>z.element.clientWidth-i&&l.setStyle("width",(i=z.element.clientWidth-e)+"px"),t>z.element.clientHeight-n&&l.setStyle("height",(n=z.element.clientHeight-t)+"px"),e<0&&(e=0,l.setStyle("left",`${e}px`)),t<0&&(t=0,l.setStyle("top",`${t}px`))})).observe(l.element);let c=new re(r.element);return o=k(c.iframe),o.setStyles({display:"block",border:"none",height:"100%",width:"100%"}),{windowElement:l,sandbox:c}}();await n.waitAvailable();let s=i?.operationPermissionSet?i?.operationPermissionSet:new Set,r=i?.eventPermissionSet?i?.eventPermissionSet:new Set,o={applyPermission:async(t,i)=>{if(t=t.filter((e=>Boolean(oe.operation[e]))),i=i.filter((e=>Boolean(oe.event[e]))),t.every((e=>s.has(e)))&&i.every((e=>r.has(e))))return!0;let n=await le("权限申请",[`是否允许 ${e} 获取以下权限?`,...t.map((e=>"+ "+oe.operation[e])),...i.map((e=>"+ "+oe.event[e]))].join("\n"),!0);return n&&(t.forEach((e=>{oe.operation[e]&&s.add(e)})),i.forEach((e=>{oe.event[e]&&r.add(e)})),he.savePlugList()),!!n}};Object.keys(D.operation).forEach((t=>{oe.operation[t]&&(o[t]=(...i)=>{if(s.has(t))try{D.state.plug={name:e};let n=D.operation[t](...i);return D.state.plug=null,n}catch(e){return void(D.state.plug=null)}})})),o.addEventListener=(e,t)=>{oe.event[e]&&D.event[e]&&r.has(e)&&D.event[e].add(t)},n.apiObj={iiroseForge:o};let l="document.body.innerHTML='<div style=\"color:white\">network_error</div>';";try{l=await(await fetch(t)).text()}catch(e){}return n.execJs(l),{sandbox:n,windowElement:a,operationPermissionSet:s,eventPermissionSet:r}}const he=new class{map=new Map;async addPlug(e,t,i){this.map.has(e)||this.map.set(e,{url:t,...await de(e,t,i)})}showPlugWindow(e){if(this.map.has(e)){let t=this.map.get(e).windowElement;t.setDisplay("block"),t.setStyle("pointerEvents","auto")}}removePlug(e){this.map.has(e)&&(this.map.get(e).sandbox.destroy(),this.map.delete(e))}savePlugList(){let e=[];this.map.forEach(((t,i)=>{e.push([i,t.url,Array.from(t.operationPermissionSet.values()),Array.from(t.eventPermissionSet.values())])})),G.iiroseForge.plugInfo=e,Q()}readPlugList(){try{let e=G.iiroseForge.plugInfo;e.length>0&&(e.forEach((([e,t,i,n])=>{this.addPlug(e,t,{operationPermissionSet:new Set(i),eventPermissionSet:new Set(n)})})),R("iiroseForge plug-in",`已加载 ${e.length} 个插件`))}catch(e){}}};function pe(e){let t=e.split(" ");return new C((e=>{t.forEach((t=>{e.element.classList.add(t)}))}))}function ue(e){return new Promise((t=>{var i=null,n=M({width:"100%",height:"100%",$position:"absolute",style:{userSelect:"none",backgroundColor:u.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:u.rgb(255,255,255,.95),color:u.rgb(0,0,0),alignItems:"stretch",justifyContent:"center",flexFlow:"column",lineHeight:"45px",minHeight:"10px",minWidth:"280px",maxHeight:"100%",maxWidth:"95%",boxSizing:"border-box",padding:"10px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120),e.getChilds().forEach((e=>{e.addEventListener("click",a),H(e)}))},e=>{i=e}],position$:"static",overflow:"auto",child:e,event:{click:e=>{e.stopPropagation()}}}],event:{click:a}});function a(){i.setStyle("pointerEvents","none"),i.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),n.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{n.remove()}),120)}z.addChild(n)}))}function me(){let e=j.getElement([I("position","fixed"),I("top","0"),I("left","0"),I("zIndex","91000"),I("height","100%"),I("width","100%"),I("backgroundColor","rgba(255, 255, 255, 0.75)"),I("backdropFilter","blur(3px)"),[I("opacity","0.8"),I("backgroundColor","#303030"),I("width","100%"),I("boxShadow","0 0 1px rgb(0, 0, 0, 0.12), 0 1px 1px rgb(0, 0, 0, 0.24)"),I("zIndex","2"),I("fontFamily","md"),I("height","40px"),I("lineHeight","40px"),I("fontSize","26px"),I("padding","0 16px 0 16px"),I("whiteSpace","nowrap"),I("boxSizing","border-box"),I("position","relative"),I("color","#fff"),[pe("mdi-anvil"),T({display:"inline",opacity:"0.8",backgroundColor:"#303030",boxShadow:"0 0 1px rgb(0,0,0,0.12), 0 1px 1px rgb(0,0,0,0.24)",zIndex:"2",fontFamily:"md",height:"40px",lineHeight:"40px",fontSize:"26px",padding:"0 0 0 0",whiteSpace:"nowrap",boxSizing:"border-box",position:"relative",color:"#fff"})],[I("display","inline"),I("fontSize","16px"),I("opacity","0.7"),I("fontWeight","bold"),I("marginLeft","16px"),I("height","100%"),I("lineHeight","40px"),I("display","inline"),I("verticalAlign","top"),`欢迎使用 iirose-Forge   version ${Z.version}`]],[I("position","absolute"),I("width","100%"),I("top","40px"),I("bottom","40px"),[...[{title:"管理插件",text:"管理插件",icon:"puzzle",onClick:async()=>{ue([j.getElement(["[ 添加插件 ]",new F("click",(async()=>{let e=await ce("添加插件","请输入插件地址\n插件会自动进行更新",!0);null!=e&&(await he.addPlug(e,e),he.savePlugList())}))]),...Array.from(he.map.keys()).map((e=>j.getElement([`${e}`,new F("click",(async()=>{ue([j.getElement(["显示插件窗口",new F("click",(()=>{he.showPlugWindow(e)}))]),j.getElement(["移除插件",new F("click",(()=>{he.removePlug(e),he.savePlugList()}))])])}))])))])}},{title:"侧载脚本",text:"管理侧载js",icon:"script",onClick:async()=>{await le("警告",["! 侧载外部脚本是高危操作 !","侧载的脚本不接受forge权限管理","外部脚本能获取您在此网站的所有信息","恶意外部脚本可能盗取您的账号","请勿加载他人提供的闭源脚本","继续操作前 您应该了解自己正在做什么"].join("\n")),ue([j.getElement(["[ 添加iframe外侧侧载脚本 ]",new F("click",(async()=>{let e=await ce("添加侧载脚本","请输入脚本地址\n每次载入会重新获取脚本\n脚本将随forge启动运行",!0);null!=e&&(G.iiroseForge.sideLoadedScript.push([e,e,!1]),Q(),R("添加侧载脚本","已将脚本添加到侧载列表\n将在下次重启时生效"))}))]),j.getElement(["[ 添加iframe内侧侧载脚本 ]",new F("click",(async()=>{let e=await ce("添加侧载脚本","请输入脚本地址\n每次载入会重新获取脚本\n脚本将随iframe重载运行",!0);null!=e&&(G.iiroseForge.sideLoadedScript.push([e,e,!0]),Q(),R("添加侧载脚本","已将脚本添加到侧载列表\n将在下次重启或iframe重载时生效"))}))]),...G.iiroseForge.sideLoadedScript.map((([e,t,i],n)=>j.getElement([`${i?"内":"外"} | ${e}`,new F("click",(async()=>{ue([j.getElement(["移除插件",new F("click",(()=>{G.iiroseForge.sideLoadedScript.splice(n,1),Q(),R("删除侧载脚本","已将脚本从侧载列表移除\n将在下次重启时生效")}))])])}))])))])}},{title:"安装iiroseForge",text:"下次使用无需注入",icon:"puzzle",onClick:async()=>{localStorage.setItem("installForge","true"),Y(),le("安装iiroseForge","已完成")}},{title:"卸载iiroseForge",text:"下次启动清除iiroseForge",icon:"puzzle",onClick:async()=>{localStorage.removeItem("installForge"),async function(){let e=await caches.open("v"),t=await(await caches.match("/")).text(),i=t.indexOf(J);if(-1==i)return;let n=t.slice(0,i)+t.slice(i+J.length);await e.put("/",new Response(new Blob([n],{type:"text/html"}),{status:200,statusText:"OK"}))}(),le("卸载iiroseForge","已完成")}}].map((e=>[pe("commonBox"),I("maxWidth","calc(100% - 24px)"),I("minWidth","355.2px"),I("minHeight","200px"),I("float","left"),I("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),I("margin","24px 12px 0px 12px"),I("position","relative"),[pe("commonBoxHead"),I("backgroundColor","rgba(255,255,255,0.2)"),I("color","rgba(0,0,0,0.4)"),I("height","100px"),I("width","100%"),I("display","flex"),I("justifyContent","center"),I("padding","0 24px"),I("boxSizing","border-box"),[pe("mdi-"+e.icon),I("lineHeight","100px"),I("fontSize","30px"),I("fontFamily","md"),I("display","inline-block"),I("verticalAlign","top"),I("height","100%"),I("opacity","0.7")],[I("lineHeight","100px"),I("fontSize","20px"),I("display","inline-block"),I("verticalAlign","top"),I("height","100%"),I("fontWeight","bold"),I("marginLeft","22px"),I("overflow","hidden"),I("whiteSpace","pre"),I("textOverflow","ellipsis"),e.title]],[pe("textColor"),I("width","100%"),I("minHeight","100px"),I("backgroundColor","rgba(255,255,255,0.5)"),I("color","rgba(0,0,0,0.75)"),[I("fontWeight","bold"),I("width","100%"),I("height","100%"),I("lineHeight","1.8em"),I("textAlign","center"),I("padding","2.2em"),I("boxSizing","border-box"),I("whiteSpace","pre-wrap"),I("fontSize","16px"),I("color","rgba(0,0,0,0.7)"),e.text]],new F("click",e.onClick)]))]],[I("color","#303030"),I("background","#fff"),I("opacity","0.8"),I("display","flex"),I("height","40px"),I("position","absolute"),I("bottom","0"),I("width","100%"),I("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),I("zIndex","2"),...[{text:"< 返回",onClick:()=>{e.remove()}}].map((e=>[I("width","0"),I("flexGrow","1"),I("justifyContent","center"),I("padding","0 24px"),I("boxSizing","border-box"),new F("click",e.onClick),[],[I("display","inline-block"),I("verticalAlign","top"),I("height","100%"),I("fontWeight","bold"),I("marginLeft","22px"),I("fontSize","14px"),I("lineHeight","40px"),I("overflow","hidden"),I("whiteSpace","pre"),I("textOverflow","ellipsis"),e.text]]))]]);return e.element.id="iiroseForgeMenu",e}function ge(){t((()=>{let t=document.getElementById("mainFrame"),n=t.contentWindow,a=t.contentDocument;if(!n.iiroseForgeInjected){if(null!=n.socket.__onmessage||null==n.socket._onmessage||null==n.socket._send)throw"main iframe is not ready";(()=>{let e=k(a.getElementById("functionHolder").childNodes[0]),t=function(){let e=j.getElement([I("background","#fff"),I("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),I("position","relative"),I("zIndex","1"),I("color","#212121"),I("paddingLeft","16px"),I("paddingRight","56px"),I("transition","background-color 0.1s ease 0s, color 0.1s ease 0s"),I("cursor","url(images/cursor/2.cur), pointer"),I("width","100%"),I("height","56px"),I("boxSizing","border-box"),I("lineHeight","56px"),I("whiteSpace","nowrap"),new F("click",(()=>{i.iframeWindow?.functionHolderDarker?.click(),i.iframeBody.addChild(me())})),[new P("span"),new C((e=>e.element.classList.add("functionBtnIcon","mdi-anvil")))],[new P("span"),"Forge菜单",new C((e=>e.element.classList.add("functionBtnFont")))],[new P("span"),I("transform","rotate(-90deg)"),new C((e=>e.element.classList.add("functionBtnGroupIcon")))]]);return e.element.id="iiroseForgeMenuButton",e}();e.insChild(t,1)})(),i.iframeDocument=a,i.iframeWindow=n,i.iframeBody=k(a.body),i.socket=n.socket,i.socket._onmessage=e(i.socket._onmessage.bind(i.socket),(e=>{try{if(q=t=e,K.matchPrefix(t[0]))return!0}catch(e){return console.error("[iiroseForge]",e),!1}var t;return!1})),i.socketApi.send=i.socket.send.bind(i.socket),i.socket.send=e(i.socketApi.send,(e=>{try{if(q=t=e,V.matchPrefix(t[0]))return!0}catch(e){return console.error("[iiroseForge]",e),!1}var t;return!1})),n.iiroseForgeInjected=!0,console.log("[iiroseForge] 成功将iiroseForge注入iframe"),(async()=>{let e=0;G.iiroseForge.sideLoadedScript.forEach((([t,i,n])=>{if(n){let t=document.createElement("script");t.src=i,a.body.appendChild(t),e++}})),e>0&&R("iiroseForge plug-in",`已在iframe内侧侧载 ${e} 个js脚本`)})()}}),1e3),"true"==localStorage.getItem("installForge")&&t((()=>{let e=document.getElementById("mainFrame"),t=e.contentWindow;e.contentDocument;if(!t.Utils?.service?.clearCache)throw"Incomplete load";let i=t.Utils.service.clearCache.bind(t.Utils.service);t.Utils.service.clearCache=(...e)=>{let n=t.parent.location._reload.bind(t.parent.location);t.parent.location._reload=(...e)=>{setTimeout((()=>{Y(),setTimeout((()=>{n(...e)}),100)}),100)},i(...e),t.parent.location._reload=n,t.location._reload=n}}),5)}if("iirose.com"==location.host)if("/"==location.pathname)if(window.iiroseForgeInjected)console.log("[iiroseForge] 已阻止重复注入");else{console.log("[iiroseForge] iiroseForge已启用"),function(){try{let e=localStorage.getItem("iiroseForge");if(!e)return;let t=JSON.parse(e);Object.keys(t).forEach((e=>{G.iiroseForge[e]=t[e]}))}catch(e){R("错误","无法读入储存 这可能导致iiroseForge配置丢失")}}(),he.readPlugList(),document.getElementById("mainFrame").addEventListener("load",(()=>{console.log("[iiroseForge] 已重载 正在将iiroseForge注入iframe"),ge()})),console.log("[iiroseForge] 正在将iiroseForge注入iframe"),ge(),window.iiroseForgeInjected=!0,(async()=>{let e=0;G.iiroseForge.sideLoadedScript.forEach((([t,i,n])=>{if(!n){let t=document.createElement("script");t.src=i,window.document.body.appendChild(t),e++}})),e>0&&R("iiroseForge plug-in",`已在iframe外部侧载 ${e} 个js脚本`)})()}else if("/messages.html"==location.pathname){if(console.log("[iiroseForge] iiroseForge需要注入至主上下文中"),"iirose.com"==parent?.location?.host&&"/"==parent?.location?.pathname){let e=parent.document,t=e.createElement("script");t.src=$,e.body.appendChild(t),console.log("[iiroseForge] 修正注入")}}else console.log("[iiroseForge] 已阻止注入 iiroseForge需要注入至根页面的主上下文中");else console.log("[iiroseForge] 已阻止注入 iiroseForge仅支持蔷薇花园(iirose.com)")}();
