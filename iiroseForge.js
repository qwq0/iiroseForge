!function(){"use strict";function e(e,t){return function(...n){let i=e.bind(this);if(1!=t(n,i,e,this))return i(...n)}}function t(e,t,n=!1){let i=0,o=Date.now(),r=null,a=()=>{i++;try{return e(i,Date.now()-o),void(null!=r&&clearInterval(r))}catch(e){}};r=setInterval(a,t),n&&a()}function n(e,t){let n=e;return t.every((e=>(e<0&&(e+=n.childNodes.length),n.childNodes[e]?(n=n.childNodes[e],!0):(n=null,!1)))),n}function i(e,t){if(!e)return!1;for(let n=0,i=e.length;n<i;n++)if(null!=e[n]&&t(e[n],n))return!0;return!1}function o(e,...t){return t.some((t=>t===e))}const r=new WeakMap,a=new WeakMap,s=new FinalizationRegistry((e=>{e.destroy()}));class l{info=null;cbRef=null;callback=null;constructor(e,t){this.info=e,this.cbRef=new WeakRef(t),this.callback=t,e.addHook(this)}emit(){let e=this.cbRef.deref();if(e)try{e(this.info.getValue())}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),s.unregister(this)}bindDestroy(e){let t=a.get(e);return null==t&&(t=new Set,a.set(e,t)),t.add(this.callback),this.callback=null,s.register(e,this,this),this}}class c{info=null;targetRef=null;targetKey="";constructor(e,t,n){this.info=e,this.targetRef=new WeakRef(t),this.targetKey=n,e.addHook(this),s.register(t,this,this)}emit(){let e=this.targetRef.deref();if(null!=e)try{e[this.targetKey]=this.info.getValue()}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),s.unregister(this)}}class d{proxyObj=null;srcObj=null;keys=[];hookMap=null;ctFunc=null;constructor(e,t,n,i,o){this.proxyObj=e,this.srcObj=t,this.keys=n,this.hookMap=i,this.ctFunc=o}getValue(){return this.ctFunc?this.ctFunc(...this.keys.map((e=>this.srcObj[e]))):this.srcObj[this.keys[0]]}addHook(e){this.keys.forEach((t=>{let n=this.hookMap.get(t);null==n&&(n=new Set,this.hookMap.set(t,n)),n.add(e)}))}removeHook(e){this.keys.forEach((t=>{let n=this.hookMap.get(t);n&&(n.delete(e),0==n.size&&this.hookMap.delete(t))}))}bindToValue(e,t){return new c(this,e,t)}bindToCallback(e){return new l(this,e)}}class u{callback=null;constructor(e){this.callback=e}apply(e){this.callback(e)}}class m{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){if("function"==typeof this.value){let t=this.value(e);null!=t&&e.element.setAttribute(this.key,t)}else e.element.setAttribute(this.key,this.value)}}class p{eventName=null;callback=null;constructor(e,t){this.eventName=e,this.callback=t}apply(e){e.addEventListener(this.eventName,(t=>{this.callback(t,e)}))}}class h{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){e.setStyle(this.key,this.value)}}function g(e,t){return new h(e,t)}function f(e){return b.flat(Object.keys(e).map((t=>new h(t,e[t]))))}class y{tagName=null;constructor(e){this.tagName=e.toLowerCase()}}class b{list=null;flatFlag=!1;constructor(e){this.list=e}apply(e){const t=e.getTagName();this.list.forEach((n=>{if(null!=n)if("string"==typeof n)e.addText(n);else if("function"==typeof n)n(e);else{if("object"!=typeof n)throw"(NList) Untractable feature types were found";switch(Object.getPrototypeOf(n)?.constructor){case d:e.addChild(n);break;case y:if(t!=n.tagName)throw"(NList) The feature tagName does not match the element";break;case h:case m:case p:case u:n.apply(e);break;case x:e.addChild(n);break;case b:{const t=n;t.flatFlag?t.apply(e):e.addChild(t.getElement());break}case Array:e.addChild(b.getElement(n));break;default:throw"(NList) Untractable feature types were found"}}}))}getTagName(){let e="";return this.list.forEach((t=>{let n="";if(t instanceof y?n=t.tagName:t instanceof b&&t.flatFlag&&(n=t.getTagName()),n)if(e){if(e!=n)throw"(NList) Multiple TagNames exist in a feature list"}else e=n})),e}getElement(){let e=this.getTagName();""==e&&(e="div");let t=v(document.createElement(e));return this.apply(t),t}static flat(e){let t=new b(e);return t.flatFlag=!0,t}static getElement(e){return new b(e).getElement()}}const w=Symbol("NElement");class x{element=null;styleHooks=new Map;constructor(e){this.element=e}addChild(e){if(e instanceof x)this.element.appendChild(e.element);else if(e instanceof Node)this.element.appendChild(e);else if("string"==typeof e)this.addText(e);else{if(!(e instanceof d))throw"(NElement) Type of child node that cannot be added";{let t=null;{let n=e.getValue();t=null==n?new Comment:"string"==typeof n?new Text(n):n instanceof x?n.element:n,this.element.appendChild(t)}e.bindToCallback((e=>{if(t instanceof Text&&"string"==typeof e)t.data=e;else{let n=null==e?new Comment:"string"==typeof e?new Text(e):e instanceof x?e.element:e;this.element.replaceChild(n,t),t=n}})).bindDestroy(this)}}}addChilds(...e){e.forEach((e=>{Array.isArray(e)?e.forEach((e=>this.addChild(e))):"object"==typeof e&&this.addChild(e)}))}insChild(e,t){let n=this.element;"number"==typeof t?t>=0||t<n.childElementCount?n.insertBefore(e.element,n.children[t]):t<0||t>=-n.childElementCount?n.insertBefore(e.element,n.children[n.childElementCount+t]):n.appendChild(e.element):n.insertBefore(e.element,t.element)}childInd(e){let t=-1;return i(this.element.children,((n,i)=>{if(n==e.element)return t=i,!0})),t}remove(){this.element.remove()}removeChilds(e=0,t=1/0){let n=this.element;t>n.childElementCount&&(t=n.childElementCount);for(let i=e;i<t;i++)n.children[e].remove()}getChilds(){return Array.from(this.element.children).map((e=>v(e)))}getChild(e){return v(this.element.children[e])}replaceWith(...e){this.element.replaceWith(...e.map((e=>e.element)))}setStyle(e,t,n){n!=this.styleHooks.get(e)&&(this.styleHooks.get(e)?.destroy(),null!=n?this.styleHooks.set(e,n):this.styleHooks.delete(e)),t instanceof d?t.bindToCallback((t=>{this.setStyle(e,t,n)})).bindDestroy(this).emit():this.element.style[e]=t}getStyle(e){if("string"==typeof e)return this.element.style[e]}setStyles(e){i(Object.keys(e),(t=>{o(typeof e[t],"number","string")&&(this.element.style[t]=e[t])}))}setText(e){this.element.innerText=e}addText(e){return this.element.appendChild(document.createTextNode(e))}setAttrs(e){i(Object.keys(e),(t=>{this.element.setAttribute(t,e[t])}))}setDisplay(e){this.setStyle("display",e)}addEventListener(e,t,n){this.element.addEventListener(e,t,n)}removeEventListener(e,t,n){this.element.removeEventListener(e,t,n)}animate(e,t){return this.element.animate(e,t)}async animateCommit(e,t){if("forwards"!=(t="number"==typeof t?{duration:t,fill:"forwards"}:Object.assign({fill:"forwards"},t)).fill&&"both"!=t.fill)throw"(NElelemt) animateCommit can only be used when fill forwards or both";let n=this.element.animate(e,t);await n.finished;let i=null;try{n.commitStyles()}catch(e){i=e}n.cancel(),null!=i&&console.error(i)}asse(e){return e(this),this}getTagName(){return this.element.tagName.toLowerCase()}applyNList(e){return(e instanceof b?e:b.flat(e)).apply(this),this}static byElement(e){return e[w]?e[w]:e instanceof x?e:e[w]=new x(e)}}function v(e){return x.byElement(e)}const k={diFull:e=>"calc(100% - "+e+")",rgb:(e,t,n,i=1)=>"rgba("+e+", "+t+", "+n+", "+i+")"};function S(e){let t=v(document.createElement(e.tagName?e.tagName:"div"));return["height","width","position","top","left","right","bottom","display","overflow"].forEach((n=>{e[n]&&t.setStyle(n,e[n])})),e.style&&t.setStyles(e.style),e.text&&t.setText(e.text),e.attr&&t.setAttrs(e.attr),e.classList&&t.element.classList.add(...e.classList),e.event&&Object.keys(e.event).forEach((n=>{e.event[n]&&t.addEventListener(n,e.event[n])})),e.child&&e.child.forEach((e=>{e&&(e instanceof x?t.addChild(e):t.addChild(S(e)))})),e.assembly&&e.assembly.forEach((e=>{let n=e(t);n&&(t=n)})),t}function I(e,t){let n={},i={};return Object.keys(t).forEach((e=>n[e]=t[e])),Object.keys(e).forEach((o=>{if("child"!=o)if("$"==o[0]){let r=o.slice(1);i[r]=t[r],n[r]=t[r]=e[o]}else if("$"==o.slice(-1)){let n=o.slice(0,-1);i[n]=t[n],t[n]=e[o]}else n[o]=e[o]})),n.left&&n.right&&n.width&&delete n.width,n.top&&n.bottom&&n.height&&delete n.height,e.child&&(n.child=[],e.child.forEach((e=>{e&&(e instanceof x?n.child.push(e):n.child.push(I(e,t)))}))),Object.keys(i).forEach((e=>t[e]=i[e])),n}function E(e){return S(I(e,{}))}class C{x=0;y=0;vx=0;vy=0;sx=0;sy=0;hold=!1;pressing=!1;constructor(e,t,n,i,o,r,a,s){this.x=e,this.y=t,this.vx=n,this.vy=i,this.sx=o,this.sy=r,this.hold=a,this.pressing=s}}function M(e,t,n=0,i=window){e.addEventListener("mousedown",(e=>function(e){e.cancelable&&e.preventDefault();l=a=e.clientX,c=s=e.clientY,i.addEventListener("mousemove",o,!0),i.addEventListener("mouseup",r,!0),e.button==n&&(d=!0,t(new C(a,s,0,0,a,s,!0,!0)))}(e)),!1);let o=e=>function(e){if(d){let n=e.clientX-a,i=e.clientY-s;a=e.clientX,s=e.clientY,t(new C(a,s,n,i,l,c,!0,!1))}}(e),r=e=>function(e){let u=e.clientX-a,m=e.clientY-s;a=e.clientX,s=e.clientY,i.removeEventListener("mousemove",o,!1),i.removeEventListener("mouseup",r,!1),d&&e.button==n&&(d=!1,t(new C(a,s,u,m,l,c,!1,!1)))}(e),a=0,s=0,l=0,c=0,d=!1}function P(e,t,n=!0){e.addEventListener("touchstart",(e=>function(e){e.cancelable&&n&&e.preventDefault();i(e.changedTouches,(e=>{let n={id:e.identifier,sx:e.clientX,sy:e.clientY,x:e.clientX,y:e.clientY};o.set(e.identifier,n),t(new C(n.x,n.y,0,0,n.sx,n.sy,!0,!0))}))}(e)),{capture:!1,passive:!1}),e.addEventListener("touchmove",(e=>function(e){i(e.changedTouches,(e=>{let n=o.get(e.identifier);if(n){let i=e.clientX-n.x,o=e.clientY-n.y;n.x=e.clientX,n.y=e.clientY,t(new C(n.x,n.y,i,o,n.sx,n.sy,!0,!1))}}))}(e)),{capture:!1,passive:!0}),e.addEventListener("touchend",(e=>function(e){i(e.changedTouches,(e=>{let n=o.get(e.identifier);if(n){o.delete(e.identifier);let i=e.clientX-n.x,r=e.clientY-n.y;n.x=e.clientX,n.y=e.clientY,t(new C(n.x,n.y,i,r,n.sx,n.sy,!1,!1))}}))}(e)),{capture:!1,passive:!0}),e.addEventListener("touchcancel",(e=>function(e){i(e.changedTouches,(e=>{let n=o.get(e.identifier);n&&(o.delete(e.identifier),t(new C(n.x,n.y,0,0,n.sx,n.sy,!1,!1)))}))}(e)),{capture:!1,passive:!0});let o=new Map}let L=new Map([["~","`"],["!","1"],["@","2"],["#","3"],["$","4"],["%","5"],["^","6"],["&","7"],["*","8"],["(","9"],[")","0"],["_","-"],["+","="],["{","["],["}","]"],["|","\\"],['"',"'"],[":",";"],["<",","],[">","."],["?","/"]]);const B="A".charCodeAt(0),A="a".charCodeAt(0);for(let e=0;e<26;e++)L.set(String.fromCharCode(B+e),String.fromCharCode(A+e));let $=new Map;class F{key="";hold=!1;pressing=!1;constructor(e,t,n){this.key=e,this.hold=t,this.pressing=n}}function T(e,t){e.addEventListener("keydown",(e=>{let n=L[e.key]?L[e.key]:e.key;t(new F(n,!0,function(e){return!$.get(e)&&($.set(e,!0),!0)}(n)))})),e.addEventListener("keyup",(e=>{let n=L[e.key]?L[e.key]:e.key;!function(e){$.set(e,!1)}(n),t(new F(n,!1,!1))}))}function j(e){if(r.has(e))throw"Unable to create a proxy for a proxy object";const t=new Map,n=new Proxy(e,{get:(e,t)=>Reflect.get(e,t),set:(e,n,i)=>{let o=Reflect.set(e,n,i);if(o){let e=t.get(n);e&&e.forEach((e=>{e.emit()}))}return o},deleteProperty:(e,n)=>{let i=Reflect.deleteProperty(e,n);if(i){let e=t.get(n);e&&(e.forEach((e=>{e.destroy()})),t.delete(n))}return i}});return r.set(n,{hookMap:t,srcObj:e}),n}function D(e,...t){const n=t.length>=2?t.pop():null,i=r.get(e);if(null==i)throw"bindValue: Values can only be bound from proxy objects";return new d(e,i.srcObj,t,i.hookMap,n)}function R(e){return new Promise(((t,n)=>{setTimeout((()=>{t()}),e)}))}new FinalizationRegistry((e=>{e.destroy()}));let O=class{cbList=[];onceCbList=[];#e=null;add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}oncePromise(){return this.#e||(this.#e=new Promise((e=>{this.addOnce((t=>{this.#e=null,e(t)}))}))),this.#e}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((async t=>{t(e)})),this.onceCbList.forEach((async t=>{t(e)})),this.onceCbList=[]}existListener(){return this.cbList.length>0||this.onceCbList.length>0}},W={iframeWindow:null,iframeDocument:null,socket:null,iframeBody:null,socketApi:{send:()=>{}}};class N{nameToClass=new Map;classToName=new Map;nameToSafetyFunction=new Map;safetyFunctionToName=new Map}const H=Symbol("serialization function"),U=Symbol("deserialization function"),z=new TextEncoder;class V{#t=null;#n=new Uint8Array(128);#i=0;#o=-1;#r=new Map;#a=!1;constructor(e,t){this.#t=e,this.#a=t}push(e){if(this.#i>=this.#n.length){let e=this.#n;this.#n=new Uint8Array(2*this.#n.length),this.#n.set(e)}this.#n[this.#i++]=e}pushArr(e){if(this.#i+e.length>this.#n.length){let t=this.#n,n=2*t.length;for(;this.#i+e.length>n;)n*=2;this.#n=new Uint8Array(n),this.#n.set(t)}this.#n.set(e,this.#i),this.#i+=e.length}pushVint(e){for(;;){let t=127&e;if(!(e>>>=7))return void this.push(128|t);this.push(t)}}pushStr(e){let t=z.encode(e);this.pushVint(t.byteLength),this.pushArr(t)}traversal(e){switch(++this.#o,this.#r.has(e)||this.#r.set(e,this.#o),typeof e){case"number":Number.isInteger(e)&&e>=-2147483648&&e<=2147483647?(this.push(1),this.pushVint(e)):(this.push(2),this.pushArr(new Uint8Array(new Float64Array([e]).buffer)));break;case"string":{let t=0;this.#a&&e.length>=2&&this.#o>(t=this.#r.get(e))?(this.push(14),this.pushVint(t)):(this.push(3),this.pushStr(e));break}case"object":if(null==e)this.push(11);else if(this.#r.get(e)<this.#o)this.push(14),this.pushVint(this.#r.get(e));else if(Array.isArray(e))this.push(5),e.forEach((e=>{this.traversal(e)})),this.push(0);else if(this.#t.classToName.has(Object.getPrototypeOf(e)?.constructor)){this.push(6),this.pushStr(this.#t.classToName.get(Object.getPrototypeOf(e)?.constructor));let t=e[H]?e[H].call(e):e,n=Object.getOwnPropertyNames(t);this.pushVint(n.length),n.forEach((e=>{this.pushStr(e),this.traversal(t[e])}))}else if(Y.has(Object.getPrototypeOf(e)?.constructor)){this.push(15);let t=Y.get(Object.getPrototypeOf(e)?.constructor);this.pushVint(t.typeId),t.encode(this,e)}else{this.push(4);let t=Object.keys(e);this.pushVint(t.length),t.forEach((t=>{this.pushStr(t),this.traversal(e[t])}))}break;case"undefined":this.push(7);break;case"boolean":this.push(e?9:8);break;case"bigint":{let t=null;e>=0n?(this.push(12),t=0n==e?new Uint8Array(0):V.writeBigint(e)):(this.push(13),t=V.writeBigint(-e)),this.pushVint(t.byteLength),this.pushArr(t);break}case"symbol":this.#r.get(e)<this.#o?(this.push(14),this.pushVint(this.#r.get(e))):(this.push(10),this.pushStr(e.description?e.description:""));break;case"function":this.#t.safetyFunctionToName.has(e)?(this.push(17),this.pushStr(this.#t.safetyFunctionToName.get(e))):this.push(7);break;default:throw"JSObin(encode): The type of value that cannot be processed."}}getFinalBuffer(){return this.#n.slice(0,this.#i)}encode(e){return this.traversal(e),this.getFinalBuffer()}static writeBigint(e){let t=[];for(;;)if(t.push(Number(255n&e)),0n==(e>>=8n))return new Uint8Array(t)}}const Y=new Map,_=new Map;[{constructor:Map,typeId:1,encode:(e,t)=>{e.pushVint(t.size),t.forEach(((t,n)=>{e.traversal(n),e.traversal(t)}))},decode:e=>{let t=new Map,n=e.getVInt();e.referenceIndList.push(t);for(let i=0;i<n;i++){let n=e.traversal();t.set(n,e.traversal())}return t}},{constructor:Set,typeId:2,encode:(e,t)=>{t.forEach((t=>{e.traversal(t)})),e.push(0)},decode:e=>{let t=new Set;for(e.referenceIndList.push(t);0!=e.peekByte();)t.add(e.traversal());return e.index++,t}},{constructor:ArrayBuffer,typeId:20,encode:(e,t)=>{e.pushVint(t.byteLength),e.pushArr(new Uint8Array(t))},decode:e=>{let t=e.getVInt(),n=e.buffer.buffer.slice(e.index,e.index+t);return e.referenceIndList.push(n),e.index+=t,n}}].forEach((e=>{Y.set(e.constructor,{typeId:e.typeId,encode:e.encode}),_.set(e.typeId,e.decode)})),[{constructor:Int8Array,typeId:10},{constructor:Uint8Array,typeId:11},{constructor:Int16Array,typeId:12},{constructor:Uint16Array,typeId:13},{constructor:Int32Array,typeId:14},{constructor:Uint32Array,typeId:15},{constructor:BigInt64Array,typeId:16},{constructor:BigUint64Array,typeId:17},{constructor:Float32Array,typeId:18},{constructor:Float64Array,typeId:19}].forEach((e=>{Y.set(e.constructor,{typeId:e.typeId,encode:(e,t)=>{let n=t.buffer,i=t.byteOffset,o=t.length;e.pushVint(i),e.pushVint(o),e.traversal(n)}}),_.set(e.typeId,(t=>{let n=t.referenceIndList.length;t.referenceIndList.push(null);let i=t.getVInt(),o=t.getVInt(),r=t.traversal(),a=new e.constructor(r,i,o);return t.referenceIndList[n]=a,a}))}));const X=new TextDecoder("utf-8");class J{#t=null;buffer=null;dataView=null;index=0;referenceIndList=[];constructor(e,t){this.#t=e,this.buffer=t,this.dataView=new DataView(t.buffer)}peekByte(){return this.buffer[this.index]}popByte(){return this.buffer[this.index++]}getVInt(){let e=0,t=0;for(;!(128&this.peekByte());)if(e|=this.popByte()<<t,t+=7,t>32)throw"JSOBin Decode: Unexpected vint length";return e|=(127&this.popByte())<<t,e}getStr(){let e=this.getVInt(),t=X.decode(this.buffer.subarray(this.index,this.index+e));return this.index+=e,t}traversal(){if(this.index>=this.buffer.length)throw"JSOBin Decode: Wrong format";switch(this.popByte()){case 1:{let e=this.getVInt();return this.referenceIndList.push(e),e}case 2:{let e=this.dataView.getFloat64(this.index,!0);return this.referenceIndList.push(e),this.index+=8,e}case 3:{let e=this.getStr();return this.referenceIndList.push(e),e}case 4:{let e={},t=this.getVInt();this.referenceIndList.push(e);for(let n=0;n<t;n++){e[this.getStr()]=this.traversal()}return e}case 5:{let e=[];for(this.referenceIndList.push(e);this.peekByte();)e.push(this.traversal());return this.index++,e}case 6:{let e=this.getStr(),t=this.#t.nameToClass.get(e);if(null==t)throw`JSOBin Decode: (class) "${e}" is unregistered class in the current context in the parsing jsobin`;if(t?.[U]){let e={},n=this.getVInt(),i=this.referenceIndList.length;this.referenceIndList.push(e);for(let t=0;t<n;t++){e[this.getStr()]=this.traversal()}let o=t[U](e);return this.referenceIndList[i]=o,o}{let e=Object.create(t.prototype),n=this.getVInt();this.referenceIndList.push(e);for(let t=0;t<n;t++){e[this.getStr()]=this.traversal()}return e}}case 7:return void this.referenceIndList.push(void 0);case 8:return this.referenceIndList.push(!1),!1;case 9:return this.referenceIndList.push(!0),!0;case 10:{let e=Symbol(this.getStr());return this.referenceIndList.push(e),e}case 11:return this.referenceIndList.push(null),null;case 12:{let e=this.getVInt(),t=this.readBigInt(e);return this.referenceIndList.push(t),t}case 13:{let e=this.getVInt(),t=this.readBigInt(e);return this.referenceIndList.push(t),-t}case 14:{let e=this.getVInt(),t=this.referenceIndList[e];return this.referenceIndList.push(t),t}case 15:{let e=this.getVInt(),t=_.get(e);if(t)return t(this);throw"JSOBin Decode: Unsupported js built-in class type."}case 16:throw"JSOBin Decode: Function is not supported in the current version";case 17:{let e=this.#t.nameToSafetyFunction.get(this.getStr());return this.referenceIndList.push(e),e}default:throw"JSOBin Decode: Wrong format"}}decode(){return this.traversal()}readBigInt(e){let t=0n;for(let n=this.index+e-1;n>=this.index;n--)t<<=8n,t+=BigInt(this.buffer[n]);return this.index+=e,t}}function K(e=2){var t=Math.floor(Date.now()).toString(36);for(let n=0;n<e;n++)t+="-"+Math.floor(282e10*Math.random()).toString(36);return t}const q=new class{#t=new N;addClass(e,t){this.#t.nameToClass.set(e,t),this.#t.classToName.set(t,e)}addSafetyFunction(e,t){this.#t.nameToSafetyFunction.set(e,t),this.#t.safetyFunctionToName.set(t,e)}encode(e,t){return t=Object.assign({referenceString:!1},t),new V(this.#t,t.referenceString).encode(e)}decode(e){return new J(this.#t,e).decode()}};let Q=new Map;const G=Symbol("unfinishedSliceSymbol");function Z(e,t){if(e.startsWith("iiroseForge:")&&e.endsWith(":end")){let n=e.slice(12,-4);try{let e=n.indexOf(","),i=Number.parseInt(n.slice(0,e),36);if(Number.isNaN(i)||i<0||i>8192)return;n=n.slice(e+1);let o=n.slice(0,i);if(o.length!=i)return;let r=n.slice(i).split(",");if("single"==r[1]){if(r.length<2)return;return q.decode(te(o))}if("slice"==r[1]){if(r.length<5)return;let e=Date.now(),n=r[0],i=Number.parseInt(r[2],36),a=Number.parseInt(r[3],36),s=Number.parseInt(r[4],36);if(Number.isNaN(i)||Number.isNaN(a)||Number.isNaN(s)||a>64||i<0||i>=a||s>e+15e3||s<e-6e4||""==n)return G;let l=Q.get(n);return l||(l={slices:Array(a),createTime:e,updateTime:e,packetTime:s,creator:t,hasCount:0,totalCount:a},Q.set(n,l)),l.creator!=t||l.packetTime!=s||l.totalCount!=a||null!=l.slices[i]?G:(l.updateTime=e,l.hasCount++,l.slices[i]=o,l.hasCount<a?G:(Q.delete(n),q.decode(te(l.slices.join("")))))}}catch(e){return void console.log(e)}}}function ee(e){const t=8192;try{let n=function(e){let t=Array.from(e).map((e=>String.fromCharCode(e))).join("");return window.btoa(t)}(q.encode(e,{referenceString:!0}));if(n.length<=t){let e=["","single"];return`iiroseForge:${n.length.toString(36)},${n}${e.join(",")}:end`}{let e=Date.now().toString(36),i=K(),o=Math.ceil(n.length/t),r=o.toString(36);return Array(o).fill(0).map(((o,a)=>{let s=n.slice(a*t,(a+1)*t),l=[i,"slice",a.toString(36),r,e];return`iiroseForge:${s.length.toString(36)},${s}${l.join(",")}:end`}))}}catch(e){return}}function te(e){let t=window.atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}setInterval((()=>{let e=Date.now();Q.forEach(((t,n)=>{t.updateTime<e-15e3&&Q.delete(n)}))}),5e3);let ne=v(document.body);function ie(e){e.setStyle("transition","transform 50ms linear, text-shadow 150ms linear"),e.addEventListener("mousedown",(()=>{e.setStyle("transform","scale(0.95) translateY(2px)")})),e.addEventListener("mouseup",(()=>{e.setStyle("transform","")})),e.addEventListener("mouseenter",(()=>{e.setStyle("textShadow",`0 0 0.3em ${k.rgb(255,255,255,.5)}`),e.setStyle("transform","translateY(-1px)")})),e.addEventListener("mouseleave",(()=>{e.setStyle("textShadow",""),e.setStyle("transform","")}))}ne.setStyle("cursor","default");var oe=E({position:"absolute",right:"0px",style:{userSelect:"none",pointerEvents:"none",zIndex:"30000"}});function re(e,t,n="iiroseForge",i=null){let o=E({style:{color:k.rgb(255,255,255),backgroundColor:k.rgb(255,255,255,.1),backdropFilter:"blur(2px) brightness(90%)",marginRight:"1em",marginTop:"1em",marginLeft:"1em",float:"right",clear:"both",overflow:"hidden hidden",padding:"1em",boxSizing:"border-box",minWidth:"180px",borderRadius:"0.2em",boxShadow:`${k.rgb(0,0,0,.55)} 3px 3px 9px`},position:"relative",child:[{tagName:"i",classList:["fa","fa-info-circle"]},{text:e,style:{fontSize:"1.2em",lineHeight:"1.5em",fontWeight:"bolder"}},{text:t,style:{}},{text:n,style:{fontSize:"0.9em",float:"right"}},{text:"×",position:"absolute",right:"4px",top:"1px",assembly:[ie],style:{fontSize:"25px",lineHeight:"1em"},event:{click:e=>{e.stopPropagation(),a()}}}]});oe.addChild(o),o.animate([{transform:"translateX(180%) translateY(10%) scale(0.6)"},{}],{duration:180}),setTimeout((()=>{o.setStyle("pointerEvents","auto")}),180);let r=!1;function a(){r||(r=!0,o.setStyle("pointerEvents","none"),o.animate([{},{transform:"translateX(180%)"}],{duration:270,fill:"forwards"}),setTimeout((()=>{o.setStyle("visibility","hidden"),o.animate([{height:o.element.clientHeight+"px"},{marginTop:0,height:0,padding:0}],{duration:150,fill:"forwards"}),setTimeout((()=>{o.remove()}),150)}),270))}setTimeout((()=>{a()}),2500+Math.min(15e3,255*t.length)),i&&(o.asse(ie),o.addEventListener("click",(()=>{r||(i(),a())})))}function ae(e){return e=(e=(e=(e=(e=(e=e.replaceAll("&","&amp;")).replaceAll("<","&lt;")).replaceAll(">","&gt;")).replaceAll('"',"&quot;")).replaceAll("'","&#039;")).replaceAll("\\","&#092;")}function se(e){return e=(e=(e=(e=(e=(e=e.replaceAll("&lt;","<")).replaceAll("&gt;",">")).replaceAll("&quot;",'"')).replaceAll("&#039;","'")).replaceAll("&#092;","\\")).replaceAll("&amp;","&")}ne.addChild(oe);const le=new Set(["forge","iiroseForge","forgeFrame","iiroseForgeFrame"]),ce={state:{plug:null},operation:{showForgeNotice:(e,t)=>{re("插件提示",e=String(e),`插件 ${ce.state.plug?.name}`,t)},getUserName:()=>W.iframeWindow?.myself?W.iframeWindow.myself:null,getUserUid:()=>W.iframeWindow?.uid?W.iframeWindow.uid:null,getUserRoomId:()=>W.iframeWindow?.roomn?W.iframeWindow.roomn:null,getRoomInfoById:e=>{e=String(e);let t=W.iframeWindow?.Objs?.mapHolder?.Assets?.roomJson?.[e];if(t){let e=t[5].split("&&").map((e=>e.split(" & "))),n=se(e[0][0]),i=n.indexOf(" ");return{name:t[1],color:t[2],roomPath:t[0].split("_"),description:n.slice(i+1),roomImage:n.slice(0,i),currentUserNum:"number"==typeof t[7]?t[7]:"hidden",ownerName:e[1][0],member:e[4].map((e=>({name:se(e.slice(1)),auth:"0"==e[0]?"member":"1"==e[0]?"admin":"unknow"})))}}return null},getOnlineUserInfoById:e=>{e=String(e);let t=W.iframeWindow?.Objs?.mapHolder?.function?.findUserByUid?.(e);return t?{name:t[2],uid:e,color:t[3],avatar:t[0],roomId:t[4],personalizedSignature:t[6]}:null},getAllOnlineUserInfo:()=>{let e=W.iframeWindow?.Objs?.mapHolder.Assets.userJson;return e?Object.keys(e).map((t=>{let n=e[t];return{name:n[2],uid:n[8],color:n[3],avatar:n[0],roomId:n[4],personalizedSignature:n[6]}})):null},changeRoom:e=>{(e=String(e))&&W.iframeWindow?.Objs?.mapHolder?.function?.roomchanger(e)},getUserProfilePictureUrl:()=>W.iframeWindow?.avatar2&&W.iframeWindow?.avatarconv?W.iframeWindow.avatarconv(W.iframeWindow.avatar2):null,getUserInputColor:()=>W.iframeWindow?.inputcolorhex?W.iframeWindow.inputcolorhex:null,sendRoomMessage:e=>{(e=String(e))&&W.socketApi.send(JSON.stringify({m:e,mc:ce.operation.getUserInputColor(),i:String(Date.now()).slice(-5)+String(Math.random()).slice(-7)}))},sendRoomForgePacket:e=>{if("object"!=typeof e||ce.state.plug&&le.has(e.plug))return;let t=ee(e);"string"==typeof t?ce.operation.sendRoomMessage(t):(async()=>{for(let e=0;e<t.length;e++)ce.operation.sendRoomMessage(t[e]),await R(60)})()},sendPrivateForgePacket:(e,t)=>{if("object"!=typeof t||ce.state.plug&&le.has(t.plug))return;let n=ee(t);"string"==typeof n?ce.operation.sendPrivateMessageSilence(e,n):(async()=>{for(let t=0;t<n.length;t++)ce.operation.sendPrivateMessageSilence(e,n[t]),await R(60)})()},sendSelfPrivateForgePacket:e=>{ce.operation.sendPrivateForgePacket(ce.operation.getUserUid(),e)},sendPrivateMessageSilence:(e,t)=>{if(e=String(e),!(t=String(t))||!e)return;let n=String(Date.now()).slice(-5)+String(Math.random()).slice(-7);return W.socketApi.send(JSON.stringify({g:e,m:t,mc:ce.operation.getUserInputColor(),i:n})),{messageId:n}},sendPrivateMessage:(e,t)=>{if(e=String(e),!(t=String(t))||!e)return;let n=ce.operation.sendPrivateMessageSilence(e,t).messageId;W.iframeWindow?.privatechatfunc([Math.floor(Date.now()/1e3).toString(10),ce.operation.getUserUid(),ae(ce.operation.getUserName()),ae(ce.operation.getUserProfilePictureUrl()),ae(t),ae(ce.operation.getUserInputColor()),"",ae(ce.operation.getUserInputColor()),"","",n,e,"","","","",""].join(">"))},sendSelfPrivateMessageSilence:e=>{ce.operation.sendPrivateMessageSilence(ce.operation.getUserUid(),e)},giveALike:(e,t="")=>{e=String(e),t=String(t),e&&W.socketApi.send(`+*${e}${t?" "+t:""}`)},switchRoom:e=>{e=String(e),W.iframeWindow?.Objs?.mapHolder?.function?.roomchanger&&W.iframeWindow.Objs.mapHolder.function.roomchanger(e)},runTerminalCommand:e=>{!function(e){W.iframeWindow?.Probe?.init?.shellHolder&&W.iframeWindow?.Init?.movePanel(6);let t=n(W.iframeDocument.getElementById("shellHolder"),[2,0,-1,0]),i=t.value;t.value=e,t.oninput(null),t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13})),t.value=i}(e=String(e))},sendCurrentPageMessage:e=>{!function(e){var t=document.getElementById("moveinput"),n=t.value;t.value=e,t.oninput(null),document.getElementsByClassName("moveinputSendBtn")[0]?.onclick(null),t.value=n}(e=String(e))}},event:{roomMessage:new O,privateMessage:new O,selfPrivateMessage:new O,roomForgePacket:new O,privateForgePacket:new O,selfPrivateForgePacket:new O}};window.iiroseForgeApi=ce;let de={debugMode:!1},ue={send:e=>{W.socketApi.send(e)},clientSend:e=>{W.socket.send(e)},receive:e=>{W.socket._onmessage(e)}};function me(e){e=Boolean(e),de.debugMode=e,e?(window.fdb=ue,W.iframeWindow&&(W.iframeWindow.fdb=ue),sessionStorage.setItem("iiroseForgeDebugMode","true")):(window.fdb&&delete window.fdb,W.iframeWindow?.fdb&&delete W.iframeWindow.fdb,sessionStorage.removeItem("iiroseForgeDebugMode"))}let pe='!function(){"use strict";!function(){if("iirose.com"!=location.host)return;let e=null;if("/"==location.pathname)e=window;else{if("/messages.html"!=location.pathname)return;e=parent.window}if(e.iiroseForgeInjected)return;let t=!1,o=!1,i=["https://qwq0.github.io/iiroseForge/iiroseForge.js","https://cdn.jsdelivr.net/gh/qwq0/iiroseForge@page/iiroseForge.js"];!function n(a){!async function(n){let a=await fetch(n,{cache:"no-cache"});if(a.ok){let c=await a.text();if(c&&(t||(t=!0,console.log(`[iiroseForgeInjector] load from ${n}`),new e.Function(c)()),!o)){o=!0;let e=await(window?.caches?.open?.("v"));if(e){let t=new Response(new Blob([c],{type:"text/javascript"}),{status:200,statusText:"OK"});e.put(i[0],t),console.log("[iiroseForgeInjector] cache updated")}}}}(i[a]),a<i.length-1&&setTimeout((()=>{t||n(a+1)}),2e3)}(0),(async()=>{if(t)return;let o=await((await(window?.caches?.open?.("v")))?.match(i[0]));if(o&&o.ok){let i=await o.text();i&&!t&&(t=!0,console.log("[iiroseForgeInjector] load from cache"),new e.Function(i)())}})()}()}();';const he="\x3c!-- iiroseForge Installed Start --\x3e",ge="\x3c!-- iiroseForge Installed End --\x3e";function fe(e){const t='<script type="text/javascript" src="https://qwq0.github.io/iiroseForge/l.js"><\/script>';let n=e,i=n.indexOf(t);-1!=i&&(n=n.slice(0,i)+n.slice(i+t.length));let o=n.indexOf(he),r=n.lastIndexOf(ge);return-1!=o&&-1!=r&&(n=n.slice(0,o)+n.slice(r+ge.length)),n}async function ye(e){let t=await caches.open("v"),n=await caches.match("/");if(n){let i=function(e,t){let n=e;if(-1!=n.indexOf(he)&&!t)return e;n=fe(n);let i=n.lastIndexOf("</body></html>");return-1==i?(re("安装forge","无法安装forge (缓存错误)"),e):[n.slice(0,i),he,"<script>",pe,"<\/script>",ge,n.slice(i)].join("")}(await n.text(),e);await t.put("/",new Response(new Blob([i],{type:"text/html"}),{status:200,statusText:"OK"}))}else{let e=["<!DOCTYPE html>","<html>","<head>","</head>","<body>","<script>","(async () => {",'let cache = await caches.open("v");','await cache.delete("/");','let mainPageCacheStr = await (await fetch("/", { cache: "no-cache" })).text();','let insertIndex = mainPageCacheStr.lastIndexOf("</body></html>");',"if(insertIndex != -1)","mainPageCacheStr = mainPageCacheStr.slice(0, insertIndex) + ",` "${he}" + "<scr" + "ipt>" + ${JSON.stringify(pe)} + "<\\/sc" + "ript>" + "${ge}" `," + mainPageCacheStr.slice(insertIndex);",'await cache.put("/", new Response(new Blob([mainPageCacheStr], { type: "text/html" }), { status: 200, statusText: "OK" }));',"location.reload();","})();","<\/script>","</body>","</html>"].join("");await t.put("/",new Response(new Blob([e],{type:"text/html"}),{status:200,statusText:"OK"}))}}"true"==localStorage.getItem("installForge")&&ye(!1);const be={processed:{uidBlacklistSet:new Set,myAccountSet:new Set,pinSessionSet:new Set},roaming:{plugInfo:[],sideLoadedScript:[],userRemark:{},myAccountList:[],beautify:{},customInfoPage:{},uidBlacklist:[],pinSessionList:[],blacklistAutoReply:"根据对方的隐私设置 您暂时无法向对方发送私信",notDisturbModeAutoReply:"你好 我现在有事不在 一会再和你联系"},local:{enableSyncChatRecord:!1,enableUserRemark:!0,enableAudioTakeover:!0,enableSuperMenu:!1,enableRoomAdminOperation:!0,enablePinSession:!0,lastCloseTime:0,syncChatRecordTo:0,enableExperimental:!1,experimentalOption:{},patch:{},superMenuPriority:{},superMenuOption:{}}};function we(e){try{Object.keys(e).forEach((t=>{be.roaming[t]=e[t]})),Object.keys(be.roaming).forEach((e=>{"object"!=typeof be.roaming[e]||Array.isArray(be.roaming[e])||(be.roaming[e]=j(be.roaming[e]))})),be.processed.myAccountSet=new Set(be.roaming.myAccountList),be.processed.uidBlacklistSet=new Set(be.roaming.uidBlacklist),be.processed.pinSessionSet=new Set(be.roaming.pinSessionList)}catch(e){re("错误","无法设置储存 这可能导致iiroseForge配置丢失")}}function xe(){try{let e=JSON.stringify(function(){try{be.roaming.myAccountList=Array.from(be.processed.myAccountSet),be.roaming.uidBlacklist=Array.from(be.processed.uidBlacklistSet),be.roaming.pinSessionList=Array.from(be.processed.pinSessionSet)}catch(e){re("错误","无法处理储存 这可能导致iiroseForge配置丢失")}return be.roaming}());localStorage.setItem("iiroseForge",e)}catch(e){re("错误","无法写入储存 这可能导致iiroseForge配置丢失")}}function ve(){try{let e=JSON.stringify(be.local);localStorage.setItem("iiroseForgeLocal",e)}catch(e){re("错误","无法写入本地储存 这可能导致iiroseForge配置丢失")}}function ke(e,t,n=!1,...i){return new Promise((o=>{var r=void 0,a=E({width:"100%",height:"100%",$position:"absolute",style:{userSelect:"none",backgroundColor:k.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:k.rgb(255,255,255,.95),color:k.rgb(0,0,0),alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"35px",minHeight:"190px",minWidth:"280px",maxWidth:"95%",boxSizing:"border-box",padding:"20px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120)},e=>{r=e}],position$:"static",display:"flex",child:[{text:e},{text:t},...i,{text:"确定",assembly:[ie],event:{click:()=>{s(),o(!0)}}},n?{text:"取消",assembly:[ie],event:{click:()=>{s(),o(!1)}}}:null]}]});function s(){r.setStyle("pointerEvents","none"),r.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),a.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{a.remove()}),120)}ne.addChild(a)}))}async function Se(e,t,n=!1,i=""){let o=E({tagName:"input",assembly:[ie],style:{textAlign:"center",margin:"15px"},attr:{value:i}});return o.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),setTimeout((()=>o.element.focus()),100),await ke(e,t,n,o)?o.element.value:void 0}function Ie(e){let t=e.split(" ");return new u((e=>{t.forEach((t=>{e.element.classList.add(t)}))}))}let Ee={userMenu:[],sessionMenu:[],roomMenu:[],roomMessageMenu:[]},Ce=new Set;function Me(t,n,i,o){!function(){if(!W.iframeWindow||1==W.iframeWindow[Pe])return;W.iframeWindow[Pe]=!0;let t=W.iframeWindow.Objs?.mapHolder?.function?.event;t&&(W.iframeWindow.Objs.mapHolder.function.event=e(t,((e,t,n,i)=>{if(1==e.length&&7==e[0]){let n=i?.dataset?.uid;if(!n)return!1;t(...e);let o=W.iframeDocument.getElementById("selectHolderBox");return Ee.userMenu.forEach((e=>{let t=e.creater({uid:n});t&&o.appendChild(Le(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({uid:n})})).element)})),!0}if(2==e.length&&7==e[0]&&Array.isArray(e[1])&&i?.classList?.contains("msgavatar")){let n=i?.dataset?.uid,o=e[1]?.[0],r=i?.parentNode?.parentNode?.dataset?.id?.split("_")?.[1];if("string"!=typeof o&&(o=void 0),!n)return!1;t(...e);let a=W.iframeDocument.getElementById("selectHolderBox");return Ee.roomMessageMenu.forEach((e=>{let t=e.creater({uid:n,messageId:r,userName:o});t&&a.appendChild(Le(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({uid:n,messageId:r,userName:o})})).element)})),!0}if(1==e.length&&8==e[0]||2==e.length&&8==e[0]&&1==e[1]){let n=i?.getAttribute?.("rid");if(n||"2_1"!=i?.getAttribute?.("n")||(n=i?.nextElementSibling?.getAttribute?.("rid")),!n)return!1;t(...e);let o=W.iframeDocument.getElementById("selectHolderBox");return Ee.roomMenu.forEach((e=>{let t=e.creater({roomId:n});t&&o.appendChild(Le(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({roomId:n})})).element)})),!0}return!1})));let n=W.iframeWindow.Utils?.service?.pm?.menu;n&&(W.iframeWindow.Utils.service.pm.menu=e(n,((e,t)=>{if(1==e.length){let n=e[0]?.parentNode?.getAttribute?.("ip");if(!n)return!1;t(...e);let i=W.iframeDocument.getElementById("selectHolderBox");return Ee.sessionMenu.concat(Ee.userMenu).forEach((e=>{let t=e.creater({uid:n});t&&i.appendChild(Le(`mdi-${t.icon}`,t.text,(async t=>{t.stopPropagation(),e.callback({uid:n})})).element)})),!0}return!1})))}(),Ce.has(t)||(Ce.add(t),Ee[n].push({creater:i,callback:o}))}let Pe=Symbol();function Le(e,t,n){return b.getElement([Ie("selectHolderBoxItem selectHolderBoxItemIcon"),[Ie(e),f({fontFamily:"md",fontSize:"28px",textAlign:"center",lineHeight:"100px",height:"100px",width:"100px",position:"absolute",top:"0",opacity:".7",left:"0"})],t,[Ie("fullBox whoisTouch3")],new p("click",n)])}function Be(){let e=W.iframeDocument.getElementsByClassName("msgholderBox")[0];Array.from(e.children).forEach((e=>{$e(e)})),new MutationObserver((e=>{for(let t of e)"childList"==t.type&&Array.from(t.addedNodes).forEach((e=>{null!=e.classList&&e.classList.contains("msg")&&$e(e)}))})).observe(e,{attributes:!1,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0});let t=W.iframeDocument.getElementsByClassName("sessionHolderPmTaskBox")[0];Array.from(t.children).forEach((e=>{Fe(e)})),new MutationObserver((e=>{for(let t of e)"childList"==t.type&&Array.from(t.addedNodes).forEach((e=>{null!=e.classList&&e.classList.contains("sessionHolderPmTaskBoxItem")&&Fe(e)}))})).observe(t,{attributes:!1,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0}),Me("userMark","userMenu",(e=>{let t=be.roaming.userRemark[e.uid];return{icon:"account-cog",text:"设置备注"+(t?`(${t})`:"")}}),(async e=>{let t=be.roaming.userRemark[e.uid],n=await Se("设置备注",`给 ${e.uid} 设置备注`,!0,t||"");null!=n&&(be.roaming.userRemark[e.uid]=n,xe())}))}let Ae=new WeakSet;function $e(e){if(1==e.classList.length&&"msg"==e.classList.item(0)){if(Ae.has(e))return;Ae.add(e);let t=e.dataset.id?e.dataset.id.split("_")[0]:n(e,[0,-1,0])?.dataset?.uid,i=n(e,[0,0,-1,-1]);i&&i.appendChild(b.getElement([f({color:"white",position:"absolute",whiteSpace:"pre",["right"!=i.style.float?"left":"right"]:"0px",width:"max-content",bottom:"42px"}),D(be.roaming.userRemark,t,(e=>e||""))]).element)}}function Fe(e){if(2==e.classList.length&&e.classList.contains("sessionHolderPmTaskBoxItem")&&e.classList.contains("whoisTouch2")){if(Ae.has(e))return;Ae.add(e);let t=e.getAttribute("ip"),i=n(e,[1,0,-1]);i&&i.appendChild(b.getElement([f({display:"inline",marginLeft:"3px"}),D(be.roaming.userRemark,t,(e=>e?`(${e})`:""))]).element)}}function Te(e){return new Promise((t=>{var n=null,i=E({width:"100%",height:"100%",$position:"absolute",style:{userSelect:"none",backgroundColor:k.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:k.rgb(255,255,255,.95),color:k.rgb(0,0,0),alignItems:"stretch",justifyContent:"center",flexFlow:"column",lineHeight:"45px",minHeight:"10px",minWidth:"280px",maxHeight:"100%",maxWidth:"95%",overflowY:"auto",scrollbarWidth:"none",boxSizing:"border-box",padding:"10px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120),e.getChilds().forEach((e=>{e.addEventListener("click",o),ie(e)}))},e=>{n=e}],position$:"static",overflow:"auto",child:e,event:{click:e=>{e.stopPropagation()}}}],event:{click:o}});function o(){n.setStyle("pointerEvents","none"),n.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),i.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{i.remove()}),120)}ne.addChild(i)}))}async function je(){Te([b.getElement(["设置自动回复内容",new p("click",(async()=>{let e=be.roaming.blacklistAutoReply,t=await Se("自定义自动回复","输入黑名单用户私聊的自动回复内容\n留空关闭自动回复",!0,e);null!=t&&e!=t&&(be.roaming.blacklistAutoReply=t,xe(),re("黑名单",""==t?"已关闭黑名单自动回复":"已更新黑名单自动回复内容"))}))]),b.getElement(["[ 添加黑名单 ]",new p("click",(async()=>{let e=await Se("添加黑名单","输入目标的唯一标识",!0);if(null!=e){e!=ce.operation.getUserUid()?De(e,!1):re("黑名单","不能添加此账号本身")}}))]),...Array.from(be.processed.uidBlacklistSet).map((e=>{let t=ce.operation.getOnlineUserInfoById(e);return b.getElement([`${e}${t?` (${t.name})`:""}`,new p("click",(async()=>{var n;n=e,t?.name,Te([b.getElement(["移出黑名单",new p("click",(()=>{De(n,!0)}))])])}))])}))])}async function De(e,t){let n=t?"移出黑名单":"加入黑名单",i=ce.operation.getOnlineUserInfoById(e);await ke(n,`确定将用户 ${e}${i?`(${i.name})`:""}\n${n}吗?`,!0)&&(t?be.processed.uidBlacklistSet.delete(e):be.processed.uidBlacklistSet.add(e),xe(),re("黑名单",`已将用户 ${e}${i?`(${i.name})`:""} ${n}`))}function Re(){Me("blacklist","userMenu",(e=>{let t=be.processed.uidBlacklistSet.has(e.uid);return e.uid!=ce.operation.getUserUid()||t?{icon:t?"account-lock-open-outline":"account-cancel-outline",text:t?"此人已在黑名单中":"添加到黑名单"}:null}),(async e=>{let t=be.processed.uidBlacklistSet.has(e.uid);De(e.uid,t)}));let e=W.iframeDocument.getElementsByClassName("msgholderBox")[0];Array.from(e.children).forEach((e=>{try{let t=e;if(1==t.classList.length&&"msg"==t.classList.item(0)){let i=t.dataset.id?t.dataset.id.split("_")[0]:n(t,[0,-1,0])?.dataset?.uid;i&&Oe(i)&&e.remove()}if(2==t.classList.length&&t.classList.contains("pubMsgSystem")){let i=n(t,[0,0])?.dataset?.uid;i||(i=n(t,[0,0,0])?.dataset?.uid),i&&Oe(i)&&e.remove()}}catch(e){console.error(e)}})),Array.from(e.children).forEach(((e,t,n)=>{try{let i=e;1==i.classList.length&&"pubMsgTime"==i.classList.item(0)&&(t==n.length-1||n[t+1]?.classList?.contains("pubMsgTime"))&&e.remove()}catch(e){console.error(e)}}))}function Oe(e,t="",n=""){return ce.operation.getUserUid()!=e&&be.processed.uidBlacklistSet.has(e)}class We{#s=new Ne;addPath(e,t){this.#s.addPath(e,0,t)}matchPrefix(e){return this.#s.matchPrefix(e,0)}}class Ne{#l=new Map;#c=null;addPath(e,t,n){if(t>=e.length)this.#c=n;else{let i=this.#l.get(e[t]);null==i&&(i=new Ne,this.#l.set(e[t],i)),i.addPath(e,t+1,n)}}matchPrefix(e,t){if(t>=e.length)return this.#c?.("",e);{let n=this.#l.get(e[t]);return null!=n?n.matchPrefix(e,t+1):this.#c?.(e.slice(t),e)}}}let He={forge:{roomForgePacket:new O,privateForgePacket:new O,selfPrivateForgePacket:new O}},Ue=new We,ze=new We,Ve=[""];ze.addPath('"',(e=>{Ve[0]='"'+e.split("<").reverse().map((e=>{let t=e.split(">"),n=t[8],i=se(t[2]),o=t[3];if("s"!=t[4]&&"'"!=o[0]){let e=Z(o,n);if(null!=e){if(e!=G){if("object"!=typeof e)return;le.has(e.plug)?He.forge.roomForgePacket.trigger({senderId:n,senderName:i,content:e}):ce.event.roomForgePacket.trigger({senderId:n,senderName:i,content:e})}return}ce.event.roomMessage.trigger({senderId:n,senderName:i,content:se(o)})}if(!Oe(n,o,i))return e})).filter((e=>null!=e)).reverse().join("<")}));let Ye=new Map;ze.addPath('""',(e=>{let t=ce.operation.getUserUid();Ve[0]='""'+e.split("<").map((e=>{let n=e.split(">"),i=n[1],o=se(n[2]),r=n[4],a=n[11];if(""==n[6]){if(i!=t){let e=Z(r,i);if(null!=e){if(e!=G){if("object"!=typeof e)return;le.has(e.plug)?He.forge.privateForgePacket.trigger({senderId:i,senderName:o,content:e}):ce.event.privateForgePacket.trigger({senderId:i,senderName:o,content:e})}return}ce.event.privateMessage.trigger({senderId:i,senderName:o,content:se(r)})}else if(i==t&&a==t){let e=Z(r,i);if(null!=e){if(e!=G){if("object"!=typeof e)return;le.has(e.plug)?He.forge.selfPrivateForgePacket.trigger({content:e}):ce.event.selfPrivateForgePacket.trigger({content:e})}return}ce.event.selfPrivateMessage.trigger({content:se(r)})}else if(i==t&&a!=t){if(null!=Z(r,i))return}if(Oe(i,r,o))return void(be.roaming.blacklistAutoReply&&(!Ye.has(i)||Ye.get(i)<Date.now()-15e3)&&(Ye.set(i,Date.now()),ce.operation.sendPrivateMessageSilence(i,`[自动回复] ${be.roaming.blacklistAutoReply}`)))}if(!Oe(i,r,o))return e})).filter((e=>null!=e)).join("<")})),Ue.addPath("{",((e,t)=>{try{let e=JSON.parse(t),n=JSON.stringify(e);"{"==n[0]&&(Ve[0]=n)}catch(e){}})),new TextEncoder;const _e=new Map,Xe=new Map;async function Je(){let e="";if(await R(1100),[{key:"sidebarTopPicture",cb:e=>{let t=n(W.iframeDocument?.getElementById("functionHolderImg"),[0,0]);t&&(t.src=e)}},{key:"sidebarListPicture",cb:t=>{let n=W.iframeDocument?.getElementById("functionHolder");n&&(n.style.backgroundImage=`url("${t}")`,n.style.backgroundSize="cover",n.style.backgroundPosition=`top ${n.children[0].children[0].style.height} left 0px`,Array.from(n.children[0].children).forEach((e=>{e.classList.contains("functionItemBox")?e.style.backgroundColor="rgba(127, 127, 127, 0.1)":e.style.backgroundColor="transparent"})),e+=[".functionButtonGroup:hover, .functionButton:hover","{","background: rgba(127, 127, 127, 0.3) !important;","}"].join("\n"))}},{key:"selectMenuBackground",cb:e=>{let t=W.iframeDocument?.getElementById("selectHolderBox");t&&(t.style.backgroundImage=`url("${e}")`,t.style.backgroundSize="cover")}},{key:"selectMenuBorderRadius",cb:e=>{let t=W.iframeDocument?.getElementById("selectHolderBox");t&&(t.style.borderRadius=e+"px")}},{key:"messageImgBorderRadius",cb:t=>{e+=[".roomChatContentBox img, .privatemsgMessagesBodyItemBodyBox img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"messageAvatarBorderRadius",cb:t=>{e+=[".msgavatar, .msgavatar img, .privatemsgMessagesBodyItem .privatemsgMessagesBodyItemIcon, .privatemsgMessagesBodyItem .privatemsgMessagesBodyItemIcon img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"systemMessageBorderRadius",cb:t=>{e+=[".pubMsgSystem span","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"systemMessageImgBorderRadius",cb:t=>{e+=[".pubMsgSystem .pubMsgSystemIcon, .pubMsgSystem img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"sessionListItemBorderRadius",cb:t=>{e+=[".sessionHolderPmTaskBoxItem, .sessionHolderPmTaskBoxItem img","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"panelItemBorderRadius",cb:t=>{e+=["#panelHolder .shopItem, #panelHolder img, .contentItemContent :is(.commonBox, .commonBox .commonBoxHead, .commonBox .shopItemColor, .cardTag)","{",`border-radius: ${t}px !important;`,"}"].join("\n")}},{key:"alertBackground",cb:t=>{e+=["#alertHolder > div","{",`background-image: url("${t}") !important;`,"background-size: cover !important;","}"].join("\n")}},{key:"sessionMessageBorderRadius",cb:t=>{e+=[".room_chat_content","{",`border-radius: ${t}px;`,"}",'.room_chat_content[style*="border-right"]',"{",`border-radius: ${t}px ${t}px 0 ${t}px;`,"}",'.room_chat_content[style*="border-right"] .systemCardMediaShareImg',"{",`border-radius: ${t}px 0 0 ${t}px`,"}",".chatContentHolder:not(.publicMsgHasBubble)","{",`border-radius: ${t}px;`,"overflow: hidden;","}",'.room_chat_content[style*="border-right"]>div[style*="top:0;bottom:0;right:-6px;"]>div',"{",`width: ${t}px !important;`,`border-radius: 0 ${t}px 0 0;`,"}",'.room_chat_content[style*="border-right"]>div[style*="top:0;bottom:0;right:-6px;"]>svg',"{","right:-7.5px !important;","}",'.room_chat_content[style*="border-left"]',"{","overflow: visible;",`border-radius: ${t}px ${t}px ${t}px 0;`,"}",'.room_chat_content[style*="border-left"] .systemCardMediaShareImg',"{",`border-radius: 0 ${t}px ${t}px 0`,"}",'.room_chat_content[style*="border-left"]>div[style*="top:0;bottom:0;left:-6px;"]>div',"{",`width: ${t}px !important;`,`border-radius: ${t}px 0 0 0;`,"}",".privateMsgNoBubble","{",`border-radius: ${t}px;`,"overflow: hidden;","}",".privatemsgMessagesBodyItemBodyBG","{",`border-radius: ${t}px;`,"}",'.privatemsgMessagesBodyItemBodyBG[style*="border-right"]',"{","overflow: visible;",`border-radius: ${t}px ${t}px 0 ${t}px;`,"}",'.privatemsgMessagesBodyItemBodyBG[style*="border-right"]>div[style*="right:-6px;top:0;bottom:0;"]>div',"{",`width: ${t}px !important;`,`border-radius: 0 ${t}px 0 0;`,"}",'.privatemsgMessagesBodyItemBodyBG[style*="border-right"]>div[style*="right:-6px;top:0;bottom:0;"]>svg',"{","right:-7.5px !important;","}",'.privatemsgMessagesBodyItemBodyBG[style*="border-left"]',"{",`border-radius: ${t}px ${t}px ${t}px 0;`,"}",'.privatemsgMessagesBodyItemBodyBG[style*="border-left"]>div[style*="left:-6px;top:0;bottom:0;"]>div',"{",`width: ${t}px !important;`,`border-radius: ${t}px 0 0 0;`,"}"].join("\n")}}].forEach((e=>{let t=be.roaming.beautify[e.key];if(t)try{e.cb(t)}catch(e){console.error(e)}})),e){let t=document.createElement("style");t.textContent=e,W.iframeDocument.body.appendChild(t)}}[{constructor:Map,typeId:1,encode:(e,t)=>{e.pushVint(t.size),t.forEach(((t,n)=>{e.traversal(n),e.traversal(t)}))},decode:e=>{let t=new Map,n=e.getVInt();e.referenceIndList.push(t);for(let i=0;i<n;i++){let n=e.traversal();t.set(n,e.traversal())}return t}},{constructor:Set,typeId:2,encode:(e,t)=>{t.forEach((t=>{e.traversal(t)})),e.push(0)},decode:e=>{let t=new Set;for(e.referenceIndList.push(t);0!=e.peekByte();)t.add(e.traversal());return e.index++,t}},{constructor:ArrayBuffer,typeId:20,encode:(e,t)=>{e.pushVint(t.byteLength),e.pushArr(new Uint8Array(t))},decode:e=>{let t=e.getVInt(),n=e.buffer.buffer.slice(e.index,e.index+t);return e.referenceIndList.push(n),e.index+=t,n}}].forEach((e=>{_e.set(e.constructor,{typeId:e.typeId,encode:e.encode}),Xe.set(e.typeId,e.decode)})),[{constructor:Int8Array,typeId:10},{constructor:Uint8Array,typeId:11},{constructor:Int16Array,typeId:12},{constructor:Uint16Array,typeId:13},{constructor:Int32Array,typeId:14},{constructor:Uint32Array,typeId:15},{constructor:BigInt64Array,typeId:16},{constructor:BigUint64Array,typeId:17},{constructor:Float32Array,typeId:18},{constructor:Float64Array,typeId:19}].forEach((e=>{_e.set(e.constructor,{typeId:e.typeId,encode:(e,t)=>{let n=t.buffer,i=t.byteOffset,o=t.length;e.pushVint(i),e.pushVint(o),e.traversal(n)}}),Xe.set(e.typeId,(t=>{let n=t.referenceIndList.length;t.referenceIndList.push(null);let i=t.getVInt(),o=t.getVInt(),r=t.traversal(),a=new e.constructor(r,i,o);return t.referenceIndList[n]=a,a}))})),new TextDecoder("utf-8");let Ke='!function(){"use strict";function e(e=2){var t=Math.floor(Date.now()).toString(36);for(let a=0;a<e;a++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}function t(t,a){let r=new Map;let n=function t(n){if("function"==typeof n){let t={},s=e();return a.set(s,n),r.set(t,s),t}if("object"==typeof n){if(Array.isArray(n))return n.map(t);{let e={};return Object.keys(n).forEach((a=>{e[a]=t(n[a])})),e}}return n}(t);return{result:n,fnMap:r}}const a=new FinalizationRegistry((({id:e,port:t})=>{t.postMessage({type:"rF",id:e})}));function r(r,n,s,i,o){let p=new Map;n.forEach(((r,n)=>{if(!p.has(r)){let n=(...a)=>new Promise(((n,p)=>{let l=t(a,i),d=e();i.set(d,n),o.set(d,p),s.postMessage({type:"fn",id:r,param:l.result,fnMap:l.fnMap.size>0?l.fnMap:void 0,cb:d})}));p.set(r,n),a.register(n,{id:r,port:s})}}));const l=e=>{if("object"==typeof e){if(n.has(e))return p.get(n.get(e));if(Array.isArray(e))return e.map(l);{let t={};return Object.keys(e).forEach((a=>{t[a]=l(e[a])})),t}}return e};return{result:l(r)}}(()=>{let e=null,a=new Map,n=new Map;window.addEventListener("message",(s=>{"setMessagePort"==s.data&&null==e&&(e=s.ports[0],Object.defineProperty(window,"iframeSandbox",{configurable:!1,writable:!1,value:{}}),e.addEventListener("message",(async s=>{let i=s.data;switch(i.type){case"execJs":new Function(...i.paramList,i.js)(i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param);break;case"fn":if(a.has(i.id)){let s=i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param;try{let r=await a.get(i.id)(...s);if(i.cb){let n=t(r,a);e.postMessage({type:"sol",id:i.cb,param:[n.result],fnMap:n.fnMap.size>0?n.fnMap:void 0})}}catch(t){i.cb&&e.postMessage({type:"rej",id:i.cb,param:[t]})}}break;case"rF":a.delete(i.id);break;case"sol":{let t=i.fnMap?r(i.param,i.fnMap,e,a,n).result:i.param;a.has(i.id)&&a.get(i.id)(...t),a.delete(i.id),n.delete(i.id);break}case"rej":n.has(i.id)&&n.get(i.id)(...i.param),a.delete(i.id),n.delete(i.id)}})),e.start(),e.postMessage({type:"ready"}))})),window.addEventListener("load",(e=>{console.log("sandbox onload")}))})()}();';function qe(e=2){var t=Math.floor(Date.now()).toString(36);for(let n=0;n<e;n++)t+="-"+Math.floor(1e12*Math.random()).toString(36);return t}function Qe(e,t){let n=new Map;let i=function e(i){if("function"==typeof i){let e={},o=qe();return t.set(o,i),n.set(e,o),e}if("object"==typeof i){if(Array.isArray(i))return i.map(e);{let t={};return Object.keys(i).forEach((n=>{t[n]=e(i[n])})),t}}return i}(e);return{result:i,fnMap:n}}const Ge=new FinalizationRegistry((({id:e,port:t})=>{t.postMessage({type:"rF",id:e})}));function Ze(e,t,n,i,o){let r=new Map;t.forEach(((e,t)=>{if(!r.has(e)){let t=(...t)=>new Promise(((r,a)=>{let s=Qe(t,i),l=qe();i.set(l,r),o.set(l,a),n.postMessage({type:"fn",id:e,param:s.result,fnMap:s.fnMap.size>0?s.fnMap:void 0,cb:l})}));r.set(e,t),Ge.register(t,{id:e,port:n})}}));const a=e=>{if("object"==typeof e){if(t.has(e))return r.get(t.get(e));if(Array.isArray(e))return e.map(a);{let t={};return Object.keys(e).forEach((n=>{t[n]=a(e[n])})),t}}return e};return{result:a(e)}}class et{cbList=[];onceCbList=[];add(e){this.cbList.push(e)}addOnce(e){this.onceCbList.push(e)}remove(e){let t=this.cbList.indexOf(e);t>-1?this.cbList.splice(t,1):(t=this.onceCbList.indexOf(e),t>-1&&this.onceCbList.splice(t,1))}removeAll(){this.cbList=[],this.onceCbList=[]}trigger(e){this.cbList.forEach((t=>{t(e)})),this.onceCbList.forEach((t=>{t(e)})),this.onceCbList=[]}}class tt{#d=null;#u=null;#m=!1;#p=!1;#h=new AbortController;#g=new et;apiObj={};#f=new Map;#y=new Map;constructor(e=document.body){if(!("sandbox"in HTMLIFrameElement.prototype)||!Object.hasOwn(HTMLIFrameElement.prototype,"contentDocument"))throw"sandbox property are not supported";let t=document.createElement("iframe");t.sandbox.add("allow-scripts"),t.style.display="none",t.srcdoc=["<!DOCTYPE html>","<html>","<head>",'<meta charset="utf-8" />',"<title>iframe sandbox</title>",'<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />',"</head>","<body>","<script>",Ke,"<\/script>","</body>","</html>"].join("");let n=new MessageChannel,i=n.port1;i.addEventListener("message",(async e=>{let t=e.data;switch(t.type){case"ready":this.#m=!0,this.#g.trigger();break;case"fn":if(this.#f.has(t.id)){let e=t.fnMap?Ze(t.param,t.fnMap,i,this.#f,this.#y).result:t.param;try{let n=await this.#f.get(t.id)(...e);if(t.cb){let e=Qe(n,this.#f);i.postMessage({type:"sol",id:t.cb,param:[e.result],fnMap:e.fnMap.size>0?e.fnMap:void 0})}}catch(e){t.cb&&i.postMessage({type:"rej",id:t.cb,param:[e]})}}break;case"rF":this.#f.delete(t.id);break;case"sol":{let e=t.fnMap?Ze(t.param,t.fnMap,i,this.#f,this.#y).result:t.param;this.#f.has(t.id)&&this.#f.get(t.id)(...e),this.#f.delete(t.id),this.#y.delete(t.id);break}case"rej":this.#y.has(t.id)&&this.#y.get(t.id)(...t.param),this.#f.delete(t.id),this.#y.delete(t.id)}}),{signal:this.#h.signal}),t.addEventListener("load",(()=>{if(!this.#m&&!this.#p){if(t.contentDocument)throw"sandbox isolation failed";i.start(),t.contentWindow.postMessage("setMessagePort","*",[n.port2])}}),{signal:this.#h.signal}),e.appendChild(t),this.#d=t,this.#u=i}async waitAvailable(){return new Promise(((e,t)=>{this.#m?e():this.#g.addOnce(e)}))}async execJs(e){this.#m||await this.waitAvailable();let t=Qe(this.apiObj,this.#f);this.#u.postMessage({type:"execJs",js:e,param:t.result,fnMap:t.fnMap.size>0?t.fnMap:void 0,paramList:["api"]})}get iframe(){return this.#d}destroy(){this.#p||(this.#p=!0,this.#d.remove(),this.#d=null,this.#h.abort(),this.#h=null,this.#u.close(),this.#u=null,this.#f=null,this.#y=null,this.#g.removeAll(),this.#g=null,this.#m=!1)}}function nt(e=!1){let t=0,n=0,i=280,o=190,r=null,a=null,s=null,l=null,c=b.getElement([f({display:"none",position:"fixed",overflow:"hidden",border:"1px white solid",backgroundColor:"rgba(30, 30, 30, 0.85)",backdropFilter:"blur(2px)",color:"rgba(255, 255, 255)",alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"1.1em",boxSizing:"border-box",padding:"10px",borderRadius:"3px",pointerEvents:"none",resize:"both",boxShadow:"rgba(0, 0, 0, 0.5) 5px 5px 10px",zIndex:"20001",height:"190px",width:"280px"}),["plug-in",f({position:"absolute",left:"0",top:"0",right:"0",cursor:"move",lineHeight:"1.5em",backgroundColor:"rgba(100, 100, 100, 0.2)"}),e=>{let i=0,o=0,r=e=>{e.hold?(e.pressing&&(i=t,o=n),t=i+e.x-e.sx,n=o+e.y-e.sy,t<0?t=0:t>=ne.element.clientWidth-c.element.offsetWidth&&(t=ne.element.clientWidth-c.element.offsetWidth),n<0?n=0:n>=ne.element.clientHeight-c.element.offsetHeight&&(n=ne.element.clientHeight-c.element.offsetHeight),c.setStyle("left",`${t}px`),c.setStyle("top",`${n}px`),l.setStyle("pointerEvents","none")):l.setStyle("pointerEvents","auto")};M(e,r),P(e,r)},new p("touchend",(()=>{null!=r?(clearTimeout(r),r=null):a.setDisplay("block"),r=setTimeout((()=>{r=null,a.setDisplay("none")}),2500)}))],["-",f({position:"absolute",right:"4px",top:"1px",cursor:"default",fontSize:"1.5em",lineHeight:"1em"}),new p("click",(()=>{c.setDisplay("none")}))],[f({position:"absolute",top:"1.5em",bottom:"0",left:"0",right:"0",overflow:"auto"}),new u((e=>{s=e}))],[f({position:"absolute",right:"0.5px",bottom:"0.5px",height:"1.5em",aspectRatio:"1",cursor:"nwse-resize",display:"none",boxSizing:"border-box",borderRight:"0.75em blue solid",borderBottom:"0.75em blue solid",borderTop:"0.75em transparent solid",borderLeft:"0.75em transparent solid"}),new p("click",(()=>{c.setDisplay("none")})),new u((e=>{a=e})),new u((e=>{var t=0,n=0,r=e=>{e.hold?(e.pressing&&(t=i,n=o),i=t+e.x-e.sx,o=n+e.y-e.sy,c.setStyle("width",`${i}px`),c.setStyle("height",`${o}px`),l.setStyle("pointerEvents","none")):l.setStyle("pointerEvents","auto")};M(e,r),P(e,r)}))]]);ne.addChild(c),new ResizeObserver((()=>{i=c.element.offsetWidth,o=c.element.offsetHeight,t>ne.element.clientWidth-i&&c.setStyle("width",(i=ne.element.clientWidth-t)+"px"),n>ne.element.clientHeight-o&&c.setStyle("height",(o=ne.element.clientHeight-n)+"px"),t<0&&(t=0,c.setStyle("left",`${t}px`)),n<0&&(n=0,c.setStyle("top",`${n}px`))})).observe(c.element);let d=null;return e?(l=v(document.createElement("iframe")),s.addChild(l)):(d=new tt(s.element),l=v(d.iframe)),l.setStyles({display:"block",border:"none",height:"100%",width:"100%"}),{windowElement:c,sandbox:d,iframe:l}}let it=[{sender:"系统",content:`forge已加载 ${(new Date).toLocaleString()}`}],ot=null;function rt(e){e?(e(it.slice(-100)),ot=e):ot=null}let at=!1;function st(){if(at)return;at=!0;let e="",t="";ce.event.roomMessage.add((n=>{!function(n){let i=[],o=ce.operation.getUserRoomId();if(o!=e){let n=ce.operation.getRoomInfoById(o)?.name;i.push({sender:"系统",content:`房间切换 ${t}->${n||o}`}),e=o,t=n}if(i.push({sender:n.senderName,content:n.content}),i.length>0){for(it.push(...i);it.length>=500;)it.shift();ot&&ot(i)}}(n)}))}let lt=null,ct=null,dt=null,ut=null,mt=null;async function pt(){if(!lt){lt=nt(!0),lt.iframe.element.src="about:blank",await new Promise((e=>{lt.iframe.addEventListener("load",(()=>{e()}))})),ct=lt.iframe.element.contentWindow;let e=v(ct.document.body);e.setStyles({margin:"0",position:"absolute",left:"0",top:"0",width:"100%",height:"100%"}),e.addChild(b.getElement([f({position:"absolute",left:"0",top:"0",width:"100%",height:"100%"}),dt=b.getElement([f({position:"absolute",left:"0",top:"0",width:"100%",bottom:"27px",whiteSpace:"pre-wrap",wordBreak:"break-all",color:"white",overflow:"auto",scrollbarWidth:"thin",scrollbarColor:"rgb(120, 120, 120) rgb(160, 160, 160)"})]),ut=b.getElement([new y("input"),new m("type","text"),new m("placeholder","远程发送"),new m("size","1000"),f({position:"absolute",left:"0",bottom:"0",width:"100%",height:"27px",lineHeight:"27px",backgroundColor:k.rgb(150,150,150,.3),color:k.rgb(255,255,255)}),new p("keydown",((e,t)=>{if("Enter"==e.key&&(e.stopPropagation(),e.preventDefault(),mt)){let e=t.element.value;t.element.value="",mt(e)}}))])]))}lt.windowElement.setDisplay("block"),lt.windowElement.setStyle("pointerEvents","auto")}function ht(e){dt&&dt.addChilds(e.map((e=>b.getElement([f({margin:"2px",border:"1.5px rgba(255, 255, 255, 0.5) solid",padding:"3px"}),`${e.sender}: ${e.content}`]))))}function gt(e){ut&&(ut.element.placeholder=e)}function ft(e){mt=e}let yt="",bt="",wt="";async function xt(){function e(e,t){Te([b.getElement(["拉取此账号的配置",new p("click",(()=>{re("多账户","正在尝试获取配置");let t=K();ce.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"syncConfigRQ",id:t}),yt=t}))]),b.getElement(["戴上他的眼睛",new p("click",(()=>{bt&&(ce.operation.sendPrivateForgePacket(wt,{plug:"forge",type:"multiAccount",option:"monitorQuit",id:bt}),bt="",wt=""),re("多账户",`正在连接 ${e}`),bt=K(),wt=e,ce.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"monitorRQ",id:bt}),pt(),dt&&dt.removeChilds(),ft((e=>{e&&ce.operation.sendPrivateForgePacket(wt,{plug:"forge",type:"multiAccount",option:"monitorSend",id:bt,content:e})})),gt("正在连接中")}))]),b.getElement(["前往我所在的房间",new p("click",(()=>{re("多账户","正在发送命令"),ce.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"switchRoom",roomId:ce.operation.getUserRoomId()})}))]),b.getElement(["下线",new p("click",(async()=>{await ke("远程下线","确认发送下线指令吗?\n您必须手动重新上线此账号",!0)&&(re("多账户","正在发送命令"),ce.operation.sendPrivateForgePacket(e,{plug:"forge",type:"multiAccount",option:"quit"}))}))]),b.getElement(["移除账号",new p("click",(()=>{be.processed.myAccountSet.delete(e),be.roaming.myAccountList=be.roaming.myAccountList.filter((t=>t!=e)),xe(),re("绑定账号",`目标账号(${e})与当前账号(${ce.operation.getUserUid()})的单向绑定已解除`)}))])])}Te([b.getElement(["[ 添加账号 ]",new p("click",(async()=>{let e=await Se("添加账号","请输入您其他账号的唯一标识\n必须双向绑定才能进行管理",!0);if(null!=e){let t=ce.operation.getUserUid();e!=t?(be.processed.myAccountSet.add(e),be.roaming.myAccountList.push(e),xe(),re("绑定账号",`你需要同时在目标账号(${e})上绑定当前账号(${t})来完成反向绑定`)):re("无法绑定","不能绑定此账号本身")}}))]),...bt?[b.getElement(["正在戴着的眼睛",new p("click",(()=>{pt()}))]),b.getElement(["停止戴着眼睛",new p("click",(()=>{ft(null),ht([{sender:"系统",content:"您已断开远程连接"}]),ce.operation.sendPrivateForgePacket(wt,{plug:"forge",type:"multiAccount",option:"monitorQuit",id:bt}),bt="",wt="",gt("已断开")}))])]:[],...be.roaming.myAccountList.map((t=>{let n=ce.operation.getOnlineUserInfoById(t);return b.getElement([`${t}${n?` (${n.name})`:""}`,new p("click",(async()=>{e(t,n?.name)}))])}))])}let vt=0,kt="",St="",It=!1;function Et(){It||(It=!0,He.forge.privateForgePacket.add((e=>{if("multiAccount"==e.content.type){if(!be.processed.myAccountSet.has(e.senderId))return;let t=ce.operation.getOnlineUserInfoById(e.senderId),n=!1;try{switch(e.content.option){case"switchRoom":ce.operation.changeRoom(e.content.roomId);break;case"quit":setTimeout((()=>{let e=W.iframeWindow?.location?.reload?.bind(W.iframeWindow.location);if(W.iframeBody?.addChild(b.getElement([f({position:"absolute",left:"0",top:"0",width:"100%",height:"100%",zIndex:"9999999",backgroundColor:"rgb(28, 28, 28)",cursor:"default",whiteSpace:"pre-wrap",textAlign:"center",color:"rgb(255, 255, 255)"}),[f({position:"absolute",inset:"0 0 0 0",height:"fit-content",width:"fit-content",margin:"auto",backgroundColor:"rgb(21, 21, 21)",padding:"10px",borderRadius:"3px"}),`已通过远程指令下线\n下线时间: ${(new Date).toLocaleString()}\n点击恢复`,new p("click",(()=>{e()}))]])),W.iframeWindow.Utils?.service?.saveStatus?.(0),W.socket)try{W.socket.onclose=null,W.socket.onerror=null,W.socket.send=()=>{},W.socket.onmessage=()=>{},W.socket?.close()}catch(e){console.error(e)}W.iframeWindow.addEventListener("keydown",(e=>e.stopImmediatePropagation()),!0),W.iframeWindow.addEventListener("keyup",(e=>e.stopImmediatePropagation()),!0),W.iframeWindow.addEventListener("keypress",(e=>e.stopImmediatePropagation()),!0),W.iframeWindow.addEventListener("mousemove",(e=>e.stopImmediatePropagation()),!0),W.iframeWindow.addEventListener("mousedown",(e=>e.stopImmediatePropagation()),!0),W.iframeWindow.addEventListener("mouseup",(e=>e.stopImmediatePropagation()),!0),W.iframeWindow.location&&(W.iframeWindow.location._reload=()=>{})}),1e3);break;case"syncConfigRQ":{let t=e.content.id;ce.operation.sendPrivateForgePacket(e.senderId,{plug:"forge",type:"multiAccount",option:"syncConfigCB",id:t,storageObject:be.roaming});break}case"syncConfigCB":if(yt&&e.content.id==yt){yt="";let t=e.content.storageObject;t&&(t?.userRemark&&Object.keys(be.roaming.userRemark).forEach((e=>{t.userRemark[e]||(t.userRemark[e]=be.roaming.userRemark[e])})),delete t.myAccountList,we(t),xe(),re("多账号","拉取其他账号的配置成功"))}n=!0;break;case"monitorRQ":{let t=e.content.id;kt&&ce.operation.sendPrivateForgePacket(wt,{plug:"forge",type:"multiAccount",option:"monitorQuit",id:kt}),kt=t,St=e.senderId,vt=Date.now(),rt((n=>{if(Date.now()>vt+432e5)return rt(null),kt="",void(St="");ce.operation.sendPrivateForgePacket(e.senderId,{plug:"forge",type:"multiAccount",option:"monitorCB",id:t,messages:n})}));break}case"monitorSend":e.content.id==kt&&ce.operation.sendRoomMessage(e.content.content);break;case"monitorQuit":{let t=e.content.id;t==kt?(rt(null),kt="",St="",re("多账号","多账号监视已断开")):t==bt&&(ft(null),ht([{sender:"系统",content:"连接被远端断开"}]),bt="",wt="",gt("已断开")),n=!0;break}case"monitorCB":e.content.id==bt&&(ht(e.content.messages),gt(`使用 ${e.senderName} 发送消息`)),n=!0;break}}catch(e){console.error(e)}n||re("多账号",`您的账号(${e.senderId}${t?` - ${t.name}`:""})\n正在操作`)}})))}let Ct=!1,Mt="",Pt=new Map;function Lt(e){if(Ct&&!Oe(e.senderId)&&(!Pt.has(e.senderId)||Pt.get(e.senderId)<Date.now()-15e3)){Pt.set(e.senderId,Date.now());let t=setTimeout((()=>{t=null,ce.operation.sendPrivateMessage(e.senderId,`[自动回复] ${Mt}`)}),1500);re("勿扰模式","您已开启勿扰模式\n将会发送自动回复消息\n点击关闭",void 0,(()=>{Ft(!1),t&&clearTimeout(t)}))}}function Bt(e){Ct&&e.senderId!=ce.operation.getUserUid()&&-1!=e.content.indexOf(` [*${ce.operation.getUserName()}*] `)&&!Oe(e.senderId)&&(!Pt.has(e.senderId)||Pt.get(e.senderId)<Date.now()-15e3)&&(Pt.set(e.senderId,Date.now()),ce.operation.sendRoomMessage(`[自动回复]  [*${e.senderName}*]  ${Mt}`),re("勿扰模式","您已开启勿扰模式\n将会发送自动回复消息\n点击关闭",void 0,(()=>{Ft(!1)})))}function At(e){null!=e?(Mt=e,Ct||(Ct=!0,ce.event.privateMessage.add(Lt),ce.event.roomMessage.add(Bt))):Ct&&(ce.event.privateMessage.remove(Lt),ce.event.roomMessage.remove(Bt),Ct=!1)}let $t=!1;function Ft(e){"boolean"==typeof e?$t=e:"switch"==e&&($t=!$t),$t?(At(String(be.roaming.notDisturbModeAutoReply)),re("勿扰模式","已开启勿扰模式\n私聊 和 @您的信息 将自动回复")):(At(null),re("勿扰模式","已关闭勿扰模式"))}async function Tt(){await R(1100),[{key:"disableDoubleClickFullScreen",cb:()=>{W.iframeBody.addEventListener("dblclick",(e=>e.stopPropagation()))}},{key:"disableRightEdgeTrigger",cb:()=>{Array.from(W.iframeDocument.getElementById("msgholderDisplay").children).some((e=>{let t=e.getAttribute("onmouseenter");return"string"==typeof t&&-1!=t.indexOf("buttonProcesser(12)")&&(e.remove(),!0)}))}},{key:"f5RefreshInside",cb:()=>{W.iframeWindow?.addEventListener("keydown",(e=>{"F5"==e.key&&(e.preventDefault(),e.stopPropagation(),W.iframeWindow?.location?.reload?.())}),!0)}}].forEach((e=>{if(be.local.patch[e.key])try{e.cb()}catch(e){console.error(e)}}))}let jt="",Dt=0;function Rt(){re("聊天记录同步","正在尝试获取聊天记录");let e=K();ce.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncPrivateChatRecordRQ",id:e,startTime:Math.max(Date.now()-2592e5,be.local.lastCloseTime-108e6,be.local.syncChatRecordTo-9e5),endTime:Date.now()+3e4}),jt=e,Dt=Date.now()}let Ot=!1;function Wt(){Ot||(Ot=!0,He.forge.selfPrivateForgePacket.add((e=>{if(jt&&"syncPrivateChatRecordCB"==e.content.type&&e.content.id==jt&&Dt+35e3>=Date.now()&&e.content.content){let t=function(e,t){let n=0,i=Nt(),o=new Map(i.map((e=>[e.uid,e])));return e.forEach((e=>{let i=o.get(e.uid);if(i){let o=new Map;for(let e=i.records.length-1;e>=0;e--){let n=Ht(i.records[e]),r=n[1],a=n[3];if(r<t-6e4)break;o.set(a,n)}e.records.forEach((e=>{let t=Ht(e)[3];o.has(t)||n++}))}else n+=e.records.length})),n}(e.content.content,e.content.startTime);0==t?re("聊天记录同步","本地聊天记录已为最新"):re("聊天记录同步",`从其他设备获取到 ${t} 条记录\n点击合并记录到当前设备`,void 0,(()=>{be.local.syncChatRecordTo=Math.min(Date.now(),e.content.endTime),Number.isNaN(be.local.syncChatRecordTo)&&(be.local.syncChatRecordTo=Date.now()),ve(),function(e,t){let n=Nt(),i=new Map(n.map((e=>[e.uid,e])));e.forEach((e=>{let o=i.get(e.uid);if(o){let n=new Map;for(let e=o.records.length-1;e>=0;e--){let i=Ht(o.records[e]),r=i[1],a=i[3];if(r<t-3e5)break;n.set(a,i)}let i=o.records.length;for(let t=e.records.length-1;t>=0;t--){let r=Ht(e.records[t]),a=r[1],s=r[3];if(!n.has(s)){for(;i>0&&Ht(o.records[i-1])[1]>a;)i--;o.records.splice(i,0,r)}}}else n.push(e)})),function(e){let t=e.map((e=>[e.uid,e.info.map(((t,n)=>(7==n||8==n)&&e.records.length>0?Ht(e.records.at(-1))[3]:t)).join(">"),e.records.map((e=>"string"==typeof e?e:[e[0]?"1":"",Math.floor(e[1]/1e3).toString(10),...e.slice(2)].join("'"))).join(">"),e.records.length.toString(10)].join('"'))).join("<");localStorage.setItem(`pmLog_${ce.operation.getUserUid()}`,t)}(n);let o=W.iframeWindow.Utils.service.saveStatus.bind(W.iframeWindow.Utils.service);W.iframeWindow.Utils.service.saveStatus=()=>{for(let e=0;e<=11;e++)7!=e&&o(e,1)},W.iframeWindow.location.reload()}(e.content.content,e.content.startTime)}))}if("syncPrivateChatRecordRQ"==e.content.type){let t=Number(e.content.startTime),n=Number(e.content.endTime);if(Number.isNaN(t)||Number.isNaN(n)||!(t<n))return;let i=Nt(),o=[];i.forEach((e=>{if(0==e.records.length||!(Ht(e.records.at(-1))[1]>=t))return;let i=[];for(let o=e.records.length-1;o>=0;o--){let r=Ht(e.records[o]),a=r[1];if(a<t)break;if(t<=a&&a<n){let e=r[2];e.startsWith("iiroseForge:")&&e.endsWith(":end")||i.push(r)}}i.length>0&&(i.sort(((e,t)=>e[1]-t[1])),o.push({name:e.name,info:e.info,uid:e.uid,otherInfo:e.otherInfo,records:i}))}));let r=e.content.id;ce.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncPrivateChatRecordCB",id:r,content:o,startTime:t,endTime:n}),re("聊天记录同步","其他设备正在拉取本机聊天记录")}})))}function Nt(){W.iframeWindow.Utils?.service?.saveStatus?.(7,1);let e=localStorage.getItem(`pmLog_${ce.operation.getUserUid()}`);return e?e.split("<").map((e=>{let t=e.split('"').map((e=>e.split(">")));return{uid:t[0]?.[0],name:t[1]?.[2],info:t[1],records:t[2],otherInfo:t[3]}})):[]}function Ht(e){if("string"==typeof e){let t=e.split("'"),n=1e3*Number(t[1]);return["1"==t[0],n,...t.slice(2)]}return e}async function Ut(){let e=Nt(),t=ce.operation.getUserUid(),n=ce.operation.getUserName(),i=new Date("2023/1/1").getTime(),o=new Date("2024/1/1").getTime();const r=864e5;let a=Math.round((o-i)/r),s=0,l=0,c=0,d=0,u=new Map,h=new Array(48).fill(0).map((()=>({count:0,isPeakTime:!1}))),g=new Array(24).fill(0).map((()=>({count:0}))),w=new Array(400).fill(0).map((()=>({count:0}))),x=0,v=new Map,k=new Map,S=[];e.forEach((e=>{if(e.uid==t)return;let n=u.get(e.uid);n||(n={targetName:e.name,sendCount:0,receiveCount:0,nightMessageCount:0,secondHalfOfTheYear:0,continuousChatMaxDuration:0,continuousChatMaxStartTime:0,nightContinuousChatMaxDuration:0,nightContinuousChatMaxStartTime:0},u.set(e.uid,n));let a=!1,m=0,p=0,f=0;e.records.forEach((t=>{let u=Ht(t),y=u[0],b=u[1],x=u[2];if(!(i<b&&b<o))return;if(S.push({sendBySelf:y,content:x,time:b,targetUid:e.uid}),b-p>12e5||b-f>12e5){let e=Math.max(0,Math.min(p,f)-m);e>n.continuousChatMaxDuration&&(n.continuousChatMaxDuration=e,n.continuousChatMaxStartTime=m),e>3e6&&e>n.nightContinuousChatMaxDuration&&new Date(m).getHours()<=1&&(n.nightContinuousChatMaxDuration=e,n.nightContinuousChatMaxStartTime=m),m=b}if(y){if(f=b,s++,n.sendCount++,c+=Math.min(100,x.length),a=!0,"&"!=x&&x.length<500){let e=x.match(/https?:\/\/[a-zA-Z0-9\.\_\-]+\/[a-zA-Z0-9\.\_\-\/\?\=\#\&]+?(\.(png|jpg|gif|jpeg|avif|webp))/)?.[0];if(e){let t=k.get(e);null==t&&(t=0),k.set(e,t+1)}else if(x.length<100){let e=v.get(x);null==e&&(e=0),v.set(x,e+1)}}}else p=b,l++,n.receiveCount++,d+=Math.min(100,x.length);let I=new Date(b),E=2*I.getHours()+(I.getMinutes()>=30?1:0);0<=E&&E<h.length&&(h[E].count++,0<=E&&E<10&&n.nightMessageCount++);let C=2*I.getMonth()+(I.getDate()>=16?1:0);0<=C&&C<g.length&&(g[C].count++,12<=C&&C<24&&n.secondHalfOfTheYear++);let M=Math.floor((b-i)/r);0<=M&&M<w.length&&w[M].count++}));{let e=Math.max(0,Math.min(p,f)-m);e>n.continuousChatMaxDuration&&(n.continuousChatMaxDuration=e,n.continuousChatMaxStartTime=m)}a&&x++}));let I="",E=0;v.forEach(((e,t)=>{e>E&&(E=e,I=t)}));let C="",M=0;k.forEach(((e,t)=>{e>M&&(M=e,C=t)}));let L=Array.from(u.entries()).map((e=>({targetUid:e[0],...e[1]})));L.sort(((e,t)=>t.sendCount+t.receiveCount-(e.sendCount+e.receiveCount)));let B="",A=0;L.forEach((e=>{e.nightMessageCount>A&&(A=e.nightMessageCount,B=e.targetUid)}));let $="",F=0,T=0;L.forEach((e=>{e.continuousChatMaxDuration>F&&(F=e.continuousChatMaxDuration,T=e.continuousChatMaxStartTime,$=e.targetUid)}));let O="";for(let e of L)if(e.sendCount>100&&e.receiveCount>100&&0==e.secondHalfOfTheYear){O=e.targetUid;break}let N=O?u.get(O):null,H="",U=0,z=0;L.forEach((e=>{e.nightContinuousChatMaxDuration>U&&(U=e.nightContinuousChatMaxDuration,z=e.nightContinuousChatMaxStartTime,H=e.targetUid)})),S.sort(((e,t)=>e.time-t.time));let V=[],Y=0,_=[],X=new Map;for(let e of S){if(e.sendBySelf){_.push(e);let t=X.get(e.targetUid);null==t&&(t=0),X.set(e.targetUid,t+1)}for(;_.length>0&&_[0].time<e.time-9e5;){let e=_.shift(),t=X.get(e.targetUid);t>=2?X.set(e.targetUid,t-1):X.delete(e.targetUid)}X.size>V.length&&(V=Array.from(X.keys()),Y=e.time)}console.log("-- 蔷薇年报 --"),u.forEach((e=>{0==e.sendCount&&0==e.receiveCount||console.log(`(你与 ${e.targetName}) `,e)}));let J=[],K=0;function q(e){return`${Math.floor(e/2)}:${e%2==0?"00":"30"}`}h.forEach(((e,t)=>{console.log(`(${q(t)} - ${q(t+1)}) `,"总数量:",e.count),e.count>(s+l)/h.length*1.6?e.isPeakTime=!0:(K<t&&J.push(`(${q(K)} - ${q(t)})`),K=t+1)})),K<h.length&&J.push(`(${q(K)} - ${q(h.length)})`);let Q=0,G=0;function Z(e){return`${Math.floor(e/2)%12+1}月${e%2==0?"初":"中旬"}`}g.forEach(((e,t)=>{console.log(`(${Z(t)} - ${Z(t+1)}) `,"总数量:",e.count),e.count>G&&(Q=t,G=e.count)}));let ee=0;w.forEach((e=>{0!=e.count&&ee++})),console.log("有进行私聊的天数占今年总天数的",(100*Math.min(ee/a,1)).toFixed(2),"%");let te=[[["在2023年里,",`你一共和 ${x} 位用户私聊过。`,"",`共发出了 ${s}条私信,`,`总共约 ${c} 字;`,`共收到了 ${l}条私信,`,`总共约 ${d} 字。`,s<1e3?"也许今年你在花园里并不常常私聊呢 > <":s<1e4?"与好友聊天 话总不嫌太多。":"获得 蔷薇花园 私聊小能手称号~"].join("\n")],G>60?[["这一年里,",`你进行过私聊的天数占今年总天数的 ${(100*Math.min(ee/a,1)).toFixed(2)}%,`,`${Z(Q)} 到 ${Z(Q+1)} 是你私聊最多的时候。`,"你在这半月内,",`共收发了 ${G} 条私聊消息。`,G>800?"这段时间 或许你有很多话要诉说。":"这段时间的自己 正在经历些什么呢?"].join("\n")]:null,J.length>0?[["一天之中,",`你偏爱的聊天时段是 ${J.join(", ")}。`,J.length>3?"碎片的时光, 留存着与好友的点滴。":"美好的时光格外令人珍惜。"].join("\n")]:null,L[0]?[[`与你往来私信最多的人 非 ${L[0].targetName} 莫属,`,`你们之间一共往来了 ${L[0].sendCount+L[0].receiveCount} 条私信,`,`你发出了 ${L[0].sendCount} 条, ta发出了 ${L[0].receiveCount} 条。`,"",L[1]?`与你互发私信次多的是 ${L[1].targetName} 共收发 ${L[1].sendCount+L[1].receiveCount} 条`:"",L[2]?`再其次是 ${L[2].targetName} 共收发 ${L[2].sendCount+L[2].receiveCount} 条`:""].join("\n")]:null,E>5||M>5?[E>5?["今年里,",`你最喜欢发送的内容是 "${se(I)}"`,`你一共发送过 ${E} 次。`].join("\n"):null,"\n",...M>5?[`你最喜欢发送的图片是 "${se(C)}"\n`,[new y("img"),new m("src",se(C)),f({maxHeight:"30vh",maxWidth:"30vw",border:"1px solid white"})],`\n你一共发送过 ${M} 次。`]:[]]:null,A>100?[["夜深了,",A>3e3?"但对你来说夜生活刚刚开始,":"你的私聊也在继续,",`夜间 你常常与 ${u.get(B).targetName} 畅谈,`,`你们在转钟后的收发的私聊数量达到了 ${A} 条。`].join("\n")]:null,F>54e5?[["还记得吗,",`在 ${new Date(T).toLocaleString()},`,`你与 ${u.get($).targetName} 展开了一段`,`长达 ${function(e){let t="";return e>=36e5&&(t+=`${Math.floor(e/36e5)}小时`),e%36e5>=6e4&&(t+=`${Math.floor(e%36e5/6e4)}分钟`),(e%6e4>=1e3||e<1e3)&&(t+=`${Math.floor(e%6e4/1e3)}秒`),t}(F)} 的超长的连续聊天!`].join("\n")]:null,U>3e6&&z!=T?[[`在 ${new Date(z).toLocaleDateString()},`,`从 ${new Date(z).toLocaleTimeString()}`,`到 ${new Date(z+U).toLocaleTimeString()}`,"星月交辉,",`你与 ${u.get(H).targetName} 的交流从未停歇。`].join("\n")]:null,V.length>=3?[[`${new Date(Y).toLocaleDateString()},`,"这一天里,",`你曾最多同时和 ${V.length} 位好友聊天,`,`他们分别是 ${V.map((e=>u.get(e).targetName)).join(", ")}。`].join("\n")]:null,O?[["你有过一位好友,",`${N.targetName} 曾与你互发 ${N.sendCount+N.receiveCount} 条消息,`,"今年下半,","你们不曾联系过。","也许找时间去打个招呼?"].join("\n")]:null].filter((e=>null!=e)),ne=["https://r.iirose.com/i/23/12/19/15/3650-3T.png","https://r.iirose.com/i/23/12/19/15/3658-TW.png","https://r.iirose.com/i/23/12/19/15/3707-0C.jpg","https://r.iirose.com/i/23/12/19/15/3720-73.jpg","https://r.iirose.com/i/23/12/19/15/3725-Z0.jpg","https://r.iirose.com/i/23/12/19/15/3734-09.png","https://r.iirose.com/i/23/12/19/15/3739-SD.png","https://r.iirose.com/i/23/12/19/15/3746-Q9.jpg","https://r.iirose.com/i/23/12/19/15/3756-LZ.jpg","https://r.iirose.com/i/23/12/19/15/3800-BF.jpg","https://r.iirose.com/i/23/12/19/15/3805-UG.png","https://r.iirose.com/i/23/12/19/15/3808-W0.jpg","https://r.iirose.com/i/23/12/19/15/3813-M5.jpg"];!function(e,t,n){let i=0,o=j({textElement:t[i]}),r=null,a=null,s=null,l=!0;async function c(e){l&&t[e]&&(l=!1,i=e,r.animate([{opacity:"1"},{opacity:"0"}],{duration:1e3,easing:"ease-in",fill:"forwards"}),await s.animateCommit([{backgroundColor:"rgba(0, 0, 0, 0.5)"},{backgroundColor:"rgba(0, 0, 0, 1)"}],300),a.setStyle("backgroundImage",`url("${n[e%n.length]}")`),await R(700),o.textElement=t[e],r.animate([{opacity:"0"},{opacity:"1"}],{duration:1e3,easing:"ease-in",fill:"forwards"}),await s.animateCommit([{backgroundColor:"rgba(0, 0, 0, 1)"},{backgroundColor:"rgba(0, 0, 0, 0.5)"}],500),await R(500),l=!0)}let d=b.getElement([f({position:"fixed",top:"0",left:"0",zIndex:"92000",height:"100%",width:"100%",backgroundColor:"rgb(255, 255, 255)"}),[f({opacity:"0.8",backgroundColor:"#303030",width:"100%",boxShadow:"0 0 1px rgb(0, 0, 0, 0.12), 0 1px 1px rgb(0, 0, 0, 0.24)",zIndex:"2",fontFamily:"md",height:"40px",lineHeight:"40px",fontSize:"26px",whiteSpace:"nowrap",boxSizing:"border-box",position:"relative",color:"#fff"}),[Ie("mdi-chevron-left"),f({display:"inline-flex",opacity:"0.8",backgroundColor:"#303030",boxShadow:"0 0 1px rgb(0,0,0,0.12), 0 1px 1px rgb(0,0,0,0.24)",borderRight:"1px solid rgb(255,255,255,0.3)",zIndex:"2",fontFamily:"md",width:"40px",height:"40px",lineHeight:"40px",fontSize:"26px",padding:"0 0 0 0",whiteSpace:"nowrap",boxSizing:"border-box",position:"relative",color:"#fff",justifyContent:"center",alignItems:"center"}),new p("click",(()=>{d.remove()}))],[Ie("mdi-fire"),f({display:"inline-block",opacity:"0.8",backgroundColor:"#303030",boxShadow:"0 0 1px rgb(0,0,0,0.12), 0 1px 1px rgb(0,0,0,0.24)",marginLeft:"15px",zIndex:"2",fontFamily:"md",height:"40px",lineHeight:"40px",fontSize:"26px",padding:"0 0 0 0",whiteSpace:"nowrap",boxSizing:"border-box",position:"relative",color:"#fff"})],[f({display:"inline",fontSize:"16px",opacity:"0.7",fontWeight:"bold",marginLeft:"16px",height:"100%",lineHeight:"40px",verticalAlign:"top"}),e]],[f({position:"absolute",left:"0",width:"100%",top:"40px",bottom:"0",overflow:"auto"}),[f({position:"absolute",inset:"0",margin:"auto",width:"fit-content",maxWidth:"90%",height:"fit-content",fontSize:"1.8em",whiteSpace:"pre-wrap",color:"white",zIndex:"5"}),e=>r=e,D(o,"textElement")],[f({position:"absolute",left:"0",top:"0",width:"100%",height:"100%",backgroundImage:`url("${n[i]}")`,backgroundPosition:"center",backgroundSize:"cover",zIndex:"1"}),e=>a=e],[f({position:"absolute",left:"0",top:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:"2"}),e=>s=e,e=>{e.animate([{backgroundColor:"rgba(0, 0, 0, 0)"},{backgroundColor:"rgba(0, 0, 0, 0.5)"}],1e3)}],new p("wheel",(e=>{e.deltaY>0?c(i+1):e.deltaY<0&&c(i-1)})),e=>{let t=0,n=!1,o=e=>{let o=Date.now();if(e.pressing&&(t=o,n=!0),(Math.abs(e.x-e.sx)>10||Math.abs(e.y-e.sy)>10)&&(n=!1),!e.hold)if(n&&o-t<150){let t=W.iframeDocument.elementFromPoint(e.sx,e.sy);t==W.iframeDocument.elementFromPoint(e.x,e.y)&&t.dispatchEvent(new MouseEvent("click"))}else o-t<600&&Math.abs(e.y-e.sy)>100&&Math.abs(e.x-e.sx)/Math.abs(e.y-e.sy)<.5&&(e.y-e.sy>0?c(i-1):c(i+1))};e.addEventListener("mousedown",(e=>e.preventDefault()),!0),e.addEventListener("mouseup",(e=>e.preventDefault()),!0),P(e,o),e.addEventListener("mousedown",(e=>e.stopPropagation())),e.addEventListener("mouseup",(e=>e.stopPropagation())),e.addEventListener("touchstart",(e=>e.stopPropagation())),e.addEventListener("touchend",(e=>e.stopPropagation())),e.addEventListener("touchcancel",(e=>e.stopPropagation()))}]]);W.iframeBody.addChild(d)}("2023蔷薇私聊年报",[b.getElement(["向上滑动\n领取你的2023蔷薇私聊年报"]),...te.map((e=>b.getElement(e))),b.getElement(["后面没有啦\n\n",[f({display:"inline-block",padding:"6px",border:"1px solid white",backgroundColor:"rgba(0, 0, 0, 0.7)",fontSize:"0.8em"}),"生成年报长图",new p("click",(async()=>{let e=te.map((e=>e.map((e=>"string"==typeof e?e:"")).join(""))).join("\n\n").split("\n").map((e=>{if(e.length<=50)return e;let t=[];for(let n=0,i=Math.ceil(e.length/50);n<i;n++)t.push(e.slice(50*n,50*(n+1)));return t})).flat(),t=new(W.iframeWindow?.OffscreenCanvas?W.iframeWindow?.OffscreenCanvas:OffscreenCanvas)(1500,350+30*e.length);console.log(e),re("生成年报","正在生成长图");let i=t.getContext("2d");i.fillStyle="rgb(30, 30, 30)",i.fillRect(0,0,t.width,t.height);let o=await Promise.any([new Promise((e=>{let t=new Image;t.addEventListener("load",(()=>{e(t)})),t.crossOrigin="anonymous",t.src=`${ne[Math.floor(Math.random()*ne.length)]}`})),R(4500)]);if(null!=o){let e=Math.max(t.width/o.naturalWidth,t.height/o.naturalHeight),n=t.width/e,r=t.height/e;i.drawImage(o,(o.naturalWidth-n)/2,(o.naturalHeight-r)/2,n,r,0,0,t.width,t.height),i.fillStyle="rgba(0, 0, 0, 0.5)",i.fillRect(0,0,t.width,t.height)}{let e="蔷薇花园2023年报";i.font='40px "noto", serif',i.textAlign="center",i.strokeStyle="rgba(0, 0, 0, 0.7)",i.lineWidth=3,i.lineJoin="round",i.strokeText(e,t.width/2,120),i.fillStyle="rgb(255, 255, 255)",i.fillText(e,t.width/2,120)}e.forEach(((e,n)=>{i.font='27px "noto", serif',i.textAlign="center",i.strokeStyle="rgba(0, 0, 0, 0.9)",i.lineWidth=2,i.lineJoin="round",i.strokeText(e,t.width/2,250+30*n),i.fillStyle="rgb(255, 255, 255)",i.fillText(e,t.width/2,250+30*n)})),i.fillStyle="rgba(255, 255, 255, 0.5)",i.font='24px "noto", serif',i.textAlign="center",i.fillText("由 iirose-Forge 使用 ❤ 生成",t.width/2,t.height-27),i.fillStyle="rgba(255, 255, 255, 0.5)",i.font='24px "noto", serif',i.textAlign="right",i.fillText(`${n} 的私聊年报`,t.width-35,59);let r=await t.convertToBlob({type:"image/png",quality:.9});if(5!=W.iframeWindow?.device){let e=URL.createObjectURL(r);W.iframeWindow?.showImg?.(e)}else W.iframeWindow?.showImg?.(await function(e){return new Promise(((t,n)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>n(i.error),i.onabort=()=>n(new Error("Read aborted")),i.readAsDataURL(e)}))}(r));re("生成年报","重新生成可以使用不同背景哦\n长按(右键)图片保存")}))]])],["https://r.iirose.com/i/23/10/11/21/3338-QK.jpg","https://r.iirose.com/i/22/12/18/15/4513-0A.png","https://r.iirose.com/i/22/5/11/15/3838-IY.jpg","https://r.iirose.com/i/23/9/7/1/1047-5Y.jpg","https://r.iirose.com/i/23/8/24/5/0224-LF.jpg","https://r.iirose.com/i/23/12/17/16/2214-M1.jpg","https://r.iirose.com/i/23/12/17/16/2223-ZH.jpg","https://r.iirose.com/i/23/12/17/16/2229-EV.jpg","https://r.iirose.com/i/23/12/17/16/2237-6O.jpg","https://r.iirose.com/i/23/12/17/16/2242-AR.jpg","https://r.iirose.com/i/23/12/17/16/2334-XA.jpg","https://r.iirose.com/i/23/12/17/16/2319-TO.png"])}class zt{element=null;list=[];relativePosition=0;currentRowIndex=0;startRowIndex=0;menu=null;constructor(){this.element=b.getElement([f({position:"absolute",width:"700px",maxWidth:k.diFull("50px"),maxHeight:k.diFull("50px"),minHeight:"700px",inset:"0 0 0 0",margin:"auto",transform:"none",display:"none",backgroundColor:"rgba(0, 0, 0, 0.1)",overflow:"hidden"})])}setRelativePosition(e){(-1<=e&&e<=1||-1<=this.relativePosition&&this.relativePosition<=1)&&(this.element.setDisplay("block"),this.element.animate([{transform:zt.#b(this.relativePosition)},{transform:zt.#b(e)}],{duration:140,easing:"cubic-bezier(0.33, 1, 0.68, 1)",fill:"forwards"})),this.relativePosition=e}static#b(e){return 0==e?"none":`scale(0.8) translateX(${(e>0?15:-15)+105*e}%)`}addChild(e,t,n){this.list.push({element:e,execute:t,optionMenu:n}),this.element.addChild(e)}clearChild(){this.list.forEach((e=>e.element.remove())),this.list=[]}setCurrentRow(e){if(0==this.list.length)return void this.menu.setCursorIndicator(null);e<0?e=0:e>=this.list.length&&(e=this.list.length-1);let t=this.list[e].element;this.currentRowIndex=e,t.element.offsetTop<this.element.element.scrollTop?this.element.element.scrollTop=this.list[e].element.element.offsetTop:t.element.offsetTop+t.element.clientHeight>this.element.element.scrollTop+this.element.element.clientHeight&&(this.element.element.scrollTop=t.element.offsetTop+t.element.clientHeight-this.element.element.clientHeight),this.menu.setCursorIndicator(t.element.getBoundingClientRect())}triggerCurrent(){this.currentRowIndex!=this.startRowIndex&&this.list[this.currentRowIndex]?.execute()}triggerCurrentOptionMenu(){this.list[this.currentRowIndex]?.optionMenu?.()}}class Vt{visible=!1;menuList=[];menuElement=null;menuPointerX=0;menuPointerY=0;currentColumnIndex=0;startColumnIndex=0;cursorScaleSizeX=375;cursorScaleSizeY=75;cursorIndicator={element:null,visible:!1,x:0,y:0,width:0,height:0};constructor(){this.menuElement=b.getElement([f({height:"100%",width:"100%",top:"0",left:"0",position:"fixed",backgroundColor:"rgba(230, 230, 230, 0.5)",zIndex:"10000000"}),W.iframeWindow?.isMobile?null:[f({width:"100%",left:"0",bottom:"2px",position:"fixed",color:"rgba(0, 0, 0, 0.8)",textAlign:"center"}),"鼠标 或 WASD 移动 | 松开右键 确认 | E 选项设置 | Q 放弃选择"],this.cursorIndicator.element=b.getElement([f({display:"none",position:"absolute",top:"50%",left:"50%",width:"0px",height:"0px",border:"5px rgba(255, 255, 255, 0.7) solid",boxShadow:"0px 0px 5px 1px rgba(13, 14, 17, 0.7)",boxSizing:"border-box",zIndex:"100"})])])}addColumn(e){this.menuList.push(e),e.menu=this,this.menuElement.addChild(e.element),e.setRelativePosition(this.menuList.length-1-this.currentColumnIndex)}setCurrentColumn(e){e<0?e=0:e>=this.menuList.length&&(e=this.menuList.length-1),this.currentColumnIndex!=e&&(this.currentColumnIndex=e,this.menuList.forEach(((e,t)=>e.setRelativePosition(t-this.currentColumnIndex))))}draw(){let e=-(this.startColumnIndex+.5)*this.cursorScaleSizeX,t=(this.menuList.length-this.startColumnIndex-.5)*this.cursorScaleSizeX;this.menuPointerX>=t?this.menuPointerX=t-1:this.menuPointerX<e&&(this.menuPointerX=e);let n=this.startColumnIndex+Math.round(this.menuPointerX/this.cursorScaleSizeX);this.setCurrentColumn(n);let i=this.menuList[this.currentColumnIndex],o=-(i.startRowIndex+.5)*this.cursorScaleSizeY,r=(i.list.length-i.startRowIndex-.5)*this.cursorScaleSizeY;this.menuPointerY>=r?this.menuPointerY=r-1:this.menuPointerY<o&&(this.menuPointerY=o);let a=i.startRowIndex+Math.round(this.menuPointerY/this.cursorScaleSizeY);i.setCurrentRow(a);let s=this.menuPointerY/this.cursorScaleSizeY-Math.round(this.menuPointerY/this.cursorScaleSizeY)+.5,l=this.menuPointerX/this.cursorScaleSizeX-Math.round(this.menuPointerX/this.cursorScaleSizeX)+.5;this.cursorIndicator.visible&&this.cursorIndicator.element.setStyle("borderImage",`linear-gradient(0deg, rgb(170, 170, 170), rgb(255, 255, 255) ${(100*(1-s)).toFixed(1)}%, rgb(170, 170, 170)) 30`),this.menuElement.setStyle("backgroundImage",`linear-gradient(90deg, rgba(170, 170, 170, 0.5), rgba(235, 235, 235, 0.6) ${(100*l).toFixed(1)}%, rgba(170, 170, 170, 0.5))`)}show(){this.visible||(this.menuElement.animate([{opacity:"0.5"},{transform:"",opacity:"1"}],83),this.menuElement.setDisplay("block"),W.iframeDocument.body.contains(this.menuElement.element)||W.iframeDocument.body.appendChild(this.menuElement.element),this.visible=!0,this.draw(),function(e){let t=!1,n=0,i=performance.now(),o=i,r=()=>{n=0;let a=performance.now();t||1==e(a-i,a-o)||(o=a,n=requestAnimationFrame(r))};n=requestAnimationFrame(r)}((()=>(this.draw(),!this.visible))))}hide(){this.visible&&(this.visible=!1,this.menuElement.setDisplay("none"))}menuPointerMove(e,t){this.menuPointerX+=1*e,this.menuPointerY+=1*t}menuPointerReset(){this.startColumnIndex=this.currentColumnIndex,this.menuList.forEach((e=>e.startRowIndex=e.currentRowIndex)),this.menuPointerX=0,this.menuPointerY=0}triggerCurrent(){try{this.menuList[this.currentColumnIndex]?.triggerCurrent()}catch(e){console.error(e)}}triggerCurrentOptionMenu(){try{this.menuList[this.currentColumnIndex]?.triggerCurrentOptionMenu()}catch(e){console.error(e)}}setCursorIndicator(e){if(e){const t=.001;(Math.abs(e.x-this.cursorIndicator.x)>=t||Math.abs(e.y-this.cursorIndicator.y)>=t||Math.abs(e.width-this.cursorIndicator.width)>=t||Math.abs(e.height-this.cursorIndicator.height)>=t||!this.cursorIndicator.visible)&&(this.cursorIndicator.x=e.x,this.cursorIndicator.y=e.y,this.cursorIndicator.width=e.width,this.cursorIndicator.height=e.height,this.cursorIndicator.visible=!0,this.cursorIndicator.element.setDisplay("block"),this.cursorIndicator.element.animate([{},{left:this.cursorIndicator.x.toFixed(3)+"px",top:this.cursorIndicator.y.toFixed(3)+"px",width:this.cursorIndicator.width.toFixed(3)+"px",height:this.cursorIndicator.height.toFixed(3)+"px"}],{duration:120,easing:"cubic-bezier(0.33, 1, 0.68, 1)",fill:"forwards"}))}else this.cursorIndicator.visible&&(this.cursorIndicator.visible=!1,this.cursorIndicator.element.setDisplay("none"))}}function Yt(e,t,n){e.sort(((e,t)=>{function i(e){if(null==e.id)return 0;let t=be.local.superMenuPriority?.[n]?.[e.id];return null==t?1<<30:t>0?(1<<30)-t:t<0?(1<<31)-t:void 0}return i(e)-i(t)})).forEach(((e,i)=>{t.addChild(e.item,e.execute,(()=>{e.id&&Te([b.getElement(["置底于无动作上方",new p("click",(()=>{let t=be.local.superMenuPriority[n];t||(t={},be.local.superMenuPriority[n]=t);let i=0;Object.keys(t).forEach((n=>{n!=e.id&&t[n]<0&&(i=Math.min(i,t[n]))})),t[e.id]=i-1,ve()}))]),b.getElement(["置顶于无动作下方",new p("click",(()=>{let t=be.local.superMenuPriority[n];t||(t={},be.local.superMenuPriority[n]=t);let i=0;Object.keys(t).forEach((n=>{n!=e.id&&t[n]>0&&(i=Math.max(i,t[n]))})),t[e.id]=i+1,ve()}))]),b.getElement(["取消自定义位置",new p("click",(()=>{be.local.superMenuPriority[n]&&(delete be.local.superMenuPriority[n][e.id],ve())}))])])})),e.id||(t.currentRowIndex=i)}))}function _t(e,t=""){let n=ce.operation.getRoomInfoById(e);return n?Xt("http"+n.roomImage,n.name,n.description,"hidden"!=n.currentUserNum?`${n.currentUserNum}人`:"隐藏人数",t,`rgba(${n.color}, 0.8)`):Xt("","不存在的房间","","","","rgba(0, 0, 0, 0.8)")}function Xt(e,t,n,i="",o="",r="rgba(240, 240, 240, 0.8)"){let a=function(e){let t=r.indexOf("(");-1!=t&&(e=e.slice(t+1,e.lastIndexOf(")")));let n=e.split(",").map((e=>Number.parseInt(e)));return.299*n[0]+.587*n[1]+.114*n[2]>186}(r)?"rgba(0, 0, 0, 0.75)":"rgba(255, 255, 255, 0.75)";return b.getElement([Ie("sessionHolderPmTaskBoxItem"),f({backgroundColor:r,color:a}),[f({height:"100px",width:"100px",position:"relative",WebkitMaskImage:"linear-gradient(to right,#000 50%,transparent)",display:e?"block":"none"}),[Ie("bgImgBox"),e.startsWith("mdi-")?[f({width:"100%",height:"100%",textAlign:"center"}),[f({lineHeight:"100px",fontSize:"50px",fontFamily:"md",height:"100%"}),Ie(e),new y("span")]]:[Ie("bgImg"),new y("img"),new m("loading","lazy"),new m("decoding","async"),new m("src",e)],[Ie("fullBox")]]],[f({height:"100%",position:"absolute",top:"0",left:"100px",right:"0"}),[Ie("sessionHolderPmTaskBoxItemName textOverflowEllipsis"),[f({fontSize:"inherit",fontWeight:"inherit"}),t]],[Ie("sessionHolderPmTaskBoxItemTime textOverflowEllipsis"),i],[Ie("sessionHolderPmTaskBoxItemMsg textOverflowEllipsis"),n]],[f({position:"absolute",top:"1px",right:"1px",backgroundColor:a,color:r,fontSize:"16px",fontWeight:"bold",padding:"0px 8px",height:"26.5px",lineHeight:"26.5px",transition:"transform 0.25s ease 0s",borderRadius:"0px 0px 0px 2px",display:o?"block":"none"}),o]])}let Jt=[{name:"右键延迟显示时间",key:"rightButtonDelay",type:"number",min:50,max:500,default:125},{name:"右Alt键打开超级菜单",key:"rightAltEnable",type:"boolean"}],Kt=new Map(Jt.map((e=>[e.key,e])));function qt(e){let t=Kt.get(e);if(!t)throw"A non-existent option key was accessed";let n=be.local.superMenuOption[e];switch(t.type){case"text":return n||t.default;case"number":return n?Number(n):t.default;case"boolean":return"true"==n;default:return n}}let Qt="";let Gt=!1;function Zt(){Gt||(Gt=!0,He.forge.selfPrivateForgePacket.add((e=>{if(Qt&&"syncConfigCB"==e.content.type&&e.content.id==Qt){Qt="";let t=e.content.storageObject;t&&(t?.userRemark&&Object.keys(be.roaming.userRemark).forEach((e=>{t.userRemark[e]||(t.userRemark[e]=be.roaming.userRemark[e])})),we(t),xe(),re("配置同步","拉取配置成功"))}if("syncConfigRQ"==e.content.type){let t=e.content.id;ce.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncConfigCB",id:t,storageObject:be.roaming}),re("配置同步","其他设备正在拉取本机配置")}})))}const en={version:"alpha v1.19.3"},tn={operation:{showForgeNotice:"显示forge通知",getUserName:"获取你的昵称",getUserUid:"获取你的uid",getUserRoomId:"获取所在房间id",getUserProfilePictureUrl:"获取你的头像",getUserInputColor:"获取你的主题色",sendRoomMessage:"在房间中发送信息",sendRoomForgePacket:"在房间中发送forge数据包",sendPrivateMessageSilence:"[危险]静默发送私聊消息",sendPrivateMessage:"[危险]发送私聊消息",sendSelfPrivateMessageSilence:"向自己静默发送私聊消息(同账号多设备间通信)",giveALike:"进行点赞",switchRoom:"切换所在房间"},event:{roomMessage:"接收房间消息",roomForgePacket:"接收房间forge数据包",privateMessage:"[危险]接收私聊消息",selfPrivateMessage:"接收自己(其他设备)发送给自己的私聊消息"}};async function nn(e,t,n){let{sandbox:i,windowElement:o}=function(){let e=nt(!1);return{windowElement:e.windowElement,sandbox:e.sandbox}}();await i.waitAvailable();let r=n?.operationPermissionSet?n?.operationPermissionSet:new Set,a=n?.eventPermissionSet?n?.eventPermissionSet:new Set,s={applyPermission:async(t,n)=>{if(t=t.filter((e=>Boolean(tn.operation[e]))),n=n.filter((e=>Boolean(tn.event[e]))),t.every((e=>r.has(e)))&&n.every((e=>a.has(e))))return!0;let i=await ke("权限申请",[`是否允许 ${e} 获取以下权限?`,...t.map((e=>"+ "+tn.operation[e])),...n.map((e=>"+ "+tn.event[e]))].join("\n"),!0);return i&&(t.forEach((e=>{tn.operation[e]&&r.add(e)})),n.forEach((e=>{tn.event[e]&&a.add(e)})),on.savePlugList()),!!i}};Object.keys(ce.operation).forEach((t=>{tn.operation[t]&&(s[t]=(...n)=>{if(r.has(t))try{ce.state.plug={name:e};let i=ce.operation[t](...n);return ce.state.plug=null,i}catch(e){return void(ce.state.plug=null)}})})),s.addEventListener=(e,t)=>{tn.event[e]&&ce.event[e]&&a.has(e)&&ce.event[e].add(t)},i.apiObj={iiroseForge:s};let l="document.body.innerHTML='<div style=\"color:white\">network_error</div>';";try{l=await(await fetch(t)).text()}catch(e){}return i.execJs(l),{sandbox:i,windowElement:o,operationPermissionSet:r,eventPermissionSet:a}}const on=new class{map=new Map;async addPlug(e,t,n){this.map.has(e)||this.map.set(e,{url:t,...await nn(e,t,n)})}showPlugWindow(e){if(this.map.has(e)){let t=this.map.get(e).windowElement;t.setDisplay("block"),t.setStyle("pointerEvents","auto")}}removePlug(e){this.map.has(e)&&(this.map.get(e).sandbox.destroy(),this.map.delete(e))}savePlugList(){let e=[];this.map.forEach(((t,n)=>{e.push([n,t.url,Array.from(t.operationPermissionSet.values()),Array.from(t.eventPermissionSet.values())])})),be.roaming.plugInfo=e,xe()}readPlugList(){try{let e=be.roaming.plugInfo;e.length>0&&(e.forEach((([e,t,n,i])=>{this.addPlug(e,t,{operationPermissionSet:new Set(n),eventPermissionSet:new Set(i)})})),re("iiroseForge plug-in",`已加载 ${e.length} 个插件`))}catch(e){}}};function rn(){let e=b.getElement([g("position","fixed"),g("top","0"),g("left","0"),g("zIndex","91000"),g("height","100%"),g("width","100%"),g("backgroundColor","rgba(255, 255, 255, 0.75)"),g("backdropFilter","blur(3px)"),[g("opacity","0.8"),g("backgroundColor","#303030"),g("width","100%"),g("boxShadow","0 0 1px rgb(0, 0, 0, 0.12), 0 1px 1px rgb(0, 0, 0, 0.24)"),g("zIndex","2"),g("fontFamily","md"),g("height","40px"),g("lineHeight","40px"),g("fontSize","26px"),g("padding","0 16px 0 16px"),g("whiteSpace","nowrap"),g("boxSizing","border-box"),g("position","relative"),g("color","#fff"),[Ie("mdi-anvil"),f({display:"inline",opacity:"0.8",backgroundColor:"#303030",boxShadow:"0 0 1px rgb(0,0,0,0.12), 0 1px 1px rgb(0,0,0,0.24)",zIndex:"2",fontFamily:"md",height:"40px",lineHeight:"40px",fontSize:"26px",padding:"0 0 0 0",whiteSpace:"nowrap",boxSizing:"border-box",position:"relative",color:"#fff"})],[g("display","inline"),g("fontSize","16px"),g("opacity","0.7"),g("fontWeight","bold"),g("marginLeft","16px"),g("height","100%"),g("lineHeight","40px"),g("display","inline"),g("verticalAlign","top"),`欢迎使用 iirose-Forge   version ${en.version}`]],[g("position","absolute"),g("width","100%"),g("top","40px"),g("bottom","40px"),g("overflow","auto"),[f({display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(360px, 1fr))"}),...[...new Date("2023/12/20").getTime()<Date.now()&&Date.now()<new Date("2024/1/16").getTime()||be.local.enableExperimental&&be.local.experimentalOption.annualReport?[{title:"(限时) 蔷薇年报",text:"获取你的2023蔷薇年报",icon:"fire",onClick:async()=>{Ut()}}]:[],{title:"管理插件",text:"管理插件",icon:"puzzle",onClick:async()=>{Te([b.getElement(["[ 添加插件 ]",new p("click",(async()=>{let e=await Se("添加插件","请输入插件地址\n插件会自动进行更新",!0);null!=e&&(await on.addPlug(e,e),on.savePlugList())}))]),...Array.from(on.map.keys()).map((e=>b.getElement([`${e}`,new p("click",(async()=>{Te([b.getElement(["显示插件窗口",new p("click",(()=>{on.showPlugWindow(e)}))]),b.getElement(["移除插件",new p("click",(()=>{on.removePlug(e),on.savePlugList()}))])])}))])))])}},{title:"侧载脚本",text:"管理侧载js",icon:"script",onClick:async()=>{await ke("警告",["! 侧载外部脚本是高危操作 !","侧载的脚本不接受forge权限管理","外部脚本能获取您在此网站的所有信息","恶意外部脚本可能盗取您的账号","请勿加载他人提供的闭源脚本","继续操作前 您应该了解自己正在做什么"].join("\n")),Te([b.getElement(["[ 添加iframe外侧侧载脚本 ]",new p("click",(async()=>{let e=await Se("添加侧载脚本","请输入脚本地址\n每次载入会重新获取脚本\n脚本将随forge启动运行",!0);null!=e&&(be.roaming.sideLoadedScript.push([e,e,!1]),xe(),re("添加侧载脚本","已将脚本添加到侧载列表\n将在下次重启时生效"))}))]),b.getElement(["[ 添加iframe内侧侧载脚本 ]",new p("click",(async()=>{let e=await Se("添加侧载脚本","请输入脚本地址\n每次载入会重新获取脚本\n脚本将随iframe重载运行",!0);null!=e&&(be.roaming.sideLoadedScript.push([e,e,!0]),xe(),re("添加侧载脚本","已将脚本添加到侧载列表\n将在下次重启或iframe重载时生效"))}))]),...be.roaming.sideLoadedScript.map((([e,t,n],i)=>b.getElement([`${n?"内":"外"} | ${e}`,new p("click",(async()=>{Te([b.getElement(["移除插件",new p("click",(()=>{be.roaming.sideLoadedScript.splice(i,1),xe(),re("删除侧载脚本","已将脚本从侧载列表移除\n将在下次重启时生效")}))])])}))])))])}},{title:"插件商店",text:"打开插件商店",icon:"shopping",onClick:async()=>{re("插件商店","forge插件商店还未上线")}},{title:"勿扰模式",text:"设置自动回复",icon:"bell-minus-outline",onClick:async()=>{Te([b.getElement([$t?"关闭勿扰模式":"打开勿扰模式",new p("click",(async()=>{Ft("switch")}))]),b.getElement(["设置勿扰自动回复内容",new p("click",(async()=>{let e=be.roaming.notDisturbModeAutoReply,t=await Se("自定义自动回复","输入开启勿扰模式时私聊的自动回复内容",!0,e);null!=t&&e!=t&&(be.roaming.notDisturbModeAutoReply=t,xe(),Mt=t,re("勿扰模式","已更新免打扰自动回复文本"))}))])])}},{title:"拉取配置",text:"获取您其他在线设备的配置",icon:"sync",onClick:async()=>{!function(){re("配置同步","正在尝试获取配置");let e=K();ce.operation.sendSelfPrivateForgePacket({plug:"forge",type:"syncConfigRQ",id:e}),Qt=e}()}},{title:"美化设置",text:"定制你的界面",icon:"brush-outline",onClick:async()=>{Te([...[{name:"侧边栏顶部图片",key:"sidebarTopPicture",type:"text"},{name:"侧边栏列表背景图片",key:"sidebarListPicture",type:"text"},{name:"选择菜单背景图片",key:"selectMenuBackground",type:"text"},{name:"选择菜单圆角半径",key:"selectMenuBorderRadius",type:"number"},{name:"消息图片圆角半径",key:"messageImgBorderRadius",type:"number"},{name:"消息头像圆角半径",key:"messageAvatarBorderRadius",type:"number"},{name:"系统消息圆角半径",key:"systemMessageBorderRadius",type:"number"},{name:"系统消息图片圆角半径",key:"systemMessageImgBorderRadius",type:"number"},{name:"会话消息圆角半径",key:"sessionMessageBorderRadius",type:"number"},{name:"会话选择项圆角半径",key:"sessionListItemBorderRadius",type:"number"},{name:"面板项圆角半径",key:"panelItemBorderRadius",type:"number"},{name:"提示框背景图片",key:"alertBackground",type:"text"}].map((e=>b.getElement([e.name+(be.roaming.beautify[e.key]?" (已设置)":""),new p("click",(async()=>{let t="number"==e.type?"填写一个数字":"",n=be.roaming.beautify[e.key],i=await Se("美化设置",`设置 ${e.name}${t?"\n"+t:""}`,!0,n||"");if(null!=i)if(""!=i){if("number"==e.type&&!Number.isFinite(Number(i)))return void re("美化设置","设置的值不是一个数字");be.roaming.beautify[e.key]=i,xe()}else delete be.roaming.beautify[e.key],xe()}))])))])}},{title:"附加功能",text:"设置本机的附加功能",icon:"cog",onClick:async()=>{Te([...[{name:"用户备注",storageKey:"enableUserRemark"},{name:"聊天记录同步(测试)",storageKey:"enableSyncChatRecord"},{name:"接管音频(测试)",storageKey:"enableAudioTakeover"},{name:"超级菜单",storageKey:"enableSuperMenu"},...be.local.enableSuperMenu?[{name:"超级菜单设置",func:async()=>{Te([...Jt.map((e=>b.getElement([e.name+(be.local.superMenuOption[e.key]?" (已设置)":""),new p("click",(async()=>{if("boolean"==e.type){let t="true"==be.local.superMenuOption[e.key]?"":"true",n="true"==t?"启用":"禁用";await ke("超级菜单设置",`设置 ${e.name} 为 ${n} ?`,!0)&&(""!=t?(be.local.superMenuOption[e.key]=t,ve()):(delete be.local.superMenuOption[e.key],ve()))}else if(o(e.type,"number","text")){let t="number"==e.type?"填写一个数字":"";null==e.min&&null==e.max&&null==e.default||(""!=t&&(t+="\n"),null!=e.min&&(t+=`最小值 ${e.min} `),null!=e.max&&(t+=`最大值 ${e.max} `),null!=e.default&&(t+=`默认值 ${e.default} `));let n=be.local.superMenuOption[e.key],i=await Se("超级菜单设置",`设置 ${e.name}${t?"\n"+t:""}`,!0,n||"");if(null!=i)if(""!=i){if("number"==e.type){let t=Number(i);if(!Number.isFinite(t))return void re("超级菜单设置","设置的值不是一个数字");if(null!=e.min&&t<e.min||null!=e.max&&t>e.max)return void re("超级菜单设置","设置的值不满足范围要求")}be.local.superMenuOption[e.key]=i,ve()}else delete be.local.superMenuOption[e.key],ve()}}))])))])}}]:[],{name:"快捷房管操作",storageKey:"enableRoomAdminOperation"},{name:"置顶会话",storageKey:"enablePinSession"},...be.local.enableExperimental?[{name:"实验性功能",storageKey:"enableExperimental"},{name:"实验性功能设置",func:async()=>{let e=JSON.stringify(be.local.experimentalOption,void 0,4),t=await async function(e,t,n=!1,i=""){let o=E({tagName:"textarea",style:{resize:"none",height:"24em",width:"19em"}});return o.element.value=i,o.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),setTimeout((()=>o.element.focus()),100),await ke(e,t,n,o)?o.element.value:void 0}("实验性功能设置","设置实验性功能的json",!0,e);if(null!=t&&t!=e)try{be.local.experimentalOption=JSON.parse(t),ve(),re("实验性功能","已更新实验性功能设置")}catch(e){re("实验性功能",`实验性功能设置更新失败\n${e instanceof Error?e.message:""}`)}}}]:[]].map((e=>b.getElement([`${e.storageKey?be.local[e.storageKey]?"(已启用)":"(已禁用)":""}${e.name}`,new p("click",(async()=>{if(e.storageKey){let t=!be.local[e.storageKey];await ke("设置功能",`切换 ${e.name} 功能到 ${t?"启用":"禁用"} 状态\n可能需要重载以生效`,!0)&&(be.local[e.storageKey]=t,ve())}else e.func&&e.func()}))])))])}},{title:"补丁设置",text:"启用或禁用补丁",icon:"bandage",onClick:async()=>{Te([...[{name:"禁用双击全屏",key:"disableDoubleClickFullScreen"},{name:"禁用右侧边缘显示聊天列表",key:"disableRightEdgeTrigger"},{name:"F5键仅刷新iframe内侧",key:"f5RefreshInside"}].map((e=>b.getElement([(be.local.patch[e.key]?" (已启用)":"(已禁用)")+e.name,new p("click",(async()=>{let t=!be.local.patch[e.key];await ke("设置补丁",`切换 ${e.name} 补丁到 ${t?"启用":"禁用"} 状态\n可能需要 重载 或 深度重载(刷新页面) 以生效`,!0)&&(t?be.local.patch[e.key]=t:delete be.local.patch[e.key],ve())}))])))])}},{title:"账号管理",text:"管理你的其他账号",icon:"account-cog",onClick:async()=>{await xt()}},{title:"黑名单",text:"管理黑名单",icon:"account-cancel-outline",onClick:async()=>{await je()}},{title:"安装iiroseForge",text:"下次使用无需注入",icon:"puzzle",onClick:async()=>{localStorage.setItem("installForge","true"),ye(!0),ke("安装iiroseForge","已完成")}},{title:"卸载iiroseForge",text:"下次启动清除iiroseForge",icon:"puzzle",onClick:async()=>{localStorage.removeItem("installForge"),async function(){let e=await caches.open("v"),t=await caches.match("/");if(t){let n=fe(await t.text());await e.put("/",new Response(new Blob([n],{type:"text/html"}),{status:200,statusText:"OK"}))}}(),ke("卸载iiroseForge","已完成")}},{title:"分享forge",text:"复制forge地址",icon:"share-variant",onClick:async()=>{try{await navigator.clipboard.writeText("https://qwq0.github.io/iiroseForge/l.js"),re("分享forge","复制forge地址成功")}catch(e){re("分享forge","复制失败\n无法写入剪切板")}}},{title:"联系作者",text:"向forge作者团队发送私聊",icon:"account-tie",onClick:async()=>{Te([b.getElement(["QwQ～ - 吉祥物 & 主作者",new p("click",(()=>{sn(),W.iframeWindow?.Utils?.service?.offlinePmBuildHelper?.("601c1660aa9cd")}))]),b.getElement(["落零レ - ほら、カレーウドン",new p("click",(()=>{sn(),W.iframeWindow?.Utils?.service?.offlinePmBuildHelper?.("5b17af7a285d7")}))]),b.getElement(["春风萧落 - forge作者团队成员",new p("click",(()=>{sn(),W.iframeWindow?.Utils?.service?.offlinePmBuildHelper?.("5b0fe8a3b1ff2")}))])])}}].map((e=>[Ie("commonBox"),g("maxWidth","calc(100% - 24px)"),g("minWidth","355.2px"),g("minHeight","200px"),g("float","none"),g("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),g("margin","24px 12px 0px 12px"),g("position","relative"),[Ie("commonBoxHead"),g("backgroundColor","rgba(255,255,255,0.2)"),g("color","rgba(0,0,0,0.4)"),g("height","100px"),g("width","100%"),g("display","flex"),g("justifyContent","center"),g("padding","0 24px"),g("boxSizing","border-box"),[Ie("mdi-"+e.icon),g("lineHeight","100px"),g("fontSize","30px"),g("fontFamily","md"),g("display","inline-block"),g("verticalAlign","top"),g("height","100%"),g("opacity","0.7")],[g("lineHeight","100px"),g("fontSize","20px"),g("display","inline-block"),g("verticalAlign","top"),g("height","100%"),g("fontWeight","bold"),g("marginLeft","22px"),g("overflow","hidden"),g("whiteSpace","pre"),g("textOverflow","ellipsis"),e.title]],[Ie("textColor"),g("width","100%"),g("minHeight","100px"),g("backgroundColor","rgba(255,255,255,0.5)"),g("color","rgba(0,0,0,0.75)"),[g("fontWeight","bold"),g("width","100%"),g("height","100%"),g("lineHeight","1.8em"),g("textAlign","center"),g("padding","2.2em"),g("boxSizing","border-box"),g("whiteSpace","pre-wrap"),g("fontSize","16px"),g("color","rgba(0,0,0,0.7)"),e.text]],new p("click",e.onClick)]))],[f({height:"25px"})]],[g("color","#303030"),g("background","#fff"),g("opacity","0.8"),g("display","flex"),g("height","40px"),g("position","absolute"),g("bottom","0"),g("width","100%"),g("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),g("zIndex","2"),...[{text:"< 返回",onClick:()=>{sn()}}].map((e=>[g("width","0"),g("flexGrow","1"),g("justifyContent","center"),g("padding","0 24px"),g("boxSizing","border-box"),new p("click",e.onClick),[],[g("display","inline-block"),g("verticalAlign","top"),g("height","100%"),g("fontWeight","bold"),g("marginLeft","22px"),g("fontSize","14px"),g("lineHeight","40px"),g("overflow","hidden"),g("whiteSpace","pre"),g("textOverflow","ellipsis"),e.text]]))],e=>{const t=["left","leftDown","down","rightUp","right","rightDown","up","leftUp","none"];let n=[],i=0,o=0,r=null,a="none";function s(e){e.pressing?(i=0,o=0,a="none",null==r&&(r=setInterval(l,85))):(i+=e.vx,o+=e.vy),e.hold||null!=r&&(clearInterval(r),r=null)}function l(){let e="none";for((Math.abs(i)>=10||Math.abs(o)>=10)&&(e=t[Math.floor((Math.floor(16*(Math.atan2(-o,i)/(2*Math.PI)+.5))+1)%16/2)]),i=0,o=0,e!=a&&(a=e,"none"!=a&&n.push(a));n.length>200;)n.shift();const r=["down","down","leftDown","right","down"];r.every(((e,t)=>e==n.at(t-r.length)))&&(n=[],be.local.enableExperimental=!0,ve(),re("实验性功能","已激活实验性功能\n部分功能需要重载以启用"))}M(e,s,0,W.iframeWindow),P(e,s,!1),e.addEventListener("mousedown",(e=>{e.stopPropagation()})),e.addEventListener("mouseup",(e=>{e.stopPropagation()})),e.addEventListener("touchstart",(e=>{e.stopPropagation()})),e.addEventListener("touchend",(e=>{e.stopPropagation()})),e.addEventListener("touchmove",(e=>{e.stopPropagation()})),e.addEventListener("touchcancel",(e=>{e.stopPropagation()}))}]);return e.element.id="iiroseForgeMenu",e}let an=null;function sn(){an&&(an.remove(),an=null)}function ln(){let e=W.iframeDocument?.querySelector("div#functionHolder div.functionButton.functionButtonGroup"),t=e?getComputedStyle(e).backgroundColor:"rgb(255, 255, 255)",n=e?getComputedStyle(e).color:"rgb(33, 33, 33)",i=b.getElement([g("backgroundColor",t),g("boxShadow","0 0 1px rgb(0,0,0,0.12),0 1px 1px rgb(0,0,0,0.24)"),g("position","relative"),g("zIndex","1"),g("color",n),g("paddingLeft","16px"),g("paddingRight","56px"),g("transition","background-color 0.1s ease 0s, color 0.1s ease 0s"),g("cursor","url(images/cursor/2.cur), pointer"),g("width","100%"),g("height","56px"),g("boxSizing","border-box"),g("lineHeight","56px"),g("whiteSpace","nowrap"),new p("click",(()=>{W.iframeWindow?.functionHolderDarker?.click(),an&&sn(),an=rn(),W.iframeBody.addChild(an)})),new p("mouseenter",((e,n)=>{"transparent"==n.getStyle("backgroundColor")?(t="transparent",n.setStyle("backgroundColor","rgba(127, 127, 127, 0.3)")):n.setStyle("backgroundColor","#202020"==t||"rgb(32, 32, 32)"==t?"rgb(42, 42, 42)":"rgb(245, 245, 245)"),W.iframeWindow?.Utils?.Sound?.play?.(0)})),new p("mouseleave",((e,n)=>{n.setStyle("backgroundColor",t)})),[new y("span"),new u((e=>e.element.classList.add("functionBtnIcon","mdi-anvil")))],[new y("span"),"Forge菜单",new u((e=>e.element.classList.add("functionBtnFont")))],[new y("span"),g("transform","rotate(-90deg)"),new u((e=>e.element.classList.add("functionBtnGroupIcon")))]]);return i.element.id="iiroseForgeMenuButton",i}function cn(){let e=!1,t=null,i=new Vt,o=new zt,r=new zt,a=new zt;i.addColumn(o),i.addColumn(r),i.addColumn(a),i.setCurrentColumn(1);let s=!1;function l(){{r.clearChild();let e=0,t=0;Array.from(W.iframeDocument.querySelector("div#sessionHolder > div.sessionHolderPmTaskBox")?.children).forEach((i=>{if(i.classList.contains("sessionHolderPmTaskBoxItem")){let o=i.cloneNode(!0);o.classList.remove("whoisTouch2");let a=o.onclick;o.removeAttribute("onclick"),o.removeAttribute("oncontextmenu"),r.addChild(v(o),(()=>{a.call(i,new MouseEvent(""))}));let s=n(i,[-1]);"none"!=s.style.display&&"@"==s.innerText&&(e=t),t++}})),r.currentRowIndex=e}{a.clearChild();let e=[],t=ce.operation.getUserRoomId();e.push({item:_t(t),execute:()=>{}});try{let n=JSON.parse(localStorage.getItem("database"))?.roomHistory?.split?.(",");n&&n.forEach((n=>{n!=t&&e.push({id:n,item:_t(n,"历史"),execute:()=>{ce.operation.switchRoom(n)}})}))}catch(e){console.error("forge supper menu:",e)}Yt(e,a,"right")}o.clearChild(),Yt([{item:Xt("","无动作",""),execute:()=>{}},{id:"信箱",item:Xt("mdi-mailbox","打开信箱",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(2)}},{id:"媒体开关",item:Xt("mdi-music","切换媒体开关",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(90)}},{id:"播放列表",item:Xt("mdi-music-box-multiple","打开播放列表",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(1,W.iframeDocument?.createElement("div"))}},{id:"商店",item:Xt("mdi-store","打开商店",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(10,W.iframeDocument?.createElement("div"))}},{id:"朋友圈",item:Xt("mdi-camera-iris","打开朋友圈",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(5)}},{id:"论坛",item:Xt("mdi-forum","打开论坛",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(3)}},{id:"任务版",item:Xt("mdi-clipboard-check-multiple","打开任务版",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(4)}},{id:"勿扰模式",item:Xt("mdi-bell-minus-outline","切换勿扰模式",""),execute:()=>{Ft("switch")}},{id:"状态",item:Xt("mdi-human","打开状态面板",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(51)}},{id:"终端",item:Xt("mdi-powershell","打开终端",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(21)}},{id:"房间推荐",item:Xt("mdi-fire","打开房间推荐",""),execute:()=>{W.iframeWindow?.functionBtnDo?.(101)}}],o,"left");i.setCurrentColumn(1)}let c=t=>{e&&!s&&i.menuPointerMove(t.movementX,t.movementY)},d=t=>{if(e&&!s)switch(t.code){case"KeyW":t.preventDefault(),t.stopPropagation(),i.menuPointerMove(0,-i.cursorScaleSizeY);break;case"KeyA":t.preventDefault(),t.stopPropagation(),i.menuPointerMove(-i.cursorScaleSizeX,0);break;case"KeyD":t.preventDefault(),t.stopPropagation(),i.menuPointerMove(i.cursorScaleSizeX,0);break;case"KeyS":t.preventDefault(),t.stopPropagation(),i.menuPointerMove(0,i.cursorScaleSizeY);break;case"KeyE":t.preventDefault(),t.stopPropagation(),i.triggerCurrentOptionMenu(),W.iframeWindow.removeEventListener("mousemove",c,!0),W.iframeWindow.removeEventListener("keydown",d,!0),i.hide(),s=!0,e=!1,document.exitPointerLock(),W.iframeDocument.exitPointerLock();break;case"KeyQ":t.preventDefault(),t.stopPropagation(),W.iframeWindow.removeEventListener("mousemove",c,!0),W.iframeWindow.removeEventListener("keydown",d,!0),i.hide(),s=!0,document.exitPointerLock(),W.iframeDocument.exitPointerLock()}};if(W.iframeWindow.addEventListener("mousedown",(n=>{2==n.button&&(e||(t=setTimeout((()=>{e=!0,t=null,l(),i.menuPointerReset(),i.show(),W.iframeWindow.addEventListener("mousemove",c,!0),W.iframeWindow.addEventListener("keydown",d,!0),s=!1,i.menuElement.element.requestPointerLock({unadjustedMovement:!0})}),qt("rightButtonDelay"))))}),!0),W.iframeWindow.addEventListener("keydown",(n=>{"AltRight"==n.code&&qt("rightAltEnable")&&(n.repeat?n.preventDefault():e||(n.preventDefault(),t=setTimeout((()=>{e=!0,t=null,l(),i.menuPointerReset(),i.show(),W.iframeWindow.addEventListener("mousemove",c,!0),W.iframeWindow.addEventListener("keydown",d,!0),s=!1}),1)))}),!0),W.iframeWindow.addEventListener("mouseup",(n=>{2==n.button&&(null!=t&&(clearTimeout(t),t=null),e&&(n.stopPropagation(),n.preventDefault(),s||i.triggerCurrent(),W.iframeWindow.removeEventListener("mousemove",c,!0),W.iframeWindow.removeEventListener("keydown",d,!0),document.exitPointerLock(),W.iframeDocument.exitPointerLock(),setTimeout((()=>{e=!1,i.hide(),document.exitPointerLock(),W.iframeDocument.exitPointerLock()}),10)))}),!0),W.iframeWindow.addEventListener("keyup",(n=>{"AltRight"==n.code&&(null!=t&&(clearTimeout(t),t=null),e&&(n.stopPropagation(),n.preventDefault(),s||i.triggerCurrent(),W.iframeWindow.removeEventListener("mousemove",c,!0),W.iframeWindow.removeEventListener("keydown",d,!0),document.exitPointerLock(),W.iframeDocument.exitPointerLock(),setTimeout((()=>{e=!1,i.hide(),document.exitPointerLock(),W.iframeDocument.exitPointerLock()}),10)))}),!0),W.iframeWindow.addEventListener("contextmenu",(t=>{e&&(t.stopPropagation(),t.preventDefault())}),!0),W.iframeWindow?.isMobile){P(v(W.iframeDocument.body),(t=>{e&&(c({movementX:1.8*t.vx,movementY:1.8*t.vy}),t.hold||setTimeout((()=>{s||i.triggerCurrent(),e=!1,i.hide()}),10))}),!1);let t=W.iframeDocument.getElementById("msgholder");t?.addEventListener("contextmenu",(n=>{let o=n.target;!o.classList.contains("fullBox")&&!o.classList.contains("pubMsgTime")||o!=t&&o.parentElement!=t&&o.parentElement?.parentElement!=t&&o.parentElement?.parentElement?.parentElement!=t||(n.stopImmediatePropagation(),e=!0,l(),i.menuPointerReset(),i.show(),s=!1)}),!0)}}let dn=new TextEncoder;function un(){let t=!1;T(W.iframeBody.element,(e=>{"Shift"==e.key&&(t=e.hold)})),W.iframeWindow.Objs.mapHolder.function.roomchanger=e(W.iframeWindow.Objs.mapHolder.function.roomchanger,(e=>{if(1==e.length&&"string"==typeof e[0]&&(be.local.experimentalOption.ejection||be.local.experimentalOption.ejectionButton&&t)){return mn(e[0]),!0}return!1})),be.local.experimentalOption.ejectionButton&&Me("ejectionButton","roomMenu",(()=>({text:"弹射起步",icon:"ghost-outline"})),(async e=>{mn(e.roomId)})),be.local.experimentalOption.roomQuery&&Me("roomQueryButton","roomMenu",(()=>({text:"房间查询",icon:"account-search"})),(async e=>{let t=e.roomId,n=[],i=ce.operation.getAllOnlineUserInfo();n.push("--- online user ---");let o=0;i.forEach((e=>{e.roomId==t&&n.push(`${o++} - ${e.uid} (${e.name})`)})),n.push(`${o} user in this room.`);let r=n.join("\n");console.log("[iiroseForge] 房间查询\n",r),async function(e,t,n){let i=E({tagName:"textarea",style:{resize:"none",height:"24em",width:"18em"}});i.element.value=n,i.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),i.addEventListener("input",(()=>{i.element.value=n})),setTimeout((()=>i.element.focus()),100),await ke(e,t,!1,i)&&i.element.value}("房间查询","查询结果",r)})),be.local.experimentalOption.withdraw&&function(){if(pn)return;pn=!0,ze.addPath("v0#",(e=>{let t=e.split('"');try{let e=W.iframeDocument.querySelector(`div#msgholder div.fullBox[index="0"] div[data-id="${t[0]}"]`);n(e,[0,0,0])?.appendChild(b.getElement([f({backgroundColor:k.rgb(100,100,100,.6),color:k.rgb(255,255,255,.9),borderRadius:"3px",position:"absolute",padding:"0.2em",bottom:"-0.7em",["right"!=e.style.float?"right":"left"]:"-1.7em"}),"已撤回"]).element)}catch(e){console.error(e)}return!0})),ze.addPath("v0*",(e=>{let t=e.split('"');try{let e=W.iframeDocument.querySelector(`div#msgholder div.fullBox[ip="${t[0]}"] div[data-id="${t[1]}"]`);n(e,[1,0])?.appendChild(b.getElement([f({backgroundColor:k.rgb(100,100,100,.6),color:k.rgb(255,255,255,.9),borderRadius:"3px",position:"absolute",padding:"0.2em",bottom:"-0.7em",["right"!=e.style.float?"right":"left"]:"-1.7em"}),"已撤回"]).element)}catch(e){console.error(e)}return!0}))}(),be.local.experimentalOption.interceptState&&function(){if(hn)return;hn=!0,Ue.addPath("s",((e,t)=>{var n;"s"==t&&(n="",Ve[0]=n)}))}()}function mn(e){W.socket?._send(dn.encode("m"+e)),W.socket.onclose=()=>{},W.socket?.close(),setTimeout((()=>{W.iframeWindow?.sessionStorage?.setItem?.("lastroom",""),W.iframeWindow?.sessionStorage?.setItem?.("autologin","1"),W.iframeWindow?.Cookie?.("roomsave",e),W.iframeWindow?.location?.reload?.()}),7e3),re("实验性功能","少女祈祷中..."),setTimeout((()=>{re("实验性功能","马上就好了~")}),3500)}let pn=!1;let hn=!1;let gn=!1,fn=!1;function yn(){gn=!1,fn=!1;let e=ce.operation.getUserName(),t=ce.operation.getRoomInfoById(ce.operation.getUserRoomId());t&&(e==t.ownerName?(gn=!0,fn=!0):t.member.some((t=>{t.name!=e||"admin"!=t.auth&&"member"!=t.auth||(gn=!0,"admin"==t.auth&&(fn=!0))}))),Me("roomAdminOperation","roomMessageMenu",(()=>gn?{icon:"wrench",text:"房管操作"}:null),(e=>{Te([...fn?[b.getElement(["白名单",new p("click",(async()=>{let t=await Se("房管操作",`设置用户(${e.userName})\n的白名单时间\nd天 h时 m分 s秒 &永久`,!0,"&");if(null==t)return;let n=await Se("房管操作",`设置用户(${e.userName})\n的白名单备注`,!0,"");null!=n&&W.socketApi.send(`!hw${JSON.stringify(["4",e.userName.toLowerCase(),t,n])}`)}))]),b.getElement(["黑名单",new p("click",(async()=>{let t=await Se("房管操作",`设置用户(${e.userName})\n的黑名单时间\nd天 h时 m分 s秒 &永久`,!0,"30d");if(null==t)return;let n=await Se("房管操作",`设置用户(${e.userName})\n的黑名单备注`,!0,"");null!=n&&W.socketApi.send(`!h4${JSON.stringify(["4",e.userName.toLowerCase(),t,n])}`)}))]),b.getElement(["永久黑名单",new p("click",(async()=>{let t=await Se("房管操作",`设置用户(${e.userName})\n的永久黑名单备注`,!0,"");null!=t&&W.socketApi.send(`!h4${JSON.stringify(["4",e.userName.toLowerCase(),"&",t])}`)}))])]:[],b.getElement(["移出房间",new p("click",(async()=>{await ke("房管操作",`是否将用户(${e.userName})\n移出房间`)&&W.socketApi.send(`!#${JSON.stringify([e.userName.toLowerCase()])}`)}))])])}))}let bn=!1;function wn(){let t=null,n=j({text:""}),i=null;function o(e){return e&&""!=e.src&&!e.paused&&e.volume>0}let r=!1,a=!1,s=W.iframeWindow?.shareMediaObj,l=W.iframeWindow?.shareMediaObjAudio,c=W.iframeWindow?.radioPlayer,d=W.iframeWindow?.playerSoundOff,u=W.iframeWindow?.infosound;function m(){"roomMedia"==i?.type&&o(u)?(n.text="转回房间音频",h()):"infoMedia"!=i?.type||i.src==u.src&&o(u)?g():(n.text="转到资料音频",h())}function h(){if(t)return void t.setDisplay("block");bn||(re("接管音频","您正在使用forge测试功能(接管音频)\n如果存在问题请在 附加功能 中关闭"),bn=!0);let e=0,o=0,s=!1;t=b.getElement([f({position:"fixed",overflow:"hidden",border:"1px white solid",backgroundColor:"rgba(30, 30, 30, 0.55)",backdropFilter:"blur(2px)",color:"rgba(255, 255, 255)",alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"1.1em",boxSizing:"border-box",padding:"1px",borderRadius:"2.5px",zIndex:"90000001",height:"50px",minWidth:"50px"}),[f({display:"flex",height:"100%",paddingLeft:"1em",paddingRight:"1em",justifyContent:"center",alignItems:"center"}),D(n,"text"),new p("mousedown",(e=>e.preventDefault())),new p("mouseup",(e=>e.preventDefault())),new p("click",(()=>{s?"roomMedia"==i?.type?(u.setAttribute("src",""),d(1),a&&(a=!1),g()):"infoMedia"==i?.type&&(h(),u.src=i?.src,u.play(),r&&(d(),r=!1),a&&(u.play(),a=!1),g()):s=!1}))],n=>{let i=0,r=0,a=0,l=!1,c=n=>{let c=Date.now();if(n.pressing&&(a=c,l=!0,s=!1),(Math.abs(n.x-n.sx)>10||Math.abs(n.y-n.sy)>10)&&(l=!1),!n.hold&&l&&c-a<150){let e=W.iframeDocument.elementFromPoint(n.sx,n.sy);e==W.iframeDocument.elementFromPoint(n.x,n.y)&&(s=!0,e.dispatchEvent(new MouseEvent("click")))}n.pressing&&(i=e,r=o),e=i+n.x-n.sx,o=r+n.y-n.sy,e<0?e=0:e>=ne.element.clientWidth-t.element.offsetWidth&&(e=ne.element.clientWidth-t.element.offsetWidth),o<0?o=0:o>=ne.element.clientHeight-t.element.offsetHeight&&(o=ne.element.clientHeight-t.element.offsetHeight),t.setStyle("left",`${e}px`),t.setStyle("top",`${o}px`)};n.addEventListener("mousedown",(e=>e.preventDefault()),!0),n.addEventListener("mouseup",(e=>e.preventDefault()),!0),M(n,c,0,W.iframeWindow),P(n,c),n.addEventListener("mousedown",(e=>e.stopPropagation())),n.addEventListener("mouseup",(e=>e.stopPropagation())),n.addEventListener("touchstart",(e=>e.stopPropagation())),n.addEventListener("touchend",(e=>e.stopPropagation())),n.addEventListener("touchcancel",(e=>e.stopPropagation()))}]),W.iframeBody.addChild(t)}function g(){t&&t.setDisplay("none")}s&&l&&c&&d&&u&&(u.removeAttribute("loop"),u.removeAttribute("autoplay"),W.iframeWindow.infosound=new Proxy(u,{get:(e,t)=>{let n=u[t];switch(t){case"play":return()=>{u.play()};case"pause":return()=>{u.pause()};case"":return"infoMedia"==i?.type?i.src:"";case"getAttribute":return e=>"src"==e?"infoMedia"==i?.type?i.src:"":u.getAttribute(e);case"setAttribute":return(e,t)=>{"src"==e?""==t?(a=!0,i={type:"roomMedia"},m()):i={type:"infoMedia",src:t}:u.setAttribute(e,t)}}return"function"==typeof n?n.bind(u):n},set:(e,t,n)=>{switch(t){case"src":i={type:"infoMedia",src:n},u.src==n||(a||r&&o(l)?setTimeout((()=>{m()}),10):(u.src=n,u.play(),r&&(d(),r=!1),a&&(u.play(),a=!1)));break;case"currentTime":a||(u.currentTime=n);break;default:u[t]=n}return!0}}),W.iframeWindow.playerSoundOff=e(d,(e=>(setTimeout((()=>{m()}),10),null==e[0]&&o(l)?(r=!0,!0):!(1!=e[0]||(i={type:"roomMedia"},!o(u)))||(r=!1,!1)))))}let xn=!1,vn=null;function kn(){Me("pinSession","sessionMenu",(e=>be.processed.pinSessionSet.has(e.uid)?{icon:"pin-off",text:"取消置顶"}:{icon:"pin",text:"置顶会话"}),(e=>{be.processed.pinSessionSet.has(e.uid)?(be.processed.pinSessionSet.delete(e.uid),re("置顶会话","已取消置顶会话")):(be.processed.pinSessionSet.add(e.uid),re("置顶会话","已置顶会话")),xe(),function(){xn||Sn();vn()}()})),xn=!1,vn=null,be.processed.pinSessionSet.size>0&&Sn()}function Sn(){if(xn)return;xn=!0;let e=W.iframeDocument.getElementsByClassName("sessionHolderPmTaskBox")[0],t=e.children[1],n=b.getElement([Ie("sessionHolderSpliter"),"置顶会话"]).element;e.children[0].after(n),vn=()=>{t.parentElement||n.after(t),Array.from(e.children).reverse().forEach((i=>{if(2==i.classList.length&&i.classList.contains("sessionHolderPmTaskBoxItem")&&i.classList.contains("whoisTouch2")&&i!=e.children[0]){let e=i.getAttribute("ip"),o=be.processed.pinSessionSet.has(e),r=t.compareDocumentPosition(i);2&r&&!o?t.after(i):4&r&&o&&n.after(i)}}))},vn();{let e=document.createElement("div");e.style.display="none",t.after(e)}new MutationObserver((e=>{for(let i of e)if("childList"==i.type&&(Array.from(i.addedNodes).forEach((e=>{if(null!=e.classList&&e.classList.contains("sessionHolderPmTaskBoxItem")&&2==e.classList.length&&e.classList.contains("sessionHolderPmTaskBoxItem")&&e.classList.contains("whoisTouch2")){let i=e.getAttribute("ip"),o=be.processed.pinSessionSet.has(i);2&t.compareDocumentPosition(e)&&!o?t.after(e):4&t.compareDocumentPosition(e)&&o&&n.after(e)}})),!(t.parentElement&&t.nextElementSibling||(t.parentElement||(n.after(t),vn()),t.nextSibling)))){let e=document.createElement("div");e.style.display="none",t.after(e)}})).observe(e,{attributes:!1,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0})}function In(){t((()=>{let t=document.getElementById("mainFrame"),n=t.contentWindow,i=t.contentDocument;if(W.iframeDocument=i,W.iframeWindow=n,W.iframeBody=v(i.body),!n.iiroseForgeInjected){if(null!=n.socket.__onmessage||null==n.socket._onmessage||null==n.socket._send)throw"main iframe is not ready";(()=>{let e=v(i.getElementById("functionHolder").childNodes[0]),t=ln();e.insChild(t,1)})(),W.socket=n.socket,W.socket._onmessage=e(W.socket._onmessage.bind(W.socket),(e=>{de.debugMode&&console.log("receive packet",e);try{if(Ve=t=e,ze.matchPrefix(t[0]))return!0}catch(e){return console.error("[iiroseForge]",e),!1}var t;return!1})),W.socketApi.send=W.socket.send.bind(W.socket),W.socket.send=e(W.socketApi.send,(e=>{de.debugMode&&console.log("send packet",e);try{if(Ve=t=e,Ue.matchPrefix(t[0]))return!0}catch(e){return console.error("[iiroseForge]",e),!1}var t;return!1})),n.iiroseForgeInjected=!0,console.log("[iiroseForge] 成功将iiroseForge注入iframe"),n.iiroseForgeApi=ce,de.debugMode&&me(de.debugMode),(async()=>{let e=0;be.roaming.sideLoadedScript.forEach((([t,n,o])=>{if(o){let t=document.createElement("script");t.src=n,i.body.appendChild(t),e++}})),e>0&&re("iiroseForge plug-in",`已在iframe内侧侧载 ${e} 个js脚本`)})(),[{func:Zt},{func:Wt},{func:Et},{func:st},{func:Je},{func:Tt},{func:Be,condition:"enableUserRemark"},{func:yn,condition:"enableRoomAdminOperation"},{func:wn,condition:"enableAudioTakeover"},{func:Rt,condition:"enableSyncChatRecord"},{func:cn,condition:"enableSuperMenu"},{func:un,condition:"enableExperimental"},{func:Re},{func:kn,condition:"enablePinSession"}].forEach((e=>{try{e.condition&&!be.local[e.condition]||e.func()}catch(e){console.error("patch error:",e)}}))}}),1e3),"true"==localStorage.getItem("installForge")&&t((()=>{let e=document.getElementById("mainFrame").contentWindow;if(e.iiroseForgeClearCacheInjected)return;if(!e.Utils?.service?.clearCache)throw"Incomplete load";let t=e.Utils.service.clearCache.bind(e.Utils.service);e.Utils.service.clearCache=(...n)=>{let i=e.parent.location._reload.bind(e.parent.location);e.location._reload=e.parent.location._reload=(...e)=>{setTimeout((async()=>{await ye(!1),setTimeout((()=>{i(...e)}),5)}),100)},t(...n)},e.iiroseForgeClearCacheInjected=!0}),5)}if("iirose.com"==location.host)if("/"==location.pathname)if(window.iiroseForgeInjected)console.log("[iiroseForge] 已阻止重复注入");else{window.iiroseForgeInjected=!0,console.log("[iiroseForge] iiroseForge已启用"),window.enableForgeDebugMode=me,"true"==sessionStorage.getItem("iiroseForgeDebugMode")&&me(!0),function(){try{let e=localStorage.getItem("iiroseForge");we(e?JSON.parse(e):{})}catch(e){re("错误","无法读入储存 这可能导致iiroseForge配置丢失")}}(),function(){try{let e=localStorage.getItem("iiroseForgeLocal"),t=e?JSON.parse(e):{};Object.keys(t).forEach((e=>{be.local[e]=t[e]}))}catch(e){re("错误","无法读入本地储存 这可能导致iiroseForge配置丢失")}}(),on.readPlugList();let e=document.getElementById("mainFrame");e.addEventListener("load",(()=>{console.log("[iiroseForge] 已重载 正在将iiroseForge注入iframe"),In()})),console.log("[iiroseForge] 正在将iiroseForge注入iframe"),In(),window.addEventListener("beforeunload",(()=>{be.local.lastCloseTime=Date.now(),ve()}));let t=0,n=!1;setInterval((()=>{0==e.contentWindow?.socket?.readyState?t>=2?n||(n=!0,re("无法连接",["检测到连接到iirose服务器的速度过慢",`正在连接: ${e.contentWindow?.socket?.url}`,"可能是当前尝试连接的服务器出现了问题","点击以尝试连接其他候选服务器"].join("\n"),void 0,(()=>{if(t=0,n=!1,0==e.contentWindow?.socket?.readyState){try{e.contentWindow?.socket?.close()}catch(e){}try{e.contentWindow?.socket?.onerror()}catch(e){}}}))):t++:(t=0,n=!1)}),3e3),(async()=>{let e=0;be.roaming.sideLoadedScript.forEach((([t,n,i])=>{if(!i){let t=document.createElement("script");t.src=n,window.document.body.appendChild(t),e++}})),e>0&&re("iiroseForge plug-in",`已在iframe外部侧载 ${e} 个js脚本`)})()}else if("/messages.html"==location.pathname){if(console.log("[iiroseForge] iiroseForge需要注入至主上下文中"),"iirose.com"==parent?.location?.host&&"/"==parent?.location?.pathname){let e=parent.document,t=e.createElement("script");t.text=pe,e.body.appendChild(t),console.log("[iiroseForge] 修正注入")}}else console.log("[iiroseForge] 已阻止注入 iiroseForge需要注入至根页面的主上下文中");else console.log("[iiroseForge] 已阻止注入 iiroseForge仅支持蔷薇花园(iirose.com)")}();
